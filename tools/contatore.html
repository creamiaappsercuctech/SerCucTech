<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>SerCucTech ‚Äî Contatore manuale oggetti su foto</title>
  <style>
    :root{
      --bg:#0b1220; --panel:rgba(255,255,255,.06); --panel2:rgba(255,255,255,.10);
      --txt:#eaf0ff; --muted:rgba(234,240,255,.72); --line:rgba(255,255,255,.12);
      --ok:#25D366; --warn:#ffb020; --bad:#ff4d4d; --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1100px 700px at 30% -20%, rgba(130,170,255,.25), transparent 60%),
        radial-gradient(1000px 700px at 90% 20%, rgba(120,255,210,.10), transparent 60%),
        var(--bg);
      color:var(--txt);
    }
    header{
      position:sticky; top:0; z-index:50;
      padding:12px 12px;
      background: rgba(0,0,0,.28);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .title{font-weight:950; letter-spacing:.2px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      font-weight:900; font-size:12px;
      color: var(--muted);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:12px}
    .grid{display:grid; gap:12px; grid-template-columns: 1fr;}
    @media(min-width:980px){ .grid{grid-template-columns: 1.35fr .65fr;} }
    .card{
      border:1px solid var(--line);
      background: var(--panel);
      border-radius: var(--r);
      overflow:hidden;
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
    }
    .card h2{
      margin:0; padding:12px 14px;
      font-size:15px;
      background: var(--panel2);
      border-bottom:1px solid var(--line);
    }
    .card .content{ padding:12px 14px; }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color:var(--txt);
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .btn:active{transform:scale(.99)}
    .btn.ok{background:rgba(37,211,102,.16); border-color:rgba(37,211,102,.35)}
    .btn.warn{background:rgba(255,176,32,.14); border-color:rgba(255,176,32,.30)}
    .btn.bad{background:rgba(255,77,77,.14); border-color:rgba(255,77,77,.30)}
    .small{font-size:12px; color:var(--muted); font-weight:800}
    .hint{color:var(--muted); font-weight:800; font-size:12px; line-height:1.35}
    textarea{
      width:100%;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      color:var(--txt);
      border-radius:14px;
      padding:10px 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-weight:700;
      min-height:150px;
      resize:vertical;
      outline:none;
    }

    /* Stage */
    .stage{
      position:relative;
      width:100%;
      border-radius: 18px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.20);
      overflow:hidden;
      min-height: 320px;
      display:grid;
      place-items:center;
      touch-action: none; /* drag su mobile */
    }
    #photo{
      max-width:100%;
      max-height: 78vh;
      display:none;
      user-select:none;
      -webkit-user-drag:none;
    }

    /* Pin */
    .pin{
      position:absolute;
      transform: translate(-50%,-50%);
      width:34px; height:34px;
      border-radius:999px;
      background: rgba(0,0,0,.74);
      border:2px solid rgba(255,255,255,.9);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      z-index:30;
      user-select:none;
      cursor:grab;
    }
    .pin:active{ cursor:grabbing; }
    .pin.selected{
      outline: 3px solid rgba(130,170,255,.55);
      box-shadow: 0 12px 24px rgba(0,0,0,.35);
    }
  </style>
</head>
<body>
<header>
  <div class="title">SerCucTech ‚Ä¢ Contatore manuale oggetti su foto</div>
  <div class="pill" id="status">Carica una foto</div>
</header>

<div class="wrap">
  <div class="grid">

    <!-- LEFT -->
    <section class="card">
      <h2>1) Foto + numeri</h2>
      <div class="content">
        <div class="row">
          <label class="btn">
            üì∑ Carica JPG/PNG
            <input id="fileInput" type="file" accept="image/*" style="display:none">
          </label>

          <button class="btn warn" id="btnUndo" type="button">‚Ü©Ô∏è Undo</button>
          <button class="btn" id="btnRenumber" type="button">üî¢ Rinumera</button>
          <button class="btn bad" id="btnClear" type="button">üßπ Svuota</button>

          <span class="pill" id="count">0</span>
        </div>

        <div class="hint" style="margin:10px 0">
          ‚Ä¢ Tocca la foto sull‚Äôoggetto ‚Üí crea numero (1,2,3‚Ä¶).<br>
          ‚Ä¢ Trascina il numero per posizionarlo.<br>
          ‚Ä¢ <b>Doppio tap</b> su un numero = cancella.<br>
        </div>

        <div class="stage" id="stage">
          <img id="photo" alt="">
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="card">
      <h2>2) Export JSON</h2>
      <div class="content">
        <div class="row">
          <button class="btn ok" id="btnExport" type="button">‚¨áÔ∏è Export pins</button>
          <button class="btn" id="btnCopy" type="button">üìã Copia</button>
        </div>

        <div class="hint" style="margin:10px 0">
          Output compatibile vetrina: <code>[{"n":1,"x":12.3,"y":45.6},...]</code><br>
          x,y sono percentuali (0‚Äì100) relative all‚Äôimmagine.
        </div>

        <textarea id="out" placeholder="Qui appare il JSON‚Ä¶"></textarea>
      </div>
    </section>

  </div>
</div>

<script>
/* ===================== STATE ===================== */
const statusEl = document.getElementById("status");
const fileInput = document.getElementById("fileInput");
const stage = document.getElementById("stage");
const photo = document.getElementById("photo");

const btnUndo = document.getElementById("btnUndo");
const btnRenumber = document.getElementById("btnRenumber");
const btnClear = document.getElementById("btnClear");
const btnExport = document.getElementById("btnExport");
const btnCopy = document.getElementById("btnCopy");

const countEl = document.getElementById("count");
const outEl = document.getElementById("out");

let pins = []; // {id,n,x,y} x/y in %
let selectedId = null;
let lastTap = { id:null, t:0 };

function uid(){
  return "p_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
}
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
function round1(n){ return Math.round(n*10)/10; }

function setStatus(t){ statusEl.textContent = t; }

function updateCount(){
  countEl.textContent = `${pins.length} numeri`;
}

function imageRect(){
  // bounding rect dell'immagine mostrata (non dello stage)
  return photo.getBoundingClientRect();
}
function stageRect(){
  return stage.getBoundingClientRect();
}

function clientToPercent(clientX, clientY){
  const r = imageRect();
  const x = ((clientX - r.left) / r.width) * 100;
  const y = ((clientY - r.top) / r.height) * 100;
  return { x: round1(clamp(x,0,100)), y: round1(clamp(y,0,100)) };
}

function percentToStagePx(xPct, yPct){
  const imgR = imageRect();
  const stR = stageRect();
  const x = (imgR.left - stR.left) + (xPct/100) * imgR.width;
  const y = (imgR.top  - stR.top ) + (yPct/100) * imgR.height;
  return { x, y };
}

function nextNumber(){
  const max = pins.reduce((m,p)=>Math.max(m, p.n||0), 0);
  return max + 1;
}

/* ===================== RENDER ===================== */
function clearPinEls(){
  stage.querySelectorAll(".pin").forEach(el=>el.remove());
}

function renderPins(){
  clearPinEls();
  pins.forEach(p=>{
    const el = document.createElement("div");
    el.className = "pin" + (p.id===selectedId ? " selected" : "");
    el.dataset.id = p.id;
    el.textContent = p.n;

    const pos = percentToStagePx(p.x, p.y);
    el.style.left = pos.x + "px";
    el.style.top  = pos.y + "px";

    // select + double tap delete
    el.addEventListener("pointerdown", (e)=>{
      e.stopPropagation();
      selectPin(p.id);

      const now = Date.now();
      if(lastTap.id === p.id && (now - lastTap.t) < 350){
        // double tap -> delete
        deletePin(p.id);
        lastTap = { id:null, t:0 };
        return;
      }
      lastTap = { id:p.id, t:now };
    });

    makeDraggable(el);
    stage.appendChild(el);
  });

  updateCount();
}

/* ===================== SELECT / DELETE ===================== */
function selectPin(id){
  selectedId = id;
  renderPins();
}

function deletePin(id){
  pins = pins.filter(p=>p.id!==id);
  if(selectedId===id) selectedId=null;
  renderPins();
}

/* ===================== DRAG ===================== */
function makeDraggable(el){
  let dragging = false;
  let pid = null;

  el.addEventListener("pointerdown", (e)=>{
    e.preventDefault();
    e.stopPropagation();
    dragging = true;
    pid = e.pointerId;
    el.setPointerCapture?.(pid);
  });

  el.addEventListener("pointermove", (e)=>{
    if(!dragging || e.pointerId!==pid) return;
    const imgR = imageRect();
    // se trascini fuori dall‚Äôimmagine, clamp
    const {x,y} = clientToPercent(
      clamp(e.clientX, imgR.left, imgR.right),
      clamp(e.clientY, imgR.top,  imgR.bottom)
    );
    const id = el.dataset.id;
    const p = pins.find(pp=>pp.id===id);
    if(!p) return;
    p.x = x; p.y = y;
    const pos = percentToStagePx(x,y);
    el.style.left = pos.x + "px";
    el.style.top  = pos.y + "px";
  });

  const end = (e)=>{
    if(e.pointerId!==pid) return;
    dragging = false;
    pid = null;
    renderPins();
  };

  el.addEventListener("pointerup", end);
  el.addEventListener("pointercancel", end);
}

/* ===================== ADD PIN ON TAP ===================== */
stage.addEventListener("click", (e)=>{
  if(photo.style.display==="none") return;
  // se tocchi un pin, non creare
  if(e.target.classList.contains("pin")) return;

  const imgR = imageRect();
  // se clicchi fuori dall'immagine, ignoriamo
  if(e.clientX < imgR.left || e.clientX > imgR.right || e.clientY < imgR.top || e.clientY > imgR.bottom){
    return;
  }

  const {x,y} = clientToPercent(e.clientX, e.clientY);
  const p = { id: uid(), n: nextNumber(), x, y };
  pins.push(p);
  selectedId = p.id;
  renderPins();
});

/* ===================== LOAD IMAGE ===================== */
fileInput.addEventListener("change", (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  const url = URL.createObjectURL(f);
  photo.src = url;
  photo.style.display = "block";
  photo.onload = ()=>{
    pins = [];
    selectedId = null;
    outEl.value = "";
    setStatus("Foto pronta: tocca sugli oggetti per numerare");
    renderPins();
  };
});

/* ===================== BUTTONS ===================== */
btnUndo.addEventListener("click", ()=>{
  if(!pins.length) return;
  const last = pins[pins.length-1];
  pins.pop();
  if(selectedId===last.id) selectedId=null;
  renderPins();
});

btnRenumber.addEventListener("click", ()=>{
  // mantiene l'ordine di creazione: rinumera 1..N
  pins.forEach((p,i)=> p.n = i+1);
  renderPins();
});

btnClear.addEventListener("click", ()=>{
  if(!confirm("Vuoi eliminare tutti i numeri?")) return;
  pins = [];
  selectedId = null;
  outEl.value = "";
  renderPins();
});

btnExport.addEventListener("click", ()=>{
  const exp = pins.map(p=>({ n:p.n, x:p.x, y:p.y }));
  outEl.value = JSON.stringify(exp, null, 2);
});

btnCopy.addEventListener("click", async ()=>{
  const txt = (outEl.value||"").trim();
  if(!txt){ alert("Prima fai Export."); return; }
  try{
    await navigator.clipboard.writeText(txt);
    alert("Copiato!");
  }catch(e){
    alert("Copia non riuscita: seleziona e copia manualmente.");
  }
});

/* rerender on resize (immagine cambia dimensione) */
window.addEventListener("resize", ()=>renderPins());

updateCount();
</script>
</body>
</html>
