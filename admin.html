<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin SerCucTech</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="wrap">

<div class="card" id="login">
  <h3>Accesso Admin</h3>
  <input id="pin" type="password" placeholder="PIN">
  <button onclick="doLogin()">Entra</button>
  <div class="small">PIN default: <b>1234</b></div>
</div>

<div id="panel" class="hidden">

<div class="card">
  <h3>Nuova / Modifica Vetrina</h3>

  <input id="vid" placeholder="ID vetrina (es: negozio1)">
  <input id="title" placeholder="Titolo">
  <textarea id="desc" placeholder="Descrizione"></textarea>

  <div class="small">Font e dimensioni</div>
  <select id="fontFamily">
    <option value="system-ui">System</option>
    <option value="Arial, sans-serif">Arial</option>
    <option value="'Times New Roman', serif">Times</option>
    <option value="Georgia, serif">Georgia</option>
    <option value="'Courier New', monospace">Courier</option>
  </select>

  <input type="number" id="baseFontSize" value="16" placeholder="Dimensione testo base (px)">
  <input type="number" id="titleSize" value="32" placeholder="Dimensione titolo (px)">

  <label>Colore titolo</label>
  <input type="color" id="titleColor" value="#ffffff">
  <label>Colore sfondo</label>
  <input type="color" id="bgColor" value="#0b1020">

  <div class="small">Presentazione (testo e voce)</div>
  <textarea id="presentationText" placeholder="Scrivi qui la presentazione da leggere a voce..."></textarea>
  <select id="voiceLang">
    <option value="it-IT">Italiano (it-IT)</option>
    <option value="uk-UA">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ (uk-UA)</option>
    <option value="en-US">English (en-US)</option>
    <option value="ja-JP">Êó•Êú¨Ë™û (ja-JP)</option>
  </select>
  <input type="number" id="voiceRate" value="1" step="0.1" placeholder="Velocit√† voce (1 = normale)">
  <button onclick="testVoice()">‚ñ∂ Test voce</button>

  <div class="small">File (immagini / video) ‚Äì seleziona pi√π file</div>
  <input type="file" id="files" multiple accept="image/*,video/*">
  <button onclick="upload()">Carica file</button>
  <div id="fileList"></div>

  <button onclick="save()">Salva vetrina</button>
</div>

<div class="card">
  <h3>Vetrine create</h3>
  <div id="list"></div>
</div>

<div class="card">
  <h3>Pubblicazione (per WhatsApp + link pubblico)</h3>
  <button onclick="exportJson()">‚¨á Esporta JSON</button>
  <button onclick="openGitHubData()">üìÇ Apri cartella /data su GitHub</button>
  <button onclick="openGitHubNewFile()">‚ûï Crea cartella /data (se manca)</button>
  <div class="small" id="publishHelp"></div>
</div>

</div>
</div>

<script src="app.js"></script>
<script>
initPin();

const publishHelp = document.getElementById("publishHelp");

let uploaded = [];
let repoBase = location.origin + location.pathname.replace("admin.html",""); // base Pages

function doLogin() {
  if (pin.value === getPin()) {
    login.style.display = "none";
    panel.classList.remove("hidden");
    renderList();
  } else alert("PIN errato");
}

async function upload() {
  for (const f of files.files) {
    const data = await toBase64(f);
    uploaded.push({ name:f.name, type:f.type, data });
  }
  renderFiles();
}

function renderFiles() {
  fileList.innerHTML = uploaded.map((f,i)=>`
    <div class="card" style="background:#0b1224">
      <b>${f.name}</b>
      <div class="small">${f.type}</div>
      <button style="background:#dc2626" onclick="delFile(${i})">Elimina file</button>
    </div>
  `).join("");
}

function delFile(i){ uploaded.splice(i,1); renderFiles(); }

function buildVetrinaObject(){
  return {
    title: title.value || vid.value,
    desc: desc.value || "",
    fontFamily: fontFamily.value || "system-ui",
    baseFontSize: Number(baseFontSize.value || 16),
    titleSize: Number(titleSize.value || 32),
    titleColor: titleColor.value || "#ffffff",
    bgColor: bgColor.value || "#0b1020",
    presentationText: presentationText.value || "",
    voice: {
      lang: voiceLang.value || "it-IT",
      rate: Number(voiceRate.value || 1),
      pitch: 1,
      volume: 1
    },
    files: uploaded
  };
}

function save() {
  const id = (vid.value||"").trim();
  if(!id) return alert("ID obbligatorio");
  const all = loadAll();
  all[id] = buildVetrinaObject();
  saveAll(all);
  alert("Salvato ‚úÖ");
  renderList();
}

async function checkPublished(id){
  // Controllo automatico: esiste /data/ID.json?
  try{
    const r = await fetch(`data/${encodeURIComponent(id)}.json`, {cache:"no-store"});
    return r.ok;
  }catch(e){
    return false;
  }
}

function shareLink(id){
  return `${repoBase}vetrina.html?id=${encodeURIComponent(id)}`;
}

async function renderList(){
  const all = loadAll();
  const ids = Object.keys(all);

  list.innerHTML = ids.length ? "" : `<div class="small">Nessuna vetrina creata.</div>`;

  for(const id of ids){
    const publicLink = shareLink(id);
    const published = await checkPublished(id);

    const badge = published
      ? `<span class="pill">PUBBLICATA ‚úÖ</span>`
      : `<span class="pill" style="background:#3b1d1d">NON PUBBLICATA ‚ùå</span>`;

    const div = document.createElement("div");
    div.className="card";
    div.innerHTML = `
      <b>${id}</b> ${badge}<br>
      <div class="small">${all[id].desc||""}</div>
      <div class="small">Link da condividere:</div>
      <a href="${publicLink}" target="_blank">${publicLink}</a>
      <button onclick="copyLink('${publicLink.replaceAll("'","%27")}')">Copia link</button>
      ${published ? "" : `<div class="small" style="margin-top:8px">‚ö† Per WhatsApp: esporta JSON e carica in <b>/data/${id}.json</b></div>`}
    `;
    list.appendChild(div);
  }

  publishHelp.innerHTML = `
    <div>‚úÖ Per renderla visibile a TUTTI:</div>
    <div class="small">1) Esporta JSON ‚Üí ottieni <b>ID.json</b></div>
    <div class="small">2) Caricalo su GitHub in <b>/data/ID.json</b></div>
    <div class="small">3) (Per anteprima WhatsApp) carica anche una cover: <b>/data/ID-cover.jpg</b></div>
  `;
}

function copyLink(u){
  const link = decodeURIComponent(u);
  navigator.clipboard?.writeText(link).then(
    ()=>alert("Link copiato ‚úÖ"),
    ()=>prompt("Copia manualmente:", link)
  );
}

function exportJson(){
  const id = (vid.value||"").trim();
  if(!id) return alert("Scrivi prima l‚ÄôID della vetrina");
  const all = loadAll();
  const v = all[id];
  if(!v) return alert("Vetrina non trovata in locale");

  const blob = new Blob([JSON.stringify(v,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `${id}.json`;
  a.click();

  alert(`Ora carica il file in GitHub in: data/${id}.json`);
}

function openGitHubData(){
  alert("Apri la repo su GitHub ‚Üí entra nella cartella 'data' e carica l√¨ il file JSON.");
  // Non possiamo sapere l‚ÄôURL esatto GitHub repo dal pages, quindi ti guido con istruzione.
}

function openGitHubNewFile(){
  alert("Se non esiste la cartella 'data': su GitHub crea una cartella chiamata esattamente 'data' (minuscolo).");
}

function testVoice(){
  const ok = speakText(presentationText.value, {lang: voiceLang.value, rate: voiceRate.value});
  if(!ok) alert("Sintesi vocale non disponibile su questo browser.");
}
</script>

</body>
</html>
