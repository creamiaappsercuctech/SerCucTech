<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SerCucTech - Admin</title>
  <script src="./guide.js"></script>
  <style>
    :root{--bg:#0b1220;--card:rgba(27,46,92,.55);--txt:#e8eefc;--mut:#a9b8dd;--ok:#5ee1a2;}
    body{margin:0;font-family:system-ui;background:var(--bg);color:var(--txt);}
    .wrap{max-width:980px;margin:0 auto;padding:18px;}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:16px;}
    h1{margin:0 0 10px 0;}
    label{display:block;font-weight:900;margin-top:10px;}
    input,textarea,select{width:100%;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);color:var(--txt);font:600 14px system-ui;}
    textarea{min-height:88px;resize:vertical;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .btn{cursor:pointer;border:0;padding:10px 14px;border-radius:12px;font-weight:900;}
    .a{background:var(--ok);color:#082016;}
    .b{background:#22345f;color:var(--txt);}
    .mut{color:var(--mut);font-size:13px;}
    .mini{font-size:12px;opacity:.9}
    .filesRow{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;margin-top:8px;}
    .box{background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px;margin-top:10px;}
    .code{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;line-height:1.35}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>üß∞ Admin ‚Äî Vetrine</h1>

    <div class="row">
      <label style="display:flex;gap:10px;align-items:center;">
        <input type="checkbox" id="gAdmin" style="width:auto;"> Guida in Admin
      </label>
      <label style="display:flex;gap:10px;align-items:center;">
        <input type="checkbox" id="gVetrina" style="width:auto;"> Guida in Vetrina
      </label>
      <label style="display:flex;gap:10px;align-items:center;">
        <input type="checkbox" id="gAsk" style="width:auto;"> Chiedi al primo accesso
      </label>
      <label style="display:flex;gap:10px;align-items:center;">
        <input type="checkbox" id="gVoice" style="width:auto;"> Voce telefono
      </label>
    </div>

    <div class="mut" style="margin-top:8px;">
      La guida √® interattiva: quando tocchi una casella vuota, ti spiega cosa scrivere e qual √® il prossimo passo.
    </div>
  </div>

  <div class="card" style="margin-top:14px;">
    <div class="row" style="justify-content:space-between;">
      <div style="font-weight:1000;">Seleziona vetrina</div>
      <a class="mini" id="editIndex" target="_blank" rel="noopener">Apri index.json su GitHub</a>
    </div>

    <select id="vetrinaSelect"></select>
    <div class="mut">Se non vedi una vetrina, aggiungila in <b>data/index.json</b>.</div>

    <div class="row" style="margin-top:12px;">
      <button class="btn b" id="dupBtn">üß¨ Duplica vetrina</button>
    </div>

    <div class="box" id="dupBox" style="display:none;">
      <div style="font-weight:1000;margin-bottom:6px;">Duplica vetrina</div>

      <div class="mut">Da: <b id="dupFrom"></b></div>

      <label>Nuovo ID (es: scalvini11)</label>
      <input id="dupTo" placeholder="scalvini11">

      <label>Titolo nuovo (opzionale)</label>
      <input id="dupTitle" placeholder="Lascia vuoto = titolo originale con numero aggiornato">

      <div class="row" style="margin-top:10px;">
        <button class="btn a" id="dupMake">‚úÖ Crea duplicato (copia negli appunti)</button>
        <button class="btn b" id="dupOpenNewFile">üßæ Crea file su GitHub</button>
        <button class="btn b" id="dupOpenIndex">üß© Apri index.json</button>
        <button class="btn b" id="dupClose">Chiudi</button>
      </div>

      <div class="mut" style="margin-top:10px;">
        Ordine giusto:
        <ol>
          <li>Scrivi nuovo ID</li>
          <li>Premi ‚ÄúCrea duplicato‚Äù</li>
          <li>Premi ‚ÄúCrea file su GitHub‚Äù ‚Üí incolla ‚Üí salva</li>
          <li>Premi ‚ÄúApri index.json‚Äù ‚Üí aggiungi riga ‚Üí salva</li>
          <li>Apri subito i link pronti</li>
        </ol>
      </div>

      <div class="box">
        <div class="mut" style="margin-bottom:6px;">Anteprima (copiata negli appunti):</div>
        <div class="code" id="dupPreview"></div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:14px;">
    <div class="row" style="justify-content:space-between;">
      <div style="font-weight:1000;">Dati vetrina</div>
      <a class="mini" id="editJson" target="_blank" rel="noopener">Apri JSON su GitHub</a>
    </div>

    <label>ID</label>
    <input id="id" disabled>

    <label>Titolo</label>
    <input id="title" placeholder="Es: Scalvini 10">

    <label>Descrizione</label>
    <textarea id="description" placeholder="Es: Qui trovi manuale, foto e documenti."></textarea>

    <label>Voce (testo)</label>
    <textarea id="voiceText" placeholder="Es: Benvenuto nella vetrina Scalvini 10. Qui trovi i file disponibili."></textarea>

    <label>Mostra pulsante ‚ÄúGuida‚Äù al pubblico (showGuide)</label>
    <select id="showGuide">
      <option value="true">S√¨</option>
      <option value="false">No</option>
    </select>

    <div style="margin-top:12px;font-weight:1000;">Files (PDF / TXT / ZIP)</div>
    <div class="mut">URL consigliati: <b>files/manuale.pdf</b></div>
    <div id="filesBox"></div>

    <div class="row" style="margin-top:12px;">
      <button class="btn b" id="addFile">‚ûï Aggiungi file</button>
      <button class="btn a" id="copyJson">üìã Copia JSON pronto</button>
      <button class="btn b" id="openVetrina">üåç Apri Vetrina</button>
      <button class="btn b" id="openChecklist">üìò Apri Checklist</button>
    </div>

    <div class="mut" style="margin-top:8px;">
      Dopo ‚ÄúCopia JSON pronto‚Äù devi incollare su GitHub in <b>data/&lt;id&gt;.json</b> e salvare.
    </div>
  </div>

  <div class="card" style="margin-top:14px;">
    <div style="font-weight:1000;">üìå Guida istruttiva (Admin)</div>
    <div class="mut" id="guideText">
      Tocca una casella vuota per sentire cosa scrivere e qual √® il prossimo passo.
    </div>
  </div>
</div>

<script>
  // === Repo links
  const baseRepo = "https://github.com/creamiaappsercuctech/SerCucTech";
  const editIndex = document.getElementById("editIndex");
  editIndex.href = baseRepo + "/edit/main/data/index.json";

  // === Toggles
  const gAdmin = document.getElementById("gAdmin");
  const gVetrina = document.getElementById("gVetrina");
  const gAsk = document.getElementById("gAsk");
  const gVoice = document.getElementById("gVoice");

  gAdmin.checked = SCTGuide.getBool(SCTGuide.LS.guideAdmin,true);
  gVetrina.checked = SCTGuide.getBool(SCTGuide.LS.guideVetrina,true);
  gAsk.checked = SCTGuide.getBool(SCTGuide.LS.askOnFirstRun,true);
  gVoice.checked = SCTGuide.getBool(SCTGuide.LS.voiceEnabled,true);

  gAdmin.onchange = ()=>SCTGuide.setBool(SCTGuide.LS.guideAdmin,gAdmin.checked);
  gVetrina.onchange = ()=>SCTGuide.setBool(SCTGuide.LS.guideVetrina,gVetrina.checked);
  gAsk.onchange = ()=>SCTGuide.setBool(SCTGuide.LS.askOnFirstRun,gAsk.checked);
  gVoice.onchange = ()=>SCTGuide.setBool(SCTGuide.LS.voiceEnabled,gVoice.checked);

  const select = document.getElementById("vetrinaSelect");
  const editJson = document.getElementById("editJson");

  const idEl = document.getElementById("id");
  const titleEl = document.getElementById("title");
  const descEl = document.getElementById("description");
  const voiceEl = document.getElementById("voiceText");
  const showGuideEl = document.getElementById("showGuide");
  const filesBox = document.getElementById("filesBox");

  function guideSay(t){
    document.getElementById("guideText").textContent = t;
    if(SCTGuide.getBool(SCTGuide.LS.guideAdmin,true)) SCTGuide.speak(t);
  }

  // ====================== GUIDA PER CAMPI (FOCUS) ======================
  let __lastFocusKey = "";

  function speakIfAdminGuide(text){
    if (!SCTGuide.getBool(SCTGuide.LS.guideAdmin, true)) return;
    if (__lastFocusKey === text) return;
    __lastFocusKey = text;
    guideSay(text);
  }

  function onFocusEmpty(el, messageBuilder){
    if (!el) return;
    el.addEventListener("focus", () => {
      const v = (el.value || "").trim();
      if (v.length === 0) speakIfAdminGuide(messageBuilder());
    });
    el.addEventListener("click", () => {
      const v = (el.value || "").trim();
      if (v.length === 0) speakIfAdminGuide(messageBuilder());
    });
  }

  function attachFileRowGuide(rowEl){
    if (!rowEl) return;
    const ins = rowEl.querySelectorAll("input");
    const labelInput = ins[0];
    const urlInput = ins[1];

    onFocusEmpty(labelInput, () =>
      "Campo etichetta. Qui scrivi il nome che vede l'utente. Esempio: Manuale, Prezzi, Catalogo. Poi passa al campo URL."
    );

    onFocusEmpty(urlInput, () =>
      "Campo URL del file. Qui metti il percorso del file. Esempio: files manuale punto pdf. Se il file √® online, incolla il link completo. Poi premi Copia JSON pronto."
    );
  }

  function attachSelectGuide(sel, msg){
    if (!sel) return;
    sel.addEventListener("focus", () => speakIfAdminGuide(msg));
    sel.addEventListener("click", () => speakIfAdminGuide(msg));
  }

  function msgTitolo(){
    return "Campo Titolo. Scrivi il nome della vetrina, per esempio: Scalvini 10. Poi vai su Descrizione.";
  }
  function msgDescrizione(){
    return "Campo Descrizione. Scrivi una o due frasi su cosa contiene la vetrina. Esempio: Qui trovi manuale, foto e documenti. Poi vai su Voce.";
  }
  function msgVoce(){
    return "Campo Voce. Scrivi la frase che il telefono legger√† quando l'utente apre la vetrina. Esempio: Benvenuto nella vetrina Scalvini 10. Ora vai su Mostra guida al pubblico.";
  }
  function msgShowGuide(){
    return "Opzione Mostra guida al pubblico. Se scegli S√¨, in vetrina appare il pulsante Guida e l'utente pu√≤ aprire la checklist. Se scegli No, la checklist resta solo per te. Poi vai su Files.";
  }
  function msgDuplica(){
    return "Duplica vetrina. Serve per creare una nuova vetrina uguale. Passi: scrivi nuovo ID, premi Crea duplicato, poi Crea file su GitHub, incolla e salva, poi apri index.json e aggiungi la riga. Infine apri il link pronto.";
  }

  // ====== GUIDA AUTOMATICA SUI CAMPI (quando sono vuoti) ======
  onFocusEmpty(titleEl, msgTitolo);
  onFocusEmpty(descEl, msgDescrizione);
  onFocusEmpty(voiceEl, msgVoce);
  attachSelectGuide(showGuideEl, msgShowGuide());

  // ====================== FILE ROWS ======================
  function fileRow(label="", url=""){
    const wrap = document.createElement("div");
    wrap.className = "filesRow";
    wrap.innerHTML = `
      <input placeholder="Label (es: Manuale)" value="${String(label).replaceAll('"','&quot;')}">
      <input placeholder="URL (es: files/manuale.pdf)" value="${String(url).replaceAll('"','&quot;')}">
      <button class="btn b">‚úñ</button>
    `;
    wrap.querySelector("button").onclick = () => wrap.remove();

    // guida su label/url (quando vuoti)
    attachFileRowGuide(wrap);

    return wrap;
  }

  async function loadIndex(){
    const r = await fetch("./data/index.json", {cache:"no-store"});
    const idx = r.ok ? await r.json() : {vetrine:{}};
    const list = idx.vetrine ? Object.values(idx.vetrine) : [];

    select.innerHTML = "";
    list.forEach(v=>{
      const opt = document.createElement("option");
      opt.value = v.id;
      opt.textContent = v.title || v.id;
      select.appendChild(opt);
    });

    const appId = new URL(location.href).searchParams.get("id") || "";
    if(appId && list.some(v=>v.id===appId)) select.value = appId;
    else if(list[0]) select.value = list[0].id;

    select.onchange = () => loadVetrina(select.value);
    if(select.value) loadVetrina(select.value);
  }

  async function loadVetrina(id){
    const r = await fetch("./data/"+id+".json", {cache:"no-store"});
    const data = r.ok ? await r.json() : {id, files:[]};

    idEl.value = id;
    titleEl.value = data.title || "";
    descEl.value = data.description || "";
    voiceEl.value = (data.voice && data.voice.text) ? data.voice.text : "";
    showGuideEl.value = (data.showGuide === false) ? "false" : "true";

    filesBox.innerHTML = "";
    (data.files || []).forEach(f => filesBox.appendChild(fileRow(f.label||"", f.url||"")));

    editJson.href = baseRepo + "/edit/main/data/" + id + ".json";
    guideSay("Vetrina caricata. Tocca un campo vuoto per sapere cosa scrivere. Se vuoi creare una nuova vetrina, premi Duplica vetrina.");
  }

  function makeJson(id, title, description, voiceText, showGuide, files){
    return {
      id,
      title: title || id,
      description: description || "",
      voice: { lang: navigator.language || "it-IT", text: voiceText || ("Benvenuto nella vetrina " + (title||id)) },
      showGuide: !!showGuide,
      tags: [],
      media: [],
      files: files || [],
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };
  }

  // ===== Buttons guide
  document.getElementById("addFile").addEventListener("click", () => {
    filesBox.appendChild(fileRow("Manuale", "files/manuale.pdf"));
    if (SCTGuide.getBool(SCTGuide.LS.guideAdmin,true)) {
      guideSay("Hai aggiunto una riga file. Ora compila Etichetta e URL. Esempio: Manuale e files manuale punto pdf. Poi premi Copia JSON pronto.");
    }
  });

  document.getElementById("copyJson").addEventListener("click", async () => {
    const id = idEl.value.trim();
    const files = [...filesBox.querySelectorAll(".filesRow")].map(r=>{
      const ins = r.querySelectorAll("input");
      return { label: ins[0].value.trim(), url: ins[1].value.trim() };
    }).filter(x=>x.label && x.url);

    const out = makeJson(
      id,
      titleEl.value.trim(),
      descEl.value.trim(),
      voiceEl.value.trim(),
      showGuideEl.value==="true",
      files
    );

    await navigator.clipboard.writeText(JSON.stringify(out, null, 2));
    SCTGuide.toast("JSON copiato ‚úÖ");

    if (SCTGuide.getBool(SCTGuide.LS.guideAdmin,true)) {
      guideSay("JSON copiato. Ora apri GitHub con ‚ÄòApri JSON su GitHub‚Äô, incolla dentro data slash " + id + " punto json, e salva.");
    }
  });

  document.getElementById("openVetrina").onclick = () => {
    location.href = "./vetrina.html?id=" + encodeURIComponent(idEl.value);
  };

  document.getElementById("openChecklist").onclick = () => {
    location.href = "./checklist.html?id=" + encodeURIComponent(idEl.value);
  };

  // ================= DUPLICA =================
  const dupBtn = document.getElementById("dupBtn");
  const dupBox = document.getElementById("dupBox");
  const dupFrom = document.getElementById("dupFrom");
  const dupTo = document.getElementById("dupTo");
  const dupTitle = document.getElementById("dupTitle");
  const dupMake = document.getElementById("dupMake");
  const dupClose = document.getElementById("dupClose");
  const dupPreview = document.getElementById("dupPreview");

  const dupOpenNewFile = document.getElementById("dupOpenNewFile");
  const dupOpenIndex = document.getElementById("dupOpenIndex");

  dupBtn.addEventListener("click", () => {
    dupBox.style.display = "block";
    dupFrom.textContent = idEl.value || select.value || "";
    dupTo.value = "";
    dupTitle.value = "";
    dupPreview.textContent = "";
    if (SCTGuide.getBool(SCTGuide.LS.guideAdmin,true)) guideSay("Ora stai duplicando una vetrina. Passo uno: scrivi il nuovo ID. Passo due: premi Crea duplicato. Poi creerai il file su GitHub e aggiornerai index.json.");
  });

  dupClose.onclick = () => dupBox.style.display = "none";
  dupOpenIndex.onclick = () => window.open(baseRepo + "/edit/main/data/index.json", "_blank");

  dupOpenNewFile.onclick = () => {
    const toId = dupTo.value.trim();
    if(!toId){ SCTGuide.toast("Inserisci nuovo ID"); return; }
    const url = baseRepo + "/new/main/data?filename=" + encodeURIComponent(toId + ".json");
    window.open(url, "_blank");
    if (SCTGuide.getBool(SCTGuide.LS.guideAdmin,true)) guideSay("Si √® aperta la pagina GitHub per creare data/" + toId + ".json. Incolla il JSON che hai copiato e salva.");
  };

  // Duplica: cambia id ovunque + cambia numero nel titolo + aggiunge link pronti
  dupMake.onclick = async () => {
    const fromId = (idEl.value || select.value || "").trim();
    const toId = dupTo.value.trim();
    if(!fromId || !toId){ SCTGuide.toast("Inserisci nuovo ID"); return; }

    const r = await fetch("./data/"+fromId+".json", {cache:"no-store"});
    const src = r.ok ? await r.json() : null;
    if(!src){ SCTGuide.toast("Sorgente non trovata"); return; }

    const toTitleInput = dupTitle.value.trim();

    // prova a cambiare numero nel titolo (es. "Scalvini 10" -> "Scalvini 11")
    let autoTitle = (src.title || fromId);
    const mFrom = fromId.match(/(\d+)\s*$/);
    const mTo = toId.match(/(\d+)\s*$/);
    if (mFrom && mTo) {
      const fromNum = mFrom[1];
      const toNum = mTo[1];
      autoTitle = autoTitle
        .replace(new RegExp(`\\b${fromNum}\\b`, "g"), toNum)
        .replace(new RegExp(`\\b${fromNum}$`), toNum);
    }
    const newTitle = toTitleInput || autoTitle;

    // 1) JSON base duplicato
    let out = {
      ...src,
      id: toId,
      title: newTitle,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };

    // 2) SOSTITUZIONE ID OVUNQUE (testi/link)
    try {
      const txt = JSON.stringify(out);
      const replaced = txt.split(fromId).join(toId);
      out = JSON.parse(replaced);
    } catch(e) {
      // fallback: almeno id/title sono corretti
    }

    const outJson = JSON.stringify(out, null, 2);

    // Riga per index.json (schema minimo)
    const indexLine = `"${toId}": { "id": "${toId}", "title": "${newTitle}" }`;

    // Link pronti
    const basePages = "https://creamiaappsercuctech.github.io/SerCucTech";
    const linkApp = `${basePages}/app.html?id=${encodeURIComponent(toId)}`;
    const linkVetrina = `${basePages}/vetrina.html?id=${encodeURIComponent(toId)}`;
    const linkChecklist = `${basePages}/checklist.html?id=${encodeURIComponent(toId)}`;
    const linkAdmin = `${basePages}/admin.html?id=${encodeURIComponent(toId)}`;

    const all =
`=== INCOLLA QUESTO IN data/${toId}.json ===
${outJson}

=== AGGIUNGI QUESTA RIGA IN data/index.json (dentro vetrine) ===
${indexLine}

=== LINK PRONTI (NUOVA VETRINA) ===
APP (unica): ${linkApp}
Vetrina: ${linkVetrina}
Checklist: ${linkChecklist}
Admin: ${linkAdmin}
`;

    await navigator.clipboard.writeText(all);
    dupPreview.textContent = all;

    SCTGuide.toast("Duplicato copiato ‚úÖ");
    guideSay("Perfetto. Ho creato la nuova vetrina, sostituito l'ID ovunque, aggiornato il titolo e aggiunto i link pronti. Ora premi Crea file su GitHub, incolla e salva. Poi premi Apri index.json e aggiungi la riga. Infine apri il link della nuova vetrina.");
  };

  // ===== Open JSON edit link updated on load
  // (set inside loadVetrina)

  // ====== Extra: guida su duplicazione campi vuoti nel box
  onFocusEmpty(dupTo, () => "Campo nuovo ID. Scrivi per esempio scalvini undici. Poi premi Crea duplicato.");
  onFocusEmpty(dupTitle, () => "Campo titolo nuovo. Se vuoi, scrivi il titolo. Se lo lasci vuoto, io aggiorno automaticamente il numero nel titolo.");

  // init
  loadIndex();
</script>
</body>
</html>
```Ó®Å0Ó®Ç
