  <!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin SerCucTech</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="wrap">

  <div class="card" id="loginCard">
    <h3>Accesso Admin</h3>
    <input id="pin" type="password" placeholder="PIN">
    <button id="btnLogin">Entra</button>
    <div class="small">PIN default: <b>1234</b></div>
  </div>

  <div id="panel" class="hidden">

    <div class="card">
      <h3>Vetrine locali</h3>
      <select id="pick"></select>
      <div class="row">
        <button id="btnLoad">Carica</button>
        <button class="danger" id="btnNew">Nuova vetrina</button>
      </div>
      <div class="small" id="status"></div>
    </div>

    <div class="card">
      <h3>Editor vetrina</h3>

      <label class="small">ID vetrina (solo minuscolo, senza spazi)</label>
      <input id="vid" placeholder="es: sergio10">

      <input id="title" placeholder="Titolo">
      <textarea id="desc" placeholder="Descrizione"></textarea>

      <div class="small">Font e dimensioni</div>
      <select id="fontFamily">
        <option value="system-ui">System</option>
        <option value="Arial, sans-serif">Arial</option>
        <option value="'Times New Roman', serif">Times</option>
        <option value="Georgia, serif">Georgia</option>
        <option value="'Courier New', monospace">Courier</option>
      </select>
      <input type="number" id="baseFontSize" value="16" placeholder="Dimensione testo (px)">
      <input type="number" id="titleSize" value="32" placeholder="Dimensione titolo (px)">
      <label class="small">Colore titolo</label>
      <input type="color" id="titleColor" value="#ffffff">
      <label class="small">Colore sfondo</label>
      <input type="color" id="bgColor" value="#0b1020">

      <div class="small">Sfondo immagine (opzionale)</div>
      <input type="file" id="bgImage" accept="image/*">
      <div class="small" id="bgInfo">Nessuna immagine di sfondo</div>
      <button class="danger" id="btnRemoveBg">Rimuovi sfondo immagine</button>

      <hr>

      <div class="small">Presentazione (testo + voce)</div>
      <textarea id="presentationText" placeholder="Testo letto a voce quando l‚Äôutente apre la vetrina..."></textarea>
      <select id="voiceLang">
        <option value="it-IT">Italiano (it-IT)</option>
        <option value="uk-UA">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ (uk-UA)</option>
        <option value="en-US">English (en-US)</option>
        <option value="ja-JP">Êó•Êú¨Ë™û (ja-JP)</option>
      </select>
      <input type="number" id="voiceRate" value="1" step="0.1" placeholder="Velocit√† voce">
      <button id="btnTestVoice">‚ñ∂ Test voce</button>

      <hr>

      <h4>Upload multiplo (immagini/video)</h4>
      <input type="file" id="files" multiple accept="image/*,video/*">
      <div class="small">Android: tieni premuto su una foto per selezione multipla.</div>
      <button id="btnAddFiles">Aggiungi file</button>

      <h4>File presenti</h4>
      <div id="fileList"></div>

      <div class="row">
        <button id="btnSave">üíæ Salva / Aggiorna</button>
        <button class="danger" id="btnDelete">üóë Cancella vetrina</button>
      </div>

      <div class="card" style="background:#0b1224;margin-top:10px">
        <h4>Pubblicazione GitHub</h4>
        <button id="btnExportPublic">‚¨á Esporta ID.json (pubblico)</button>
        <div class="small">Carica in: <b>data/ID.json</b> (stesso ID)</div>
        <hr>
        <button id="btnExportRegistry">‚¨á Esporta vetrine.json</button>
        <div class="small">Carica in: <b>data/vetrine.json</b></div>
      </div>

    </div>
  </div>

</div>

<script src="app.js"></script>
<script>
initPin();

let currentBgBlob = null;
let uploaded = []; // {name,type,blob}

// ===== ID NORMALIZATION (TUTTI E 2: auto + blocco) =====
function normalizeId(raw){
  return String(raw||"")
    .trim()
    .toLowerCase()
    .replace(/\s+/g,"")
    .replace(/[^a-z0-9_-]/g,"");
}
function isValidId(id){
  return /^[a-z0-9][a-z0-9_-]{1,50}$/.test(id);
}
function requireValidIdOrAlert(){
  const clean = normalizeId(vid.value);
  vid.value = clean;
  if(!clean){ alert("ID obbligatorio. Esempio: sergio10"); return null; }
  if(!isValidId(clean)){
    alert("ID non valido. Usa solo a-z 0-9 _ - (senza spazi).");
    return null;
  }
  return clean;
}
vid.addEventListener("input", ()=>{ vid.value = normalizeId(vid.value); });

// ===== UI =====
function setStatus(t){ status.textContent = t || ""; }

async function refreshPicker(){
  const ids = await idbListIds();
  pick.innerHTML = `<option value="">-- Seleziona --</option>` + ids.map(id=>`<option value="${id}">${id}</option>`).join("");
}

function updateBgInfo(){
  bgInfo.textContent = currentBgBlob ? "‚úÖ Sfondo immagine impostato" : "Nessuna immagine di sfondo";
}

async function renderFiles(){
  if(!uploaded.length){
    fileList.innerHTML = `<div class="small">Nessun file.</div>`;
    return;
  }
  fileList.innerHTML = "";
  uploaded.forEach((f,i)=>{
    const card = document.createElement("div");
    card.className = "card";
    card.style.background = "#0b1224";

    const head = document.createElement("div");
    head.innerHTML = `<b>${escapeHtml(f.name)}</b><div class="small">${escapeHtml(f.type||"")}</div>`;

    const url = URL.createObjectURL(f.blob);
    const prev = document.createElement("div");
    if((f.type||"").startsWith("image/")){
      const img = document.createElement("img");
      img.src = url;
      img.style.width="120px"; img.style.height="120px";
      img.style.objectFit="cover"; img.style.borderRadius="10px";
      prev.appendChild(img);
    }else if((f.type||"").startsWith("video/")){
      const v = document.createElement("video");
      v.src = url; v.controls = true; v.muted = true;
      v.style.width="180px"; v.style.borderRadius="10px";
      prev.appendChild(v);
    }

    const row = document.createElement("div");
    row.className="row";

    const rn = document.createElement("button");
    rn.textContent="Rinomina";
    rn.onclick=()=>{
      const n = prompt("Nuovo nome:", f.name);
      if(n && n.trim()){ uploaded[i].name = n.trim(); renderFiles(); }
    };

    const del = document.createElement("button");
    del.className="danger";
    del.textContent="Elimina";
    del.onclick=()=>{
      if(!confirm("Eliminare questo file?")) return;
      uploaded.splice(i,1);
      renderFiles();
    };

    row.appendChild(rn);
    row.appendChild(del);

    card.appendChild(head);
    card.appendChild(prev);
    card.appendChild(row);
    fileList.appendChild(card);
  });
}

function clearForm(){
  pick.value="";
  vid.value=""; title.value=""; desc.value="";
  fontFamily.value="system-ui";
  baseFontSize.value=16;
  titleSize.value=32;
  titleColor.value="#ffffff";
  bgColor.value="#0b1020";
  presentationText.value="";
  voiceLang.value="it-IT";
  voiceRate.value=1;
  uploaded=[];
  currentBgBlob=null;
  bgImage.value="";
  updateBgInfo();
  renderFiles();
  setStatus("Pronto ‚úÖ");
}

// ===== LOGIN =====
btnLogin.onclick = async ()=>{
  if(pin.value !== getPin()) return alert("PIN errato");
  loginCard.classList.add("hidden");
  panel.classList.remove("hidden");
  await refreshPicker();
  updateBgInfo();
  await renderFiles();
  setStatus("Admin OK ‚úÖ");
};

// ===== LOAD =====
btnLoad.onclick = async ()=>{
  const id = pick.value;
  if(!id) return alert("Seleziona una vetrina");
  const v = await idbGetVetrina(id);
  if(!v) return alert("Non trovata");

  vid.value = v.id;
  title.value = v.title || "";
  desc.value = v.desc || "";
  fontFamily.value = v.fontFamily || "system-ui";
  baseFontSize.value = v.baseFontSize ?? 16;
  titleSize.value = v.titleSize ?? 32;
  titleColor.value = v.titleColor || "#ffffff";
  bgColor.value = v.bgColor || "#0b1020";
  presentationText.value = v.presentationText || "";
  voiceLang.value = v.voice?.lang || "it-IT";
  voiceRate.value = v.voice?.rate ?? 1;

  currentBgBlob = v.bgBlob || null;
  uploaded = Array.isArray(v.files) ? v.files.slice() : [];
  bgImage.value="";
  updateBgInfo();
  await renderFiles();
  setStatus("Caricata ‚úÖ");
};

btnNew.onclick = ()=> clearForm();

// ===== BG =====
bgImage.addEventListener("change", ()=>{
  const f = bgImage.files[0];
  if(!f) return;
  currentBgBlob = f;
  updateBgInfo();
});
btnRemoveBg.onclick = ()=>{
  currentBgBlob=null;
  bgImage.value="";
  updateBgInfo();
};

// ===== VOICE =====
btnTestVoice.onclick = ()=>{
  const ok = speakText(presentationText.value, {lang: voiceLang.value, rate: Number(voiceRate.value||1)});
  if(!ok) alert("Sintesi vocale non disponibile.");
};

// ===== ADD FILES =====
btnAddFiles.onclick = async ()=>{
  const fl = [...files.files];
  if(!fl.length) return alert("Seleziona file");
  for(const f of fl){
    uploaded.push({name:f.name, type:f.type, blob:f});
  }
  files.value="";
  await renderFiles();
  setStatus("File aggiunti ‚úÖ");
};

// ===== SAVE =====
btnSave.onclick = async ()=>{
  const id = requireValidIdOrAlert();
  if(!id) return;

  const obj = {
    id,
    title: title.value || id,
    desc: desc.value || "",
    fontFamily: fontFamily.value || "system-ui",
    baseFontSize: Number(baseFontSize.value || 16),
    titleSize: Number(titleSize.value || 32),
    titleColor: titleColor.value || "#ffffff",
    bgColor: bgColor.value || "#0b1020",
    bgBlob: currentBgBlob || null,
    presentationText: presentationText.value || "",
    voice: { lang: voiceLang.value || "it-IT", rate: Number(voiceRate.value || 1), pitch: 1, volume: 1 },
    files: uploaded
  };

  await idbPutVetrina(obj);
  await refreshPicker();
  setStatus("Salvata (locale) ‚úÖ");
};

// ===== DELETE =====
btnDelete.onclick = async ()=>{
  const id = requireValidIdOrAlert();
  if(!id) return;
  if(!confirm(`Cancellare vetrina "${id}"?`)) return;
  await idbDeleteVetrina(id);
  clearForm();
  await refreshPicker();
  setStatus("Cancellata ‚úÖ");
};

// ===== EXPORT PUBLIC =====
btnExportPublic.onclick = async ()=>{
  const id = requireValidIdOrAlert();
  if(!id) return;
  const v = await idbGetVetrina(id);
  if(!v) return alert("Vetrina non trovata");

  const out = {
    title: v.title, desc: v.desc,
    fontFamily: v.fontFamily, baseFontSize: v.baseFontSize,
    titleSize: v.titleSize, titleColor: v.titleColor,
    bgColor: v.bgColor,
    bgImage: v.bgBlob ? await blobToDataURL(v.bgBlob) : null,
    presentationText: v.presentationText,
    voice: v.voice,
    files: []
  };

  for(const f of (v.files||[])){
    out.files.push({
      name: f.name,
      type: f.type,
      data: await blobToDataURL(f.blob)
    });
  }

  await downloadJson(`${id}.json`, out);
  alert(`Ora carica su GitHub in: data/${id}.json`);
};

// ===== EXPORT REGISTRY =====
btnExportRegistry.onclick = async ()=>{
  const ids = await idbListIds();
  const arr = [];
  for(const id of ids){
    const v = await idbGetVetrina(id);
    arr.push({ id, title: v?.title || id });
  }
  await downloadJson("vetrine.json", arr);
  alert("Carica su GitHub in: data/vetrine.json");
};

updateBgInfo();
</script>
</body>
</html>
