<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin SerCucTech</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="wrap">

<div class="card" id="login">
  <h3>Accesso Admin</h3>
  <input id="pin" type="password" placeholder="PIN">
  <button onclick="doLogin()">Entra</button>
  <div class="small">PIN default: <b>1234</b></div>
</div>

<div id="panel" class="hidden">

<div class="card">
  <h3>Nuova / Modifica Vetrina</h3>

  <input id="vid" placeholder="ID vetrina (es: negozio1)">
  <input id="title" placeholder="Titolo">
  <textarea id="desc" placeholder="Descrizione"></textarea>

  <div class="small">Font e dimensioni</div>
  <select id="fontFamily">
    <option value="system-ui">System</option>
    <option value="Arial, sans-serif">Arial</option>
    <option value="'Times New Roman', serif">Times</option>
    <option value="Georgia, serif">Georgia</option>
    <option value="'Courier New', monospace">Courier</option>
  </select>

  <input type="number" id="baseFontSize" value="16" placeholder="Dimensione testo base (px)">
  <input type="number" id="titleSize" value="32" placeholder="Dimensione titolo (px)">

  <label>Colore titolo</label>
  <input type="color" id="titleColor" value="#ffffff">
  <label>Colore sfondo</label>
  <input type="color" id="bgColor" value="#0b1020">

  <div class="small">Presentazione (testo e voce)</div>
  <textarea id="presentationText" placeholder="Scrivi qui la presentazione da leggere a voce..."></textarea>
  <select id="voiceLang">
    <option value="it-IT">Italiano (it-IT)</option>
    <option value="uk-UA">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ (uk-UA)</option>
    <option value="en-US">English (en-US)</option>
    <option value="ja-JP">Êó•Êú¨Ë™û (ja-JP)</option>
  </select>
  <input type="number" id="voiceRate" value="1" step="0.1" placeholder="Velocit√† voce (1 = normale)">
  <button onclick="testVoice()">‚ñ∂ Test voce</button>

  <div class="small">File (immagini / video) ‚Äì seleziona pi√π file</div>
  <input type="file" id="files" multiple accept="image/*,video/*">
  <button onclick="upload()">Carica file</button>
  <div id="fileList"></div>

  <div class="row">
    <button onclick="save()">Salva / Aggiorna vetrina</button>
    <button class="danger" onclick="deleteVetrina()">üóë Cancella vetrina</button>
  </div>

  <div class="card" style="background:#0b1224">
    <button onclick="exportVetrinaJson()">‚¨á Esporta JSON vetrina (pubblica)</button>
    <div class="small">Carica su GitHub in: <b>data/ID.json</b></div>
  </div>
</div>

<div class="card">
  <h3>Vetrine create</h3>
  <div id="list"></div>
</div>

<div class="card">
  <h3>Gruppi (aggancia pi√π vetrine)</h3>
  <input id="groupId" placeholder="ID gruppo (es: natale2025)">
  <input id="groupTitle" placeholder="Titolo gruppo (es: Promo Natale)">
  <div class="small">Seleziona le vetrine da includere:</div>
  <div id="groupPick"></div>

  <button onclick="saveGroup()">Salva gruppo (locale)</button>

  <div class="card" style="background:#0b1224">
    <button onclick="exportGroupJson()">‚¨á Esporta JSON gruppo (pubblico)</button>
    <div class="small">Carica su GitHub in: <b>data/groups/GID.json</b></div>
  </div>

  <hr>
  <h4 class="small">Gruppi salvati</h4>
  <div id="groupList"></div>
</div>

</div>
</div>

<script src="app.js"></script>
<script>
initPin();

const GROUP_KEY = "sercuctech_groups";
let uploaded = [];

function doLogin(){
  if(pin.value === getPin()){
    login.style.display="none";
    panel.classList.remove("hidden");
    renderAll();
  } else alert("PIN errato");
}

async function upload(){
  for(const f of files.files){
    const data = await toBase64(f);
    uploaded.push({name:f.name,type:f.type,data});
  }
  renderFiles();
}
function renderFiles(){
  fileList.innerHTML = uploaded.map((f,i)=>`
    <div class="card" style="background:#0b1224">
      <b>${f.name}</b>
      <div class="small">${f.type}</div>
      <button class="danger" onclick="delFile(${i})">Elimina file</button>
    </div>
  `).join("");
}
function delFile(i){ uploaded.splice(i,1); renderFiles(); }

function buildVetrinaObject(){
  return {
    title: title.value || vid.value,
    desc: desc.value || "",
    fontFamily: fontFamily.value || "system-ui",
    baseFontSize: Number(baseFontSize.value || 16),
    titleSize: Number(titleSize.value || 32),
    titleColor: titleColor.value || "#ffffff",
    bgColor: bgColor.value || "#0b1020",
    presentationText: presentationText.value || "",
    voice: { lang: voiceLang.value || "it-IT", rate: Number(voiceRate.value || 1), pitch: 1, volume: 1 },
    files: uploaded
  };
}

function save(){
  const id=(vid.value||"").trim();
  if(!id) return alert("ID obbligatorio");
  const all = loadAll();
  all[id] = buildVetrinaObject();
  saveAll(all);
  alert("Salvato ‚úÖ");
  renderAll();
}

function deleteVetrina(){
  const id=(vid.value||"").trim();
  if(!id) return alert("Scrivi l‚ÄôID della vetrina");
  const all=loadAll();
  if(!all[id]) return alert("Non trovata in locale");
  if(!confirm(`Cancellare vetrina "${id}"?`)) return;
  delete all[id];
  saveAll(all);
  uploaded=[];
  renderFiles();
  alert("Cancellata ‚úÖ");
  renderAll();
}

function exportVetrinaJson(){
  const id=(vid.value||"").trim();
  if(!id) return alert("Scrivi l‚ÄôID della vetrina");
  const all=loadAll();
  const v=all[id];
  if(!v) return alert("Vetrina non trovata in locale");
  const blob=new Blob([JSON.stringify(v,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`${id}.json`;
  a.click();
  alert(`Carica su GitHub in: data/${id}.json`);
}

function testVoice(){
  const ok = speakText(presentationText.value, {lang: voiceLang.value, rate: voiceRate.value});
  if(!ok) alert("Sintesi vocale non disponibile su questo browser.");
}

function copyText(text){
  navigator.clipboard?.writeText(text).then(
    ()=>alert("Copiato ‚úÖ"),
    ()=>prompt("Copia manualmente:", text)
  );
}

function renderList(){
  const all=loadAll();
  const base = location.origin + location.pathname.replace("admin.html","");
  const ids=Object.keys(all);
  list.innerHTML = ids.length ? ids.map(id=>{
    const link = `${base}vetrina.html?id=${encodeURIComponent(id)}`;
    return `
      <div class="card">
        <b>${id}</b>
        <div class="small">${all[id].desc||""}</div>
        <a href="${link}" target="_blank">${link}</a>
        <button onclick="copyText('${link.replaceAll("'","%27")}')">Copia link</button>
      </div>
    `;
  }).join("") : `<div class="small">Nessuna vetrina.</div>`;
}

// Gruppi
function loadGroups(){ return JSON.parse(localStorage.getItem(GROUP_KEY)||"{}"); }
function saveGroups(g){ localStorage.setItem(GROUP_KEY, JSON.stringify(g)); }

function renderGroupPicker(){
  const all=loadAll();
  const ids=Object.keys(all);
  groupPick.innerHTML = ids.length ? ids.map(id=>`
    <label class="card" style="background:#0b1224;display:flex;gap:10px;align-items:center">
      <input type="checkbox" data-id="${id}" style="width:auto">
      <div>
        <b>${id}</b>
        <div class="small">${all[id].title||""}</div>
      </div>
    </label>
  `).join("") : `<div class="small">Crea prima almeno una vetrina.</div>`;
}

function saveGroup(){
  const gid=(groupId.value||"").trim();
  if(!gid) return alert("ID gruppo obbligatorio");
  const title=(groupTitle.value||gid).trim();
  const selected=[...groupPick.querySelectorAll('input[type="checkbox"]:checked')]
    .map(x=>x.getAttribute("data-id"));
  if(!selected.length) return alert("Seleziona almeno 1 vetrina");

  const groups=loadGroups();
  groups[gid]={ title, ids:selected, updatedAt: Date.now() };
  saveGroups(groups);

  alert(`Gruppo salvato ‚úÖ\nLink: bundle.html?g=${gid}`);
  renderGroups();
}

function exportGroupJson(){
  const gid=(groupId.value||"").trim();
  if(!gid) return alert("Scrivi l‚ÄôID gruppo (GID)");
  const groups=loadGroups();
  const g=groups[gid];
  if(!g) return alert("Gruppo non trovato in locale. Prima salva il gruppo.");

  // JSON pubblico: titolo + ids
  const publicGroup = { title: g.title || gid, ids: g.ids || [] };
  const blob=new Blob([JSON.stringify(publicGroup,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`${gid}.json`;
  a.click();
  alert(`Carica su GitHub in: data/groups/${gid}.json`);
}

function renderGroups(){
  const groups=loadGroups();
  const base = location.origin + location.pathname.replace("admin.html","");
  const keys=Object.keys(groups);
  groupList.innerHTML = keys.length ? keys.map(gid=>{
    const link = `${base}bundle.html?g=${encodeURIComponent(gid)}`;
    return `
      <div class="card">
        <b>${gid}</b> <span class="pill">${groups[gid].ids.length} vetrine</span>
        <div class="small">${groups[gid].title||""}</div>
        <a href="${link}" target="_blank">${link}</a>
        <div class="row">
          <button onclick="copyText('${link.replaceAll("'","%27")}')">Copia link</button>
          <button class="danger" onclick="deleteGroup('${gid.replaceAll("'","\\'")}')">üóë Elimina</button>
        </div>
      </div>
    `;
  }).join("") : `<div class="small">Nessun gruppo creato.</div>`;
}
function deleteGroup(gid){
  if(!confirm(`Eliminare gruppo "${gid}"?`)) return;
  const groups=loadGroups();
  delete groups[gid];
  saveGroups(groups);
  renderGroups();
}

function renderAll(){
  renderList();
  renderGroupPicker();
  renderGroups();
}
</script>

</body>
</html>
