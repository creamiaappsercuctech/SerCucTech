<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SerCucTech Admin ‚Äì Vetrine (DnD Media+Files + Duplica + Backup + OCR)</title>

  <div style="margin:10px 0;padding:10px;border:1px dashed #5ee1a2;border-radius:12px">
<label>
<input type="checkbox" id="adminGuideOn" checked>
üìò Guida attiva in Admin
</label>
<button onclick="openAdminGuide()">‚ñ∂Ô∏è Apri guida</button>
</div>

<script>
function openAdminGuide(){
if(!document.getElementById("adminGuideOn").checked)return;
const id=document.getElementById("existingVetrine")?.value||"scalvini10";
window.open(`checklist.html?id=${id}`,"_blank");
}
</script>
  <style>
    :root { --bg:#0b1220; --card:#111b2e; --txt:#e8eefc; --mut:#a9b8dd; --acc:#5ee1a2; --warn:#ffcc66; --danger:#ff6b6b; --b:#22345f; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:linear-gradient(180deg,#081024,#0b1220); color:var(--txt); }
    .wrap{ max-width:1150px; margin:0 auto; padding:18px; }
    .top{ display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .brand{ font-weight:900; letter-spacing:.3px; }
    .pill{ display:inline-flex; gap:8px; align-items:center; padding:8px 12px; border-radius:999px; background:#0f1a31; border:1px solid #1b2a4f; color:var(--mut); font-size:13px; }
    .grid{ display:grid; grid-template-columns:1fr; gap:14px; margin-top:14px; }
    @media(min-width: 980px){ .grid{ grid-template-columns: 1fr 1fr; } }
    .card{ background:rgba(17,27,46,.92); border:1px solid #1b2a4f; border-radius:16px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.22); }
    h2{ margin:0 0 10px 0; font-size:18px; }
    h3{ margin:14px 0 8px 0; font-size:15px; color:var(--mut); font-weight:900; }
    label{ display:block; margin:10px 0 6px; color:var(--mut); font-size:13px; }
    input, textarea, select{ width:100%; box-sizing:border-box; padding:10px 12px; border-radius:12px; border:1px solid var(--b); background:#0f1830; color:var(--txt); outline:none; }
    textarea{ min-height:88px; resize:vertical; }
    .row{ display:grid; gap:10px; grid-template-columns:1fr; }
    @media(min-width: 650px){ .row{ grid-template-columns: 1fr 1fr; } }
    .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button{ cursor:pointer; border:0; padding:10px 14px; border-radius:12px; font-weight:900; }
    .ok{ background:var(--acc); color:#052014; }
    .sec{ background:#22345f; color:var(--txt); }
    .warn{ background:var(--warn); color:#231a06; }
    .danger{ background:var(--danger); color:#2b0909; }
    .mini{ font-size:12px; color:var(--mut); line-height:1.35; }
    .hr{ height:1px; background:#1b2a4f; margin:14px 0; }
    .hidden{ display:none !important; }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas; background:#0f1a31; border:1px solid #22345f; padding:2px 8px; border-radius:10px; color:var(--mut); }
    .list{ display:grid; gap:8px; margin-top:10px; }
    .item{ display:flex; gap:10px; align-items:flex-start; justify-content:space-between; padding:10px; border-radius:14px; border:1px solid var(--b); background:#0c1530; }
    .item .meta{ flex:1; }
    img.preview, video.preview, iframe.preview{ width:100%; border-radius:14px; border:1px solid var(--b); background:#0f1830; }
    iframe.preview{ height:420px; border:0; }
    .bar{ height:10px; border:1px solid var(--b); border-radius:999px; overflow:hidden; background:#0f1830; }
    .bar > div{ height:100%; width:0%; background:var(--acc); }
    .drag { cursor:grab; user-select:none; padding:2px 8px; border-radius:10px; border:1px dashed #34508a; color:var(--mut); }
    .dropHint { outline: 2px dashed var(--acc); outline-offset: 6px; }
    .smallbtn { padding:8px 10px; border-radius:10px; font-weight:900; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="brand">SerCucTech ‚Äì Admin Vetrine</div>
    <div class="pill"><span>Stato:</span><b id="status">üîí Bloccato</b></div>
  </div>

  <!-- LOCK -->
  <div class="card" id="lockCard">
    <h2>Accesso</h2>
    <div class="mini">
      Tocca due parole *in sequenza* dentro la frase per sbloccare.<br>
      Frase: <span id="secretSentence"></span>
    </div>
    <div class="mini" style="margin-top:10px;">
      Segreto: <span class="kbd">LUCE</span> poi <span class="kbd">PORTA</span>
    </div>
    <div class="btns">
      <button class="sec" onclick="resetLock()">Reset</button>
    </div>
  </div>

  <div class="grid hidden" id="adminUI">

    <!-- INDEX -->
    <div class="card">
      <h2>Index (data/index.json)</h2>
      <div class="mini">
        File indice: <span class="kbd">data/index.json</span> ‚Üí vetrine <span class="kbd">data/&lt;id&gt;.json</span>
      </div>

      <div class="btns">
        <button class="sec" onclick="loadIndexFromRepo()">üì• Carica index dal repo</button>
        <button class="sec" onclick="document.getElementById('importIndex').click()">üìÇ Importa index.json</button>
        <button class="ok" onclick="downloadIndex()">‚¨áÔ∏è Scarica index.json</button>
      </div>

      <input id="importIndex" type="file" accept="application/json" class="hidden" />
      <div class="hr"></div>
      <div class="mini">
        Aggiornato: <b id="indexUpdated">‚Äî</b><br>
        Vetrine: <b id="indexCountV">0</b> ‚Ä¢ Gruppi: <b id="indexCountG">0</b>
      </div>
    </div>

    <!-- VETRINA -->
    <div class="card">
      <h2>Vetrina (data/&lt;id&gt;.json)</h2>

      <label>Seleziona vetrina</label>
      <select id="vSelect" onchange="loadSelectedVetrinaFile()">
        <option value="">‚Äî scegli ‚Äî</option>
      </select>

      <div class="btns">
        <button class="sec" onclick="loadSelectedVetrinaFile()">üì• Carica file vetrina</button>
        <button class="ok" onclick="downloadVetrina()">‚¨áÔ∏è Scarica &lt;id&gt;.json</button>
        <button class="warn" onclick="downloadBackupZip()">üß≥ Backup ZIP (JSON+media+files)</button>
        <button class="sec" onclick="openDuplicatePanel()">üß¨ Duplica vetrina</button>
        <button class="danger" onclick="deleteVetrina()">üóëÔ∏è Elimina vetrina</button>
      </div>

      <div id="dupPanel" class="hidden" style="margin-top:12px; padding:10px; border:1px solid var(--b); border-radius:14px; background:#0c1530;">
        <div class="mini"><b>Duplica</b> clona la vetrina corrente (JSON) su un nuovo ID e aggiorna anche <span class="kbd">data/index.json</span>.</div>
        <div class="row" style="margin-top:10px;">
          <div>
            <label>Nuovo ID</label>
            <input id="dupNewId" placeholder="es: scalvini11" />
          </div>
          <div>
            <label>Nuovo Titolo (opzionale)</label>
            <input id="dupNewTitle" placeholder="es: Vetrina Scalvini 11" />
          </div>
        </div>
        <div class="btns">
          <button class="ok" onclick="duplicateCurrentVetrina()">‚úÖ Crea clone</button>
          <button class="sec" onclick="closeDuplicatePanel()">Chiudi</button>
        </div>
        <div class="mini" style="margin-top:8px;">
          Dopo il clone: scarica <b>index.json</b> e <b>&lt;nuovoId&gt;.json</b>, poi caricali su GitHub in <span class="kbd">/data/</span>.
        </div>
      </div>

      <div class="hr"></div>

      <h3>Crea nuova vetrina</h3>
      <label>ID (unico)</label>
      <input id="newId" placeholder="es: scalvini10" />
      <label>Titolo</label>
      <input id="newTitle" placeholder="Titolo vetrina" />
      <label>Tags (virgola)</label>
      <input id="newTags" placeholder="casa, documenti" />
      <div class="btns">
        <button class="ok" onclick="createVetrina()">‚ûï Crea vetrina</button>
      </div>

      <div class="hr"></div>

      <h3>Editor</h3>
      <div class="pill">Vetrina attiva: <b id="activeId">‚Äî</b></div>

      <label>Titolo</label>
      <input id="eTitle" />
      <label>Descrizione</label>
      <textarea id="eDesc"></textarea>

      <div class="row">
        <div>
          <label>Voce (lang)</label>
          <input id="eVoiceLang" value="it-IT" />
        </div>
        <div>
          <label>Voce (testo)</label>
          <input id="eVoiceText" />
        </div>
      </div>

      <label>Tags (virgola)</label>
      <input id="eTags" />

      <div class="btns">
        <button class="ok" onclick="saveEdits()">üíæ Salva modifiche (in memoria)</button>
        <button class="warn" onclick="syncIndexFromVetrina()">üîÅ Aggiorna index (titolo/tags)</button>
      </div>
    </div>

    <!-- MEDIA -->
    <div class="card">
      <h2>Media (foto/video) ‚Äî URL + Upload multiplo + Riordino</h2>
      <div class="mini">
        Riordino: trascina (DnD) oppure ‚Üë ‚Üì. Poi scarica <span class="kbd">&lt;id&gt;.json</span>.
      </div>

      <h3>A) Aggiungi tramite URL</h3>
      <div class="row">
        <div>
          <label>Tipo</label>
          <select id="mType">
            <option value="image">Immagine</option>
            <option value="video">Video</option>
          </select>
        </div>
        <div>
          <label>Titolo</label>
          <input id="mTitle" placeholder="Foto 1 / Tour" />
        </div>
      </div>

      <label>URL</label>
      <input id="mUrl" placeholder="media/file.jpg oppure https://..." />
      <label>Nota</label>
      <input id="mNote" placeholder="" />

      <div class="btns">
        <button class="ok" onclick="addMediaByUrl()">‚ûï Aggiungi URL</button>
        <button class="sec" onclick="renderMediaList()">üîÑ Aggiorna lista</button>
      </div>

      <div class="hr"></div>

      <h3>B) Upload multiplo (foto + video)</h3>
      <label>Seleziona file (MULTIPLO)</label>
      <input id="mFiles" type="file" multiple accept="image/*,video/*" />

      <div class="btns">
        <button class="ok" onclick="addMediaFromFiles()">‚ûï Aggiungi al JSON</button>
        <button class="warn" onclick="downloadMediaZip()">‚¨áÔ∏è Scarica ZIP media/‚Ä¶</button>
        <button class="sec" onclick="clearMediaQueue()">üßπ Svuota selezione</button>
      </div>

      <div class="list" id="mediaQueue"></div>

      <div class="hr"></div>

      <h3>Media presenti nella vetrina</h3>
      <div class="list" id="mediaList"></div>
    </div>

    <!-- FILES MANAGER -->
    <div class="card">
      <h2>Files (PDF/TXT/ZIP/altro) ‚Äî URL + Riordino</h2>
      <div class="mini">
        Qui gestisci <span class="kbd">files[]</span> della vetrina.  
        Riordino: DnD oppure ‚Üë ‚Üì.  
        PDF: puoi vedere l‚Äôanteprima (iframe).
      </div>

      <h3>A) Aggiungi file tramite URL</h3>
      <label>Label</label>
      <input id="fLabel" placeholder="Manuale / Documento / Contratto..." />
      <label>URL</label>
      <input id="fUrl" placeholder="files/manuale.pdf oppure https://..." />

      <div class="btns">
        <button class="ok" onclick="addFileByUrl()">‚ûï Aggiungi file</button>
        <button class="sec" onclick="renderFilesList()">üîÑ Aggiorna lista</button>
      </div>

      <div class="hr"></div>

      <h3>Files presenti nella vetrina</h3>
      <div class="list" id="filesList"></div>
    </div>

    <!-- OCR -->
    <div class="card">
      <h2>OCR (solo Admin)</h2>
      <div class="mini">
        Estrai testo da immagine. Puoi scaricare un TXT e aggiungere il link in <span class="kbd">files[]</span>.
      </div>

      <div class="row">
        <div>
          <label>Lingua OCR</label>
          <select id="ocrLang">
            <option value="ita">Italiano (ita)</option>
            <option value="eng">Inglese (eng)</option>
            <option value="ukr">Ucraino (ukr)</option>
            <option value="deu">Tedesco (deu)</option>
            <option value="spa">Spagnolo (spa)</option>
            <option value="fra">Francese (fra)</option>
          </select>
        </div>
        <div>
          <label>Immagine per OCR</label>
          <input id="ocrFile" type="file" accept="image/*" />
        </div>
      </div>

      <div class="btns">
        <button class="ok" onclick="runOCR()">üß† Avvia OCR</button>
        <button class="sec" onclick="copyOCR()">üìã Copia testo</button>
        <button class="sec" onclick="speakOCR()">üîä Leggi testo</button>
        <button class="warn" onclick="downloadOCRtxt()">‚¨áÔ∏è Scarica TXT</button>
        <button class="warn" onclick="addOCRtoFiles()">‚ûï Aggiungi TXT in files[]</button>
        <button class="danger" onclick="clearOCR()">üßπ Pulisci</button>
      </div>

      <div style="margin-top:10px;">
        <div class="pill">Stato: <b id="ocrStatus">Pronto</b></div>
        <div style="margin-top:10px;" class="bar"><div id="ocrBar"></div></div>
      </div>

      <div class="row" style="margin-top:12px;">
        <div>
          <div class="mini" style="margin-bottom:6px;">Anteprima</div>
          <img id="ocrPreview" class="preview" style="display:none;" alt="OCR preview">
          <div id="ocrNoPreview" class="mini">Nessuna immagine caricata.</div>
        </div>
        <div>
          <div class="mini" style="margin-bottom:6px;">Testo OCR</div>
          <textarea id="ocrText" placeholder="Testo estratto..." spellcheck="false"></textarea>
        </div>
      </div>
    </div>

    <!-- GROUPS -->
    <div class="card">
      <h2>Gruppi</h2>
      <label>Seleziona gruppo</label>
      <select id="gSelect" onchange="loadGroupIntoEditor()">
        <option value="">‚Äî scegli ‚Äî</option>
      </select>

      <label>Key gruppo</label>
      <input id="gKey" placeholder="scalvini" />
      <label>Titolo gruppo</label>
      <input id="gTitle" />
      <label>Descrizione gruppo</label>
      <textarea id="gDesc"></textarea>
      <label>IDs vetrine (virgola)</label>
      <input id="gItems" placeholder="scalvini10, altroId" />

      <div class="btns">
        <button class="ok" onclick="saveGroup()">üíæ Salva gruppo</button>
        <button class="danger" onclick="deleteGroup()">üóëÔ∏è Elimina gruppo</button>
      </div>

      <div class="mini" style="margin-top:10px;">
        Pubblico gruppo: <span class="kbd">vetrina.html?group=scalvini</span>
      </div>
    </div>

  </div>
</div>

<script>
/* ================= CONFIG ================= */
const INDEX_PATH = "data/index.json";
const SECRET_WORDS = ["LUCE","PORTA"];
const SENTENCE = "Per entrare nell'area tecnica tocca LUCE poi PORTA in sequenza.";

/* ================= STATE ================= */
let unlocked = false;
let secretProgress = 0;

let indexDB = { meta:{version:1, updatedAt:null}, groups:{}, vetrine:{} };
let activeId = "";
let activeVetrina = null;

let mediaQueue = []; // files selected before zipping
let ocrImage = null;
let ocrLastTxtFilename = "";

/* ================= UTILS ================= */
function nowISO(){
  const d = new Date();
  const pad = n => String(n).padStart(2,"0");
  const offMin = -d.getTimezoneOffset();
  const sign = offMin >= 0 ? "+" : "-";
  const hh = pad(Math.floor(Math.abs(offMin)/60));
  const mm = pad(Math.abs(offMin)%60);
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}${sign}${hh}:${mm}`;
}
function sanitizeId(s){
  return (s||"").trim().toLowerCase().replace(/\s+/g,"").replace(/[^a-z0-9_-]/g,"");
}
function splitCSV(s){
  return (s||"").split(",").map(x=>x.trim()).filter(Boolean);
}
function dlJSON(obj, filename){
  const blob = new Blob([JSON.stringify(obj,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
}
function setStatus(txt){ document.getElementById("status").textContent = txt; }
function stopTTS(){ if('speechSynthesis' in window) window.speechSynthesis.cancel(); }
function speak(text, lang){
  stopTTS();
  if(!('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = lang || "it-IT";
  window.speechSynthesis.speak(u);
}
function escapeHTML(s){
  return String(s||"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function escapeAttr(s){ return escapeHTML(s).replaceAll("`","&#096;"); }
function isRelativeRepoPath(p){
  if(!p) return false;
  const s = String(p).trim();
  if(s.startsWith("http://") || s.startsWith("https://")) return false;
  if(s.startsWith("data/") || s.startsWith("media/") || s.startsWith("files/")) return true;
  return false;
}
function isPdf(url){
  return String(url||"").toLowerCase().split("?")[0].endsWith(".pdf");
}

/* ================= LOCK ================= */
function normalizeWord(w){ return (w||"").toUpperCase().replace(/[^\p{L}]/gu,""); }
function renderSecretSentence(){
  const el = document.getElementById("secretSentence");
  el.innerHTML = "";
  const parts = SENTENCE.split(" ");
  parts.forEach((w,i)=>{
    const span = document.createElement("span");
    span.textContent = w + (i===parts.length-1 ? "" : " ");
    span.style.cursor = "pointer";
    span.style.userSelect = "none";
    const clean = normalizeWord(w);
    span.style.fontWeight = (clean==="LUCE" || clean==="PORTA") ? "900" : "600";
    span.onclick = ()=> secretClick(w);
    el.appendChild(span);
  });
}
function secretClick(w){
  if(unlocked) return;
  const clean = normalizeWord(w);
  const expected = SECRET_WORDS[secretProgress];
  if(clean === expected){
    secretProgress++;
    if(secretProgress >= SECRET_WORDS.length) unlockAdmin();
  } else {
    secretProgress = 0;
  }
}
function resetLock(){ secretProgress=0; setStatus("üîí Bloccato"); }
function unlockAdmin(){
  unlocked = true;
  setStatus("‚úÖ Sbloccato");
  document.getElementById("lockCard").classList.add("hidden");
  document.getElementById("adminUI").classList.remove("hidden");
}

/* ================= INDEX ================= */
function normalizeIndex(data){
  indexDB = (data && typeof data==="object") ? data : {};
  indexDB.meta = indexDB.meta || {version:1, updatedAt:null};
  indexDB.groups = indexDB.groups || {};
  indexDB.vetrine = indexDB.vetrine || {};
  indexDB.meta.version = 1;
}
function refreshIndexUI(){
  document.getElementById("indexUpdated").textContent = indexDB.meta.updatedAt || "‚Äî";
  document.getElementById("indexCountV").textContent = Object.keys(indexDB.vetrine).length;
  document.getElementById("indexCountG").textContent = Object.keys(indexDB.groups).length;
}
function refreshSelects(){
  const vSel = document.getElementById("vSelect");
  const gSel = document.getElementById("gSelect");
  const prevV = vSel.value;
  const prevG = gSel.value;

  vSel.innerHTML = `<option value="">‚Äî scegli ‚Äî</option>`;
  Object.keys(indexDB.vetrine).sort().forEach(id=>{
    const rec = indexDB.vetrine[id];
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = `${id} ‚Äî ${rec.title || ""}`;
    vSel.appendChild(opt);
  });

  gSel.innerHTML = `<option value="">‚Äî scegli ‚Äî</option>`;
  Object.keys(indexDB.groups).sort().forEach(k=>{
    const g = indexDB.groups[k];
    const opt = document.createElement("option");
    opt.value = k;
    opt.textContent = `${k} ‚Äî ${g.title || ""}`;
    gSel.appendChild(opt);
  });

  if(prevV && indexDB.vetrine[prevV]) vSel.value = prevV;
  if(prevG && indexDB.groups[prevG]) gSel.value = prevG;
}
async function loadIndexFromRepo(){
  try{
    const res = await fetch(INDEX_PATH + "?t=" + Date.now(), {cache:"no-store"});
    if(!res.ok) throw new Error(res.status);
    normalizeIndex(await res.json());
    refreshIndexUI();
    refreshSelects();
    alert("‚úÖ Index caricato");
  }catch(e){
    console.error(e);
    alert("‚ùå Non trovo data/index.json.");
  }
}
function downloadIndex(){
  indexDB.meta.updatedAt = nowISO();
  refreshIndexUI();
  dlJSON(indexDB, "index.json");
}
document.getElementById("importIndex").addEventListener("change", async (ev)=>{
  const f = ev.target.files && ev.target.files[0];
  if(!f) return;
  try{
    normalizeIndex(JSON.parse(await f.text()));
    refreshIndexUI();
    refreshSelects();
    alert("‚úÖ Index importato");
  }catch(e){
    console.error(e);
    alert("‚ùå index.json non valido");
  }finally{
    ev.target.value = "";
  }
});

/* ================= VETRINA ================= */
function normalizeVetrina(v, id){
  const o = (v && typeof v==="object") ? v : {};
  o.id = o.id || id;
  o.title = o.title || "";
  o.description = o.description || "";
  o.voice = o.voice || {lang:"it-IT", text:""};
  o.tags = Array.isArray(o.tags) ? o.tags : [];
  o.media = Array.isArray(o.media) ? o.media : [];
  o.files = Array.isArray(o.files) ? o.files : [];
  o.createdAt = o.createdAt || nowISO();
  o.updatedAt = o.updatedAt || nowISO();
  return o;
}
function fillEditor(){
  document.getElementById("activeId").textContent = activeId || "‚Äî";
  if(!activeVetrina) return;
  document.getElementById("eTitle").value = activeVetrina.title || "";
  document.getElementById("eDesc").value = activeVetrina.description || "";
  document.getElementById("eVoiceLang").value = (activeVetrina.voice && activeVetrina.voice.lang) ? activeVetrina.voice.lang : "it-IT";
  document.getElementById("eVoiceText").value = (activeVetrina.voice && activeVetrina.voice.text) ? activeVetrina.voice.text : "";
  document.getElementById("eTags").value = (activeVetrina.tags || []).join(", ");
}
async function loadSelectedVetrinaFile(){
  const id = document.getElementById("vSelect").value;
  if(!id){ alert("Seleziona una vetrina"); return; }
  const rec = indexDB.vetrine[id];
  if(!rec || !rec.file){ alert("Index: manca 'file'"); return; }
  try{
    const res = await fetch(rec.file + "?t=" + Date.now(), {cache:"no-store"});
    if(!res.ok) throw new Error(res.status);
    activeId = id;
    activeVetrina = normalizeVetrina(await res.json(), id);
    fillEditor();
    renderMediaList();
    renderFilesList();
    clearMediaQueue();
    alert("‚úÖ Vetrina caricata");
  }catch(e){
    console.error(e);
    alert("‚ùå Non riesco a caricare " + rec.file);
  }
}
function saveEdits(){
  if(!activeVetrina){ alert("Carica una vetrina"); return; }
  activeVetrina.title = (document.getElementById("eTitle").value||"").trim();
  activeVetrina.description = (document.getElementById("eDesc").value||"").trim();
  activeVetrina.voice = activeVetrina.voice || {lang:"it-IT", text:""};
  activeVetrina.voice.lang = (document.getElementById("eVoiceLang").value||"it-IT").trim();
  activeVetrina.voice.text = (document.getElementById("eVoiceText").value||"").trim();
  activeVetrina.tags = splitCSV(document.getElementById("eTags").value);
  activeVetrina.updatedAt = nowISO();
  alert("‚úÖ Salvato in memoria. Scarica " + activeId + ".json");
}
function syncIndexFromVetrina(){
  if(!activeVetrina || !activeId){ alert("Carica una vetrina"); return; }
  if(!indexDB.vetrine[activeId]){ alert("Non presente in index"); return; }
  indexDB.vetrine[activeId].title = activeVetrina.title || activeId;
  indexDB.vetrine[activeId].tags = activeVetrina.tags || [];
  indexDB.vetrine[activeId].updatedAt = nowISO();
  indexDB.meta.updatedAt = nowISO();
  refreshIndexUI();
  refreshSelects();
  alert("‚úÖ Index aggiornato. Scarica index.json");
}
function downloadVetrina(){
  if(!activeVetrina || !activeId){ alert("Carica una vetrina"); return; }
  dlJSON(activeVetrina, `${activeId}.json`);
}
function createVetrina(){
  const id = sanitizeId(document.getElementById("newId").value);
  if(!id){ alert("ID non valido"); return; }
  if(indexDB.vetrine[id]){ alert("ID gi√† esistente"); return; }

  const title = (document.getElementById("newTitle").value||"").trim() || id;
  const tags = splitCSV(document.getElementById("newTags").value);

  indexDB.vetrine[id] = { id, title, file:`data/${id}.json`, tags, updatedAt: nowISO() };
  indexDB.meta.updatedAt = nowISO();
  refreshIndexUI();
  refreshSelects();

  activeId = id;
  activeVetrina = normalizeVetrina({ id, title, tags, media:[], files:[] }, id);
  fillEditor();
  renderMediaList();
  renderFilesList();
  clearMediaQueue();

  alert("‚úÖ Creata. Ora scarica: index.json e " + id + ".json e caricali su GitHub in /data/");
}
function deleteVetrina(){
  const id = document.getElementById("vSelect").value || activeId;
  if(!id){ alert("Seleziona una vetrina"); return; }
  if(!indexDB.vetrine[id]){ alert("Non trovata in index"); return; }
  if(!confirm("Eliminare vetrina " + id + " ? (poi devi cancellare anche data/"+id+".json dal repo)")) return;

  Object.keys(indexDB.groups).forEach(gk=>{
    const g = indexDB.groups[gk];
    if(Array.isArray(g.items)) g.items = g.items.filter(x => x !== id);
  });

  delete indexDB.vetrine[id];
  indexDB.meta.updatedAt = nowISO();
  refreshIndexUI();
  refreshSelects();

  if(activeId === id){
    activeId = "";
    activeVetrina = null;
    fillEditor();
    document.getElementById("mediaList").innerHTML = "";
    document.getElementById("filesList").innerHTML = "";
    clearMediaQueue();
  }

  alert("üóëÔ∏è Rimossa da index. Scarica index.json e caricalo su GitHub. Poi cancella data/"+id+".json manualmente.");
}

/* ================= DUPLICA VETRINA ================= */
function openDuplicatePanel(){
  if(!activeVetrina || !activeId){ alert("Carica una vetrina prima."); return; }
  document.getElementById("dupNewId").value = "";
  document.getElementById("dupNewTitle").value = "";
  document.getElementById("dupPanel").classList.remove("hidden");
}
function closeDuplicatePanel(){
  document.getElementById("dupPanel").classList.add("hidden");
}
function deepClone(obj){
  return JSON.parse(JSON.stringify(obj));
}
function duplicateCurrentVetrina(){
  if(!activeVetrina || !activeId){ alert("Carica una vetrina prima."); return; }
  const newId = sanitizeId(document.getElementById("dupNewId").value);
  if(!newId){ alert("Nuovo ID non valido"); return; }
  if(indexDB.vetrine[newId]){ alert("ID gi√† esistente in index"); return; }

  const newTitle = (document.getElementById("dupNewTitle").value||"").trim();

  const cloned = deepClone(activeVetrina);
  cloned.id = newId;
  if(newTitle) cloned.title = newTitle;
  cloned.createdAt = nowISO();
  cloned.updatedAt = nowISO();

  // aggiorna index
  indexDB.vetrine[newId] = {
    id: newId,
    title: cloned.title || newId,
    file: `data/${newId}.json`,
    tags: cloned.tags || [],
    updatedAt: nowISO()
  };
  indexDB.meta.updatedAt = nowISO();

  // set active to clone
  activeId = newId;
  activeVetrina = cloned;

  refreshIndexUI();
  refreshSelects();
  fillEditor();
  renderMediaList();
  renderFilesList();
  closeDuplicatePanel();

  alert("‚úÖ Clone creato IN MEMORIA. Ora scarica: index.json e " + newId + ".json e caricali su GitHub in /data/");
}

/* ================= MEDIA (URL) ================= */
function addMediaByUrl(){
  if(!activeVetrina){ alert("Carica una vetrina"); return; }
  const type = document.getElementById("mType").value;
  const url = (document.getElementById("mUrl").value||"").trim();
  const title = (document.getElementById("mTitle").value||"").trim();
  const note = (document.getElementById("mNote").value||"").trim();
  if(!url){ alert("Inserisci URL"); return; }

  activeVetrina.media.push({type, url, title, note});
  activeVetrina.updatedAt = nowISO();
  renderMediaList();

  document.getElementById("mUrl").value="";
  document.getElementById("mTitle").value="";
  document.getElementById("mNote").value="";
}

/* ================= MEDIA (MULTI FILE) ================= */
document.getElementById("mFiles").addEventListener("change", ()=>{
  const input = document.getElementById("mFiles");
  const files = Array.from(input.files || []);
  mediaQueue = files.map(f=>{
    const isVideo = f.type.startsWith("video/");
    const type = isVideo ? "video" : "image";
    const objectUrl = URL.createObjectURL(f);
    return {
      file: f,
      type,
      url: `media/${f.name}`,
      title: f.name,
      note: "",
      objectUrl
    };
  });
  renderMediaQueue();
});

function renderMediaQueue(){
  const box = document.getElementById("mediaQueue");
  box.innerHTML = "";
  if(mediaQueue.length === 0){
    box.innerHTML = `<div class="mini">Nessun file selezionato.</div>`;
    return;
  }

  mediaQueue.forEach((m, idx)=>{
    const row = document.createElement("div");
    row.className = "item";

    const left = document.createElement("div");
    left.className = "meta";
    left.innerHTML = `
      <b>${m.type==="video" ? "üé¨ Video" : "üñºÔ∏è Immagine"} ‚Äî ${escapeHTML(m.file.name)}</b>
      <div class="mini">URL nel JSON: <span class="kbd">${escapeHTML(m.url)}</span></div>
      <div class="mini">Dimensione: ${(m.file.size/1024/1024).toFixed(2)} MB</div>
      <label style="margin-top:8px;">Titolo</label>
      <input id="qTitle_${idx}" value="${escapeAttr(m.title)}" />
      <label>Nota</label>
      <input id="qNote_${idx}" value="${escapeAttr(m.note)}" />
    `;

    const right = document.createElement("div");
    right.innerHTML = `<button class="danger smallbtn" onclick="removeQueued(${idx})">Rimuovi</button>`;

    row.appendChild(left);
    row.appendChild(right);

    const previewWrap = document.createElement("div");
    previewWrap.style.marginTop = "10px";
    previewWrap.style.width = "100%";
    if(m.type === "video"){
      previewWrap.innerHTML = `<video class="preview" controls src="${m.objectUrl}"></video>`;
    } else {
      previewWrap.innerHTML = `<img class="preview" src="${m.objectUrl}" alt="preview">`;
    }
    left.appendChild(previewWrap);

    box.appendChild(row);
  });
}

function removeQueued(idx){
  const it = mediaQueue[idx];
  if(it && it.objectUrl) URL.revokeObjectURL(it.objectUrl);
  mediaQueue.splice(idx,1);
  renderMediaQueue();
}

function clearMediaQueue(){
  mediaQueue.forEach(it=>{ if(it.objectUrl) URL.revokeObjectURL(it.objectUrl); });
  mediaQueue = [];
  document.getElementById("mFiles").value = "";
  renderMediaQueue();
}

function addMediaFromFiles(){
  if(!activeVetrina){ alert("Carica una vetrina"); return; }
  if(mediaQueue.length === 0){ alert("Seleziona file"); return; }

  mediaQueue.forEach((m, idx)=>{
    const title = (document.getElementById(`qTitle_${idx}`)?.value || m.title || "").trim();
    const note = (document.getElementById(`qNote_${idx}`)?.value || m.note || "").trim();
    activeVetrina.media.push({
      type: m.type,
      url: m.url,
      title,
      note
    });
  });

  activeVetrina.updatedAt = nowISO();
  renderMediaList();

  alert("‚úÖ Aggiunti al JSON. Ora: scarica ZIP e carica i file in /media/, poi scarica " + activeId + ".json e caricalo in /data/.");
}

async function downloadMediaZip(){
  if(mediaQueue.length === 0){
    alert("Seleziona file prima.");
    return;
  }
  const zip = new JSZip();
  const folder = zip.folder("media");
  for(const m of mediaQueue){
    folder.file(m.file.name, m.file);
  }
  const blob = await zip.generateAsync({type:"blob"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `media_upload_${activeId || "vetrina"}.zip`;
  a.click();
}

/* ================= MEDIA LIST + DND ================= */
function moveInArray(arr, from, to){
  if(from === to) return;
  const item = arr.splice(from, 1)[0];
  arr.splice(to, 0, item);
}
function swapInArray(arr, i, j){
  const tmp = arr[i];
  arr[i] = arr[j];
  arr[j] = tmp;
}
function removeMedia(idx){
  if(!activeVetrina) return;
  activeVetrina.media.splice(idx,1);
  activeVetrina.updatedAt = nowISO();
  renderMediaList();
}
function applyMediaEdits(idx){
  const t = document.getElementById(`mt_${idx}`)?.value ?? "";
  const n = document.getElementById(`mn_${idx}`)?.value ?? "";
  activeVetrina.media[idx].title = String(t).trim();
  activeVetrina.media[idx].note = String(n).trim();
  activeVetrina.updatedAt = nowISO();
  alert("‚úÖ Modifiche media applicate (scarica poi il JSON).");
}
function previewMedia(idx){
  const m = activeVetrina.media[idx];
  const box = document.getElementById(`prevM_${idx}`);
  if(!box) return;
  if(!m || !m.url){ box.textContent = "Nessun URL"; return; }
  if(m.type === "video"){
    box.innerHTML = `<video class="preview" controls src="${escapeAttr(m.url)}"></video>`;
  } else {
    box.innerHTML = `<img class="preview" src="${escapeAttr(m.url)}" alt="preview">`;
  }
}
function moveMediaUp(idx){
  if(idx <= 0) return;
  swapInArray(activeVetrina.media, idx, idx-1);
  activeVetrina.updatedAt = nowISO();
  renderMediaList();
}
function moveMediaDown(idx){
  const arr = activeVetrina.media || [];
  if(idx >= arr.length-1) return;
  swapInArray(activeVetrina.media, idx, idx+1);
  activeVetrina.updatedAt = nowISO();
  renderMediaList();
}
function renderMediaList(){
  const list = document.getElementById("mediaList");
  list.innerHTML = "";
  if(!activeVetrina){
    list.innerHTML = `<div class="mini">Carica una vetrina.</div>`;
    return;
  }
  const media = activeVetrina.media || [];
  if(media.length === 0){
    list.innerHTML = `<div class="mini">Nessun media.</div>`;
    return;
  }

  media.forEach((m, idx)=>{
    const row = document.createElement("div");
    row.className = "item";
    row.draggable = true;
    row.dataset.index = String(idx);

    row.addEventListener("dragstart", (ev)=>{
      ev.dataTransfer.setData("text/plain", String(idx));
      ev.dataTransfer.effectAllowed = "move";
    });
    row.addEventListener("dragover", (ev)=>{
      ev.preventDefault();
      row.classList.add("dropHint");
      ev.dataTransfer.dropEffect = "move";
    });
    row.addEventListener("dragleave", ()=> row.classList.remove("dropHint"));
    row.addEventListener("drop", (ev)=>{
      ev.preventDefault();
      row.classList.remove("dropHint");
      const from = Number(ev.dataTransfer.getData("text/plain"));
      const to = Number(row.dataset.index);
      if(Number.isFinite(from) && Number.isFinite(to)){
        moveInArray(activeVetrina.media, from, to);
        activeVetrina.updatedAt = nowISO();
        renderMediaList();
      }
    });

    const left = document.createElement("div");
    left.className = "meta";
    const typeIcon = m.type==="video" ? "üé¨" : "üñºÔ∏è";
    left.innerHTML = `
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <span class="drag">‚áÖ</span>
        <b>${typeIcon} ${m.title ? escapeHTML(m.title) : "(senza titolo)"}</b>
      </div>
      <div class="mini mono">${escapeHTML(m.url||"")}</div>
      ${m.note ? `<div class="mini">üìù ${escapeHTML(m.note)}</div>` : ``}
      <div class="mini" style="margin-top:8px;">Modifica rapido:</div>
      <div class="row">
        <div>
          <label style="margin-top:6px;">Titolo</label>
          <input id="mt_${idx}" value="${escapeAttr(m.title||"")}" />
        </div>
        <div>
          <label style="margin-top:6px;">Nota</label>
          <input id="mn_${idx}" value="${escapeAttr(m.note||"")}" />
        </div>
      </div>
      <div class="btns">
        <button class="sec smallbtn" onclick="applyMediaEdits(${idx})">Applica</button>
        <button class="sec smallbtn" onclick="previewMedia(${idx})">Anteprima</button>
      </div>
      <div id="prevM_${idx}" class="mini" style="margin-top:8px;"></div>
    `;

    const right = document.createElement("div");
    right.innerHTML = `
      <div class="btns" style="justify-content:flex-end;">
        <button class="sec smallbtn" onclick="moveMediaUp(${idx})">‚Üë</button>
        <button class="sec smallbtn" onclick="moveMediaDown(${idx})">‚Üì</button>
        <button class="danger smallbtn" onclick="removeMedia(${idx})">Rimuovi</button>
      </div>
    `;

    row.appendChild(left);
    row.appendChild(right);
    list.appendChild(row);
  });
}

/* ================= FILES LIST + DND ================= */
function addFileByUrl(){
  if(!activeVetrina){ alert("Carica una vetrina"); return; }
  const label = (document.getElementById("fLabel").value||"").trim();
  const url = (document.getElementById("fUrl").value||"").trim();
  if(!label || !url){ alert("Inserisci Label e URL"); return; }
  activeVetrina.files.push({label, url});
  activeVetrina.updatedAt = nowISO();
  renderFilesList();
  document.getElementById("fLabel").value = "";
  document.getElementById("fUrl").value = "";
}

function removeFile(idx){
  activeVetrina.files.splice(idx,1);
  activeVetrina.updatedAt = nowISO();
  renderFilesList();
}
function applyFileEdits(idx){
  const l = document.getElementById(`fl_${idx}`)?.value ?? "";
  const u = document.getElementById(`fu_${idx}`)?.value ?? "";
  activeVetrina.files[idx].label = String(l).trim();
  activeVetrina.files[idx].url = String(u).trim();
  activeVetrina.updatedAt = nowISO();
  alert("‚úÖ Modifiche file applicate (scarica poi il JSON).");
}
function previewFile(idx){
  const f = activeVetrina.files[idx];
  const box = document.getElementById(`prevF_${idx}`);
  if(!box) return;
  if(!f || !f.url){ box.textContent = "Nessun URL"; return; }
  if(isPdf(f.url)){
    box.innerHTML = `<iframe class="preview" src="${escapeAttr(f.url)}"></iframe>`;
  }else{
    box.innerHTML = `<div class="mini">Anteprima disponibile solo per PDF. Link: <span class="kbd">${escapeHTML(f.url)}</span></div>`;
  }
}
function moveFileUp(idx){
  if(idx <= 0) return;
  swapInArray(activeVetrina.files, idx, idx-1);
  activeVetrina.updatedAt = nowISO();
  renderFilesList();
}
function moveFileDown(idx){
  const arr = activeVetrina.files || [];
  if(idx >= arr.length-1) return;
  swapInArray(activeVetrina.files, idx, idx+1);
  activeVetrina.updatedAt = nowISO();
  renderFilesList();
}

function renderFilesList(){
  const list = document.getElementById("filesList");
  list.innerHTML = "";
  if(!activeVetrina){
    list.innerHTML = `<div class="mini">Carica una vetrina.</div>`;
    return;
  }
  const files = activeVetrina.files || [];
  if(files.length === 0){
    list.innerHTML = `<div class="mini">Nessun file.</div>`;
    return;
  }

  files.forEach((f, idx)=>{
    const row = document.createElement("div");
    row.className = "item";
    row.draggable = true;
    row.dataset.index = String(idx);

    row.addEventListener("dragstart", (ev)=>{
      ev.dataTransfer.setData("text/plain", String(idx));
      ev.dataTransfer.effectAllowed = "move";
    });
    row.addEventListener("dragover", (ev)=>{
      ev.preventDefault();
      row.classList.add("dropHint");
      ev.dataTransfer.dropEffect = "move";
    });
    row.addEventListener("dragleave", ()=> row.classList.remove("dropHint"));
    row.addEventListener("drop", (ev)=>{
      ev.preventDefault();
      row.classList.remove("dropHint");
      const from = Number(ev.dataTransfer.getData("text/plain"));
      const to = Number(row.dataset.index);
      if(Number.isFinite(from) && Number.isFinite(to)){
        moveInArray(activeVetrina.files, from, to);
        activeVetrina.updatedAt = nowISO();
        renderFilesList();
      }
    });

    const left = document.createElement("div");
    left.className = "meta";
    const ico = isPdf(f.url) ? "üìÑ" : "üìé";
    left.innerHTML = `
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <span class="drag">‚áÖ</span>
        <b>${ico} ${f.label ? escapeHTML(f.label) : "(senza label)"}</b>
      </div>
      <div class="mini mono">${escapeHTML(f.url||"")}</div>

      <div class="mini" style="margin-top:8px;">Modifica rapido:</div>
      <div class="row">
        <div>
          <label style="margin-top:6px;">Label</label>
          <input id="fl_${idx}" value="${escapeAttr(f.label||"")}" />
        </div>
        <div>
          <label style="margin-top:6px;">URL</label>
          <input id="fu_${idx}" value="${escapeAttr(f.url||"")}" />
        </div>
      </div>
      <div class="btns">
        <button class="sec smallbtn" onclick="applyFileEdits(${idx})">Applica</button>
        <button class="sec smallbtn" onclick="previewFile(${idx})">Anteprima</button>
      </div>
      <div id="prevF_${idx}" class="mini" style="margin-top:8px;"></div>
    `;

    const right = document.createElement("div");
    right.innerHTML = `
      <div class="btns" style="justify-content:flex-end;">
        <button class="sec smallbtn" onclick="moveFileUp(${idx})">‚Üë</button>
        <button class="sec smallbtn" onclick="moveFileDown(${idx})">‚Üì</button>
        <button class="danger smallbtn" onclick="removeFile(${idx})">Rimuovi</button>
      </div>
    `;

    row.appendChild(left);
    row.appendChild(right);
    list.appendChild(row);
  });
}

/* ================= BACKUP ZIP ================= */
async function fetchAsBlob(path){
  const res = await fetch(path + "?t=" + Date.now(), {cache:"no-store"});
  if(!res.ok) throw new Error("Fetch failed: " + path);
  return await res.blob();
}
async function downloadBackupZip(){
  if(!activeVetrina || !activeId){
    alert("Carica una vetrina prima.");
    return;
  }

  const zip = new JSZip();
  zip.folder("data").file(`${activeId}.json`, JSON.stringify(activeVetrina, null, 2));

  const mediaFolder = zip.folder("media");
  const filesFolder = zip.folder("files");
  let okCount = 0;
  let failCount = 0;

  for(const m of (activeVetrina.media || [])){
    if(!m || !m.url) continue;
    if(!isRelativeRepoPath(m.url)) continue;
    const name = m.url.replace(/^media\//, "");
    try{
      const blob = await fetchAsBlob(m.url);
      mediaFolder.file(name, blob);
      okCount++;
    }catch(e){ failCount++; }
  }

  for(const f of (activeVetrina.files || [])){
    if(!f || !f.url) continue;
    if(!isRelativeRepoPath(f.url)) continue;
    const name = f.url.replace(/^files\//, "");
    try{
      const blob = await fetchAsBlob(f.url);
      filesFolder.file(name, blob);
      okCount++;
    }catch(e){ failCount++; }
  }

  const blob = await zip.generateAsync({type:"blob"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `backup_${activeId}.zip`;
  a.click();

  alert(`‚úÖ Backup creato. File inclusi: ${okCount} ‚Ä¢ Non trovati: ${failCount}`);
}

/* ================= OCR ================= */
const ocrFile = document.getElementById("ocrFile");
const ocrPreview = document.getElementById("ocrPreview");
const ocrNoPreview = document.getElementById("ocrNoPreview");
const ocrText = document.getElementById("ocrText");
const ocrStatus = document.getElementById("ocrStatus");
const ocrBar = document.getElementById("ocrBar");

ocrFile.addEventListener("change", (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f){ ocrImage=null; return; }
  if(!f.type.startsWith("image/")){
    alert("Carica un'immagine.");
    e.target.value = "";
    return;
  }
  ocrImage = f;
  ocrPreview.src = URL.createObjectURL(f);
  ocrPreview.style.display = "block";
  ocrNoPreview.style.display = "none";
  ocrStatus.textContent = "Immagine caricata";
  ocrBar.style.width = "0%";
});

async function runOCR(){
  if(!ocrImage){ alert("Carica un'immagine"); return; }
  const lang = document.getElementById("ocrLang").value;

  ocrStatus.textContent = "OCR in corso‚Ä¶";
  ocrBar.style.width = "0%";

  try{
    const { data } = await Tesseract.recognize(ocrImage, lang, {
      logger: (m)=>{
        if(m && m.status) ocrStatus.textContent = m.status;
        if(m && typeof m.progress === "number") ocrBar.style.width = Math.round(m.progress*100) + "%";
      }
    });
    const text = (data && data.text) ? data.text.trim() : "";
    ocrText.value = text;
    ocrStatus.textContent = text ? "‚úÖ OCR completato" : "‚úÖ OCR completato (nessun testo)";
    ocrBar.style.width = "100%";
    const ts = new Date().toISOString().replaceAll(":","-");
    ocrLastTxtFilename = `ocr-${activeId || "vetrina"}-${ts}.txt`;
  }catch(err){
    console.error(err);
    ocrStatus.textContent = "‚ùå Errore OCR";
    alert("Errore OCR: riprova con foto pi√π nitida o connessione migliore.");
  }
}

async function copyOCR(){
  const txt = (ocrText.value||"").trim();
  if(!txt){ alert("Nessun testo"); return; }
  try{
    await navigator.clipboard.writeText(txt);
    ocrStatus.textContent = "üìã Copiato";
  }catch(e){
    ocrText.select();
    document.execCommand("copy");
    ocrStatus.textContent = "üìã Copiato (fallback)";
  }
}

function speakOCR(){
  const txt = (ocrText.value||"").trim();
  if(!txt){ alert("Nessun testo"); return; }
  const lang = document.getElementById("ocrLang").value;
  const map = { ita:"it-IT", eng:"en-US", ukr:"uk-UA", deu:"de-DE", spa:"es-ES", fra:"fr-FR" };
  speak(txt, map[lang] || "it-IT");
}

function downloadOCRtxt(){
  const txt = (ocrText.value||"").trim();
  if(!txt){ alert("Nessun testo"); return; }
  const name = ocrLastTxtFilename || `ocr-${activeId || "vetrina"}.txt`;
  const blob = new Blob([txt], {type:"text/plain;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
}

function addOCRtoFiles(){
  if(!activeVetrina){ alert("Carica una vetrina"); return; }
  const txt = (ocrText.value||"").trim();
  if(!txt){ alert("Nessun testo"); return; }

  const name = ocrLastTxtFilename || `ocr-${activeId || "vetrina"}.txt`;
  activeVetrina.files.push({ label: "Testo OCR", url: `files/${name}` });
  activeVetrina.updatedAt = nowISO();
  renderFilesList();
  ocrStatus.textContent = "‚ûï Aggiunto in files[] (carica il TXT in /files/)";
  alert("‚úÖ Aggiunto. Ora: scarica il TXT e caricalo su GitHub in /files/. Poi scarica " + activeId + ".json e ricaricalo in /data/.");
}

function clearOCR(){
  document.getElementById("ocrFile").value = "";
  ocrImage = null;
  ocrPreview.src = "";
  ocrPreview.style.display = "none";
  ocrNoPreview.style.display = "block";
  ocrText.value = "";
  ocrStatus.textContent = "Pronto";
  ocrBar.style.width = "0%";
  ocrLastTxtFilename = "";
}

/* ================= GROUPS ================= */
function loadGroupIntoEditor(){
  const k = document.getElementById("gSelect").value;
  if(!k) return;
  const g = indexDB.groups[k];
  if(!g) return;
  document.getElementById("gKey").value = k;
  document.getElementById("gTitle").value = g.title || "";
  document.getElementById("gDesc").value = g.description || "";
  document.getElementById("gItems").value = (g.items||[]).join(", ");
}
function saveGroup(){
  const k = sanitizeId(document.getElementById("gKey").value);
  if(!k){ alert("Key non valida"); return; }
  indexDB.groups[k] = {
    title: (document.getElementById("gTitle").value||"").trim(),
    description: (document.getElementById("gDesc").value||"").trim(),
    items: splitCSV(document.getElementById("gItems").value).map(sanitizeId).filter(Boolean)
  };
  indexDB.meta.updatedAt = nowISO();
  refreshIndexUI();
  refreshSelects();
  alert("‚úÖ Gruppo salvato. Scarica index.json");
}
function deleteGroup(){
  const k = sanitizeId(document.getElementById("gKey").value);
  if(!k || !indexDB.groups[k]){ alert("Gruppo non trovato"); return; }
  if(!confirm("Eliminare gruppo " + k + " ?")) return;
  delete indexDB.groups[k];
  indexDB.meta.updatedAt = nowISO();
  refreshIndexUI();
  refreshSelects();
  alert("üóëÔ∏è Gruppo eliminato. Scarica index.json");
}

/* ================= INIT ================= */
renderSecretSentence();
renderMediaQueue();
</script>
</body>
</html>
