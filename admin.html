<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SerCucTech - Admin</title>
  <script src="./guide.js"></script>
  <style>
    :root{--bg:#0b1220;--card:rgba(27,46,92,.55);--txt:#e8eefc;--mut:#a9b8dd;--ok:#5ee1a2;}
    body{margin:0;font-family:system-ui;background:var(--bg);color:var(--txt);}
    .wrap{max-width:980px;margin:0 auto;padding:18px;}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:16px;}
    h1{margin:0 0 10px 0;}
    label{display:block;font-weight:900;margin-top:10px;}
    input,textarea,select{width:100%;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);color:var(--txt);font:600 14px system-ui;}
    textarea{min-height:88px;resize:vertical;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .btn{cursor:pointer;border:0;padding:10px 14px;border-radius:12px;font-weight:900;}
    .a{background:var(--ok);color:#082016;}
    .b{background:#22345f;color:var(--txt);}
    .mut{color:var(--mut);font-size:13px;}
    .mini{font-size:12px;opacity:.9}
    .filesRow{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;margin-top:8px;}
    .box{background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px;margin-top:10px;}
    .code{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;line-height:1.35}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>üß∞ Admin ‚Äî Vetrine</h1>

    <div class="row">
      <label style="display:flex;gap:10px;align-items:center;">
        <input type="checkbox" id="gAdmin" style="width:auto;"> Guida in Admin
      </label>
      <label style="display:flex;gap:10px;align-items:center;">
        <input type="checkbox" id="gVetrina" style="width:auto;"> Guida in Vetrina
      </label>
      <label style="display:flex;gap:10px;align-items:center;">
        <input type="checkbox" id="gAsk" style="width:auto;"> Chiedi al primo accesso
      </label>
      <label style="display:flex;gap:10px;align-items:center;">
        <input type="checkbox" id="gVoice" style="width:auto;"> Voce telefono
      </label>
    </div>

    <div class="mut" style="margin-top:8px;">
      La guida √® interattiva: quando fai click, lei ti dice cosa fare dopo.
    </div>
  </div>

  <div class="card" style="margin-top:14px;">
    <div class="row" style="justify-content:space-between;">
      <div style="font-weight:1000;">Seleziona vetrina</div>
      <a class="mini" id="editIndex" target="_blank" rel="noopener">Apri index.json su GitHub</a>
    </div>

    <select id="vetrinaSelect"></select>
    <div class="mut">Se non vedi una vetrina, aggiungila in <b>data/index.json</b>.</div>

    <div class="row" style="margin-top:12px;">
      <button class="btn b" id="dupBtn">üß¨ Duplica vetrina</button>
    </div>

    <div class="box" id="dupBox" style="display:none;">
      <div style="font-weight:1000;margin-bottom:6px;">Duplica vetrina</div>

      <div class="mut">Da: <b id="dupFrom"></b></div>

      <label>Nuovo ID (es: scalvini11)</label>
      <input id="dupTo" placeholder="scalvini11">

      <label>Titolo nuovo (opzionale)</label>
      <input id="dupTitle" placeholder="Lascia vuoto = titolo originale + (Copia)">

      <div class="row" style="margin-top:10px;">
        <button class="btn a" id="dupMake">‚úÖ Crea duplicato (copia negli appunti)</button>
        <button class="btn b" id="dupOpenNewFile">üßæ Crea file su GitHub</button>
        <button class="btn b" id="dupOpenIndex">üß© Apri index.json</button>
        <button class="btn b" id="dupClose">Chiudi</button>
      </div>

      <div class="mut" style="margin-top:10px;">
        Ordine giusto:
        <ol>
          <li>Premi ‚ÄúCrea duplicato‚Äù ‚Üí copia testo</li>
          <li>Premi ‚ÄúCrea file su GitHub‚Äù ‚Üí incolla dentro data/&lt;nuovoID&gt;.json</li>
          <li>Premi ‚ÄúApri index.json‚Äù ‚Üí aggiungi la riga nuova dentro vetrine</li>
        </ol>
      </div>

      <div class="box">
        <div class="mut" style="margin-bottom:6px;">Anteprima (copiata negli appunti):</div>
        <div class="code" id="dupPreview"></div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:14px;">
    <div class="row" style="justify-content:space-between;">
      <div style="font-weight:1000;">Dati vetrina</div>
      <a class="mini" id="editJson" target="_blank" rel="noopener">Apri JSON su GitHub</a>
    </div>

    <label>ID</label>
    <input id="id" disabled>

    <label>Titolo</label>
    <input id="title">

    <label>Descrizione</label>
    <textarea id="description"></textarea>

    <label>Voce (testo)</label>
    <textarea id="voiceText"></textarea>

    <label>Mostra pulsante ‚ÄúGuida‚Äù al pubblico (showGuide)</label>
    <select id="showGuide">
      <option value="true">S√¨</option>
      <option value="false">No</option>
    </select>

    <div style="margin-top:12px;font-weight:1000;">Files (PDF / TXT / ZIP)</div>
    <div class="mut">URL consigliati: <b>files/manuale.pdf</b></div>
    <div id="filesBox"></div>

    <div class="row" style="margin-top:12px;">
      <button class="btn b" id="addFile">‚ûï Aggiungi file</button>
      <button class="btn a" id="copyJson">üìã Copia JSON pronto</button>
      <button class="btn b" id="openVetrina">üåç Apri Vetrina</button>
      <button class="btn b" id="openChecklist">üìò Apri Checklist</button>
    </div>

    <div class="mut" style="margin-top:8px;">
      Dopo aver copiato il JSON, incollalo su GitHub in <b>data/&lt;id&gt;.json</b>.
    </div>
  </div>

  <div class="card" style="margin-top:14px;">
    <div style="font-weight:1000;">üìå Mini guida (Admin)</div>
    <div class="mut" id="guideText">
      Se vuoi creare una nuova vetrina: premi ‚ÄúDuplica vetrina‚Äù e segui l‚Äôordine 1-2-3.
    </div>
  </div>
</div>

<script>
  // === Repo links
  const baseRepo = "https://github.com/creamiaappsercuctech/SerCucTech";
  const editIndex = document.getElementById("editIndex");
  editIndex.href = baseRepo + "/edit/main/data/index.json";

  // === Toggles
  const gAdmin = document.getElementById("gAdmin");
  const gVetrina = document.getElementById("gVetrina");
  const gAsk = document.getElementById("gAsk");
  const gVoice = document.getElementById("gVoice");

  gAdmin.checked = SCTGuide.getBool(SCTGuide.LS.guideAdmin,true);
  gVetrina.checked = SCTGuide.getBool(SCTGuide.LS.guideVetrina,true);
  gAsk.checked = SCTGuide.getBool(SCTGuide.LS.askOnFirstRun,true);
  gVoice.checked = SCTGuide.getBool(SCTGuide.LS.voiceEnabled,true);

  gAdmin.onchange = ()=>SCTGuide.setBool(SCTGuide.LS.guideAdmin,gAdmin.checked);
  gVetrina.onchange = ()=>SCTGuide.setBool(SCTGuide.LS.guideVetrina,gVetrina.checked);
  gAsk.onchange = ()=>SCTGuide.setBool(SCTGuide.LS.askOnFirstRun,gAsk.checked);
  gVoice.onchange = ()=>SCTGuide.setBool(SCTGuide.LS.voiceEnabled,gVoice.checked);

  const select = document.getElementById("vetrinaSelect");
  const editJson = document.getElementById("editJson");

  const idEl = document.getElementById("id");
  const titleEl = document.getElementById("title");
  const descEl = document.getElementById("description");
  const voiceEl = document.getElementById("voiceText");
  const showGuideEl = document.getElementById("showGuide");
  const filesBox = document.getElementById("filesBox");

  function guideSay(t){
    document.getElementById("guideText").textContent = t;
    if(SCTGuide.getBool(SCTGuide.LS.guideAdmin,true)) SCTGuide.speak(t);
  }

  function fileRow(label="", url=""){
    const wrap = document.createElement("div");
    wrap.className = "filesRow";
    wrap.innerHTML = `
      <input placeholder="Label (es: Manuale)" value="${label.replaceAll('"','&quot;')}">
      <input placeholder="URL (es: files/manuale.pdf)" value="${url.replaceAll('"','&quot;')}">
      <button class="btn b">‚úñ</button>
    `;
    wrap.querySelector("button").onclick = () => wrap.remove();
    return wrap;
  }

  async function loadIndex(){
    const r = await fetch("./data/index.json", {cache:"no-store"});
    const idx = r.ok ? await r.json() : {vetrine:{}};
    const list = idx.vetrine ? Object.values(idx.vetrine) : [];
    select.innerHTML = "";
    list.forEach(v=>{
      const opt = document.createElement("option");
      opt.value = v.id;
      opt.textContent = v.title || v.id;
      select.appendChild(opt);
    });

    const appId = new URL(location.href).searchParams.get("id") || "";
    if(appId && list.some(v=>v.id===appId)) select.value = appId;
    else if(list[0]) select.value = list[0].id;

    select.onchange = () => loadVetrina(select.value);
    if(select.value) loadVetrina(select.value);
  }

  async function loadVetrina(id){
    const r = await fetch("./data/"+id+".json", {cache:"no-store"});
    const data = r.ok ? await r.json() : {id, files:[]};

    idEl.value = id;
    titleEl.value = data.title || "";
    descEl.value = data.description || "";
    voiceEl.value = (data.voice && data.voice.text) ? data.voice.text : "";
    showGuideEl.value = (data.showGuide === false) ? "false" : "true";

    filesBox.innerHTML = "";
    (data.files || []).forEach(f => filesBox.appendChild(fileRow(f.label||"", f.url||"")));

    editJson.href = baseRepo + "/edit/main/data/" + id + ".json";
    guideSay("Vetrina caricata. Se vuoi crearne una nuova: premi Duplica vetrina.");
  }

  document.getElementById("addFile").onclick = () => {
    filesBox.appendChild(fileRow("Manuale", "files/manuale.pdf"));
    guideSay("Aggiunto Manuale. Ora carica manuale.pdf in files/ e poi copia il JSON.");
  };

  function makeJson(id, title, description, voiceText, showGuide, files){
    return {
      id,
      title: title || id,
      description: description || "",
      voice: { lang: navigator.language || "it-IT", text: voiceText || ("Benvenuto nella vetrina " + (title||id)) },
      showGuide: !!showGuide,
      tags: [],
      media: [],
      files: files || [],
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };
  }

  document.getElementById("copyJson").onclick = async () => {
    const id = idEl.value.trim();
    const files = [...filesBox.querySelectorAll(".filesRow")].map(r=>{
      const ins = r.querySelectorAll("input");
      return { label: ins[0].value.trim(), url: ins[1].value.trim() };
    }).filter(x=>x.label && x.url);

    const out = makeJson(id, titleEl.value.trim(), descEl.value.trim(), voiceEl.value.trim(), showGuideEl.value==="true", files);
    await navigator.clipboard.writeText(JSON.stringify(out, null, 2));
    SCTGuide.toast("JSON copiato ‚úÖ");
    guideSay("JSON copiato. Apri GitHub e incollalo in data/"+id+".json poi salva.");
  };

  document.getElementById("openVetrina").onclick = () => location.href = "./vetrina.html?id=" + encodeURIComponent(idEl.value);
  document.getElementById("openChecklist").onclick = () => location.href = "./checklist.html?id=" + encodeURIComponent(idEl.value);

  // ================= DUPLICA =================
  const dupBtn = document.getElementById("dupBtn");
  const dupBox = document.getElementById("dupBox");
  const dupFrom = document.getElementById("dupFrom");
  const dupTo = document.getElementById("dupTo");
  const dupTitle = document.getElementById("dupTitle");
  const dupMake = document.getElementById("dupMake");
  const dupClose = document.getElementById("dupClose");
  const dupPreview = document.getElementById("dupPreview");

  const dupOpenNewFile = document.getElementById("dupOpenNewFile");
  const dupOpenIndex = document.getElementById("dupOpenIndex");

  dupBtn.onclick = () => {
    dupBox.style.display = "block";
    dupFrom.textContent = idEl.value || select.value || "";
    dupTo.value = "";
    dupTitle.value = "";
    dupPreview.textContent = "";
    guideSay("Scrivi il nuovo ID. Poi premi: Crea duplicato, poi Crea file su GitHub, poi Apri index.json.");
  };

  dupClose.onclick = () => dupBox.style.display = "none";

  dupOpenIndex.onclick = () => window.open(baseRepo + "/edit/main/data/index.json", "_blank");

  dupOpenNewFile.onclick = () => {
    const toId = dupTo.value.trim();
    if(!toId){ SCTGuide.toast("Inserisci nuovo ID"); return; }
    const url = baseRepo + "/new/main/data?filename=" + encodeURIComponent(toId + ".json");
    window.open(url, "_blank");
    guideSay("Si √® aperta la pagina GitHub per creare data/"+toId+".json. Incolla il JSON e salva.");
  };

  dupMake.onclick = async () => {
  const fromId = (idEl.value || select.value || "").trim();
  const toId = dupTo.value.trim();
  if(!fromId || !toId){ SCTGuide.toast("Inserisci nuovo ID"); return; }

  const r = await fetch("./data/"+fromId+".json", {cache:"no-store"});
  const src = r.ok ? await r.json() : null;
  if(!src){ SCTGuide.toast("Sorgente non trovata"); return; }

  const newTitle = dupTitle.value.trim() || ((src.title || fromId) + " (Copia)");

  // 1) JSON base duplicato
  let out = {
    ...src,
    id: toId,
    title: newTitle,
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };

  // 2) SOSTITUZIONE ID OVUNQUE:
  // Trasformo tutto in testo JSON -> sostituisco fromId con toId -> rileggo come oggetto
  try {
    const txt = JSON.stringify(out);
    const replaced = txt.split(fromId).join(toId);
    out = JSON.parse(replaced);
  } catch(e) {
    // se per qualche motivo fallisce, almeno id/title sono gi√† corretti
  }

  const outJson = JSON.stringify(out, null, 2);

  // Riga per index.json
  const indexLine = `"${toId}": { "id": "${toId}", "title": "${newTitle}" }`;

  const all =
`=== INCOLLA QUESTO IN data/${toId}.json ===
${outJson}

=== AGGIUNGI QUESTA RIGA IN data/index.json (dentro vetrine) ===
${indexLine}
`;

  await navigator.clipboard.writeText(all);
  dupPreview.textContent = all;

  SCTGuide.toast("Duplicato copiato ‚úÖ");
  guideSay("Duplicato perfetto. Ho sostituito l'ID ovunque. Ora premi ‚ÄòCrea file su GitHub‚Äô, incolla e salva. Poi apri index.json e aggiungi la riga.");
};
    const fromId = (idEl.value || select.value || "").trim();
    const toId = dupTo.value.trim();
    if(!fromId || !toId){ SCTGuide.toast("Inserisci nuovo ID"); return; }

    const r = await fetch("./data/"+fromId+".json", {cache:"no-store"});
    const src = r.ok ? await r.json() : null;
    if(!src){ SCTGuide.toast("Sorgente non trovata"); return; }

    const newTitle = dupTitle.value.trim() || ((src.title || fromId) + " (Copia)");
    const out = { ...src, id: toId, title: newTitle, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() };

    const outJson = JSON.stringify(out, null, 2);
    const indexLine = `"${toId}": { "id": "${toId}", "title": "${newTitle}" }`;

    const all =
`=== INCOLLA QUESTO IN data/${toId}.json ===
${outJson}

=== AGGIUNGI QUESTA RIGA IN data/index.json (dentro vetrine) ===
${indexLine}
`;

    await navigator.clipboard.writeText(all);
    dupPreview.textContent = all;

    SCTGuide.toast("Duplicato copiato ‚úÖ");
    guideSay("Ok. Ora premi ‚ÄòCrea file su GitHub‚Äô, incolla il JSON, salva. Poi premi ‚ÄòApri index.json‚Äô e aggiungi la riga.");
  };

  loadIndex();
</script>
</body>
</html>
