<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SerCucTech - Admin</title>
  <script src="./guide.js"></script>
  <style>
    :root{--bg:#0b1220;--card:rgba(27,46,92,.55);--txt:#e8eefc;--mut:#a9b8dd;--ok:#5ee1a2;}
    body{margin:0;font-family:system-ui;background:var(--bg);color:var(--txt);}
    .wrap{max-width:980px;margin:0 auto;padding:18px;}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:16px;}
    h1{margin:0 0 10px 0;}
    label{display:block;font-weight:900;margin-top:10px;}
    input,textarea,select{width:100%;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);color:var(--txt);font:600 14px system-ui;}
    textarea{min-height:88px;resize:vertical;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .btn{cursor:pointer;border:0;padding:10px 14px;border-radius:12px;font-weight:900;}
    .a{background:var(--ok);color:#082016;}
    .b{background:#22345f;color:var(--txt);}
    .mut{color:var(--mut);font-size:13px;}
    .mini{font-size:12px;opacity:.9;}
    .filesRow{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;margin-top:8px;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>üß∞ Admin ‚Äî Vetrine</h1>

    <div class="row">
      <label style="display:flex;gap:10px;align-items:center;">
        <input type="checkbox" id="gAdmin" style="width:auto;"> Guida in Admin
      </label>
      <label style="display:flex;gap:10px;align-items:center;">
        <input type="checkbox" id="gVetrina" style="width:auto;"> Guida in Vetrina
      </label>
      <label style="display:flex;gap:10px;align-items:center;">
        <input type="checkbox" id="gAsk" style="width:auto;"> Chiedi al primo accesso
      </label>
      <label style="display:flex;gap:10px;align-items:center;">
        <input type="checkbox" id="gVoice" style="width:auto;"> Voce telefono
      </label>
    </div>

    <div class="mut" style="margin-top:8px;">
      Suggerimento: in ‚ÄúGuida in Vetrina‚Äù abiliti la guida vocale quando l‚Äôutente clicca file e pulsanti.
    </div>
  </div>

  <div class="card" style="margin-top:14px;">
    <div class="row" style="justify-content:space-between;">
      <div style="font-weight:1000;">Seleziona vetrina</div>
      <a class="mini" id="editIndex" target="_blank" rel="noopener">Apri index.json su GitHub</a>
    </div>

    <select id="vetrinaSelect"></select>
    <div class="mut">Se non vedi una vetrina, aggiungila in <b>data/index.json</b>.</div>
  </div>

  <div class="card" style="margin-top:14px;">
    <div class="row" style="justify-content:space-between;">
      <div style="font-weight:1000;">Dati vetrina</div>
      <a class="mini" id="editJson" target="_blank" rel="noopener">Apri JSON su GitHub</a>
    </div>

    <label>ID</label>
    <input id="id" disabled>

    <label>Titolo</label>
    <input id="title">

    <label>Descrizione</label>
    <textarea id="description"></textarea>

    <label>Voce (testo)</label>
    <textarea id="voiceText"></textarea>

    <label>Mostra pulsante ‚ÄúGuida‚Äù al pubblico (showGuide)</label>
    <select id="showGuide">
      <option value="true">S√¨</option>
      <option value="false">No</option>
    </select>

    <div style="margin-top:12px;font-weight:1000;">Files (PDF / TXT / ZIP)</div>
    <div class="mut">URL consigliati: <b>files/manuale.pdf</b> oppure link completo https://‚Ä¶</div>
    <div id="filesBox"></div>

    <div class="row" style="margin-top:12px;">
      <button class="btn b" id="addFile">‚ûï Aggiungi file</button>
      <button class="btn a" id="copyJson">üìã Copia JSON pronto</button>
      <button class="btn b" id="openVetrina">üåç Apri Vetrina</button>
      <button class="btn b" id="openChecklist">üìò Apri Checklist</button>
    </div>

    <div class="mut" style="margin-top:8px;">
      Dopo aver copiato il JSON, vai su GitHub e incollalo dentro <b>data/&lt;id&gt;.json</b>.
    </div>
  </div>

  <div class="card" style="margin-top:14px;">
    <div style="font-weight:1000;">üìå Mini guida (Admin)</div>
    <div class="mut" id="guideText">
      Premi ‚ÄúAggiungi file‚Äù per inserire Manuale. Poi copia il JSON e incollalo su GitHub.
    </div>
  </div>
</div>

<script>
  // Toggles
  const gAdmin = document.getElementById("gAdmin");
  const gVetrina = document.getElementById("gVetrina");
  const gAsk = document.getElementById("gAsk");
  const gVoice = document.getElementById("gVoice");

  gAdmin.checked = SCTGuide.getBool(SCTGuide.LS.guideAdmin,true);
  gVetrina.checked = SCTGuide.getBool(SCTGuide.LS.guideVetrina,true);
  gAsk.checked = SCTGuide.getBool(SCTGuide.LS.askOnFirstRun,true);
  gVoice.checked = SCTGuide.getBool(SCTGuide.LS.voiceEnabled,true);

  gAdmin.onchange = ()=>SCTGuide.setBool(SCTGuide.LS.guideAdmin,gAdmin.checked);
  gVetrina.onchange = ()=>SCTGuide.setBool(SCTGuide.LS.guideVetrina,gVetrina.checked);
  gAsk.onchange = ()=>SCTGuide.setBool(SCTGuide.LS.askOnFirstRun,gAsk.checked);
  gVoice.onchange = ()=>SCTGuide.setBool(SCTGuide.LS.voiceEnabled,gVoice.checked);

  const select = document.getElementById("vetrinaSelect");
  const editIndex = document.getElementById("editIndex");
  const editJson = document.getElementById("editJson");

  const idEl = document.getElementById("id");
  const titleEl = document.getElementById("title");
  const descEl = document.getElementById("description");
  const voiceEl = document.getElementById("voiceText");
  const showGuideEl = document.getElementById("showGuide");
  const filesBox = document.getElementById("filesBox");

  const baseRepo = "https://github.com/creamiaappsercuctech/SerCucTech";
  editIndex.href = baseRepo + "/edit/main/data/index.json";

  const appId = new URL(location.href).searchParams.get("id") || "scalvini10";

  function guideSay(t){
    document.getElementById("guideText").textContent = t;
    if(SCTGuide.getBool(SCTGuide.LS.guideAdmin,true)) SCTGuide.speak(t);
  }

  function fileRow(label="", url=""){
    const wrap = document.createElement("div");
    wrap.className = "filesRow";
    wrap.innerHTML = `
      <input placeholder="Label (es: Manuale)" value="${label.replaceAll('"','&quot;')}">
      <input placeholder="URL (es: files/manuale.pdf)" value="${url.replaceAll('"','&quot;')}">
      <button class="btn b">‚úñ</button>
    `;
    wrap.querySelector("button").onclick = () => wrap.remove();
    return wrap;
  }

  async function loadIndex(){
    const r = await fetch("./data/index.json", {cache:"no-store"});
    const idx = r.ok ? await r.json() : {vetrine:{}};
    const list = idx.vetrine ? Object.values(idx.vetrine) : [];
    select.innerHTML = "";
    list.forEach(v=>{
      const opt = document.createElement("option");
      opt.value = v.id;
      opt.textContent = v.title || v.id;
      select.appendChild(opt);
    });

    // default
    if(list.some(v=>v.id===appId)) select.value = appId;
    else if(list[0]) select.value = list[0].id;

    select.onchange = () => loadVetrina(select.value);
    if(select.value) loadVetrina(select.value);
  }

  async function loadVetrina(id){
    const r = await fetch("./data/"+id+".json", {cache:"no-store"});
    const data = r.ok ? await r.json() : {id, files:[]};

    idEl.value = id;
    titleEl.value = data.title || "";
    descEl.value = data.description || "";
    voiceEl.value = (data.voice && data.voice.text) ? data.voice.text : "";
    showGuideEl.value = (data.showGuide === false) ? "false" : "true";

    filesBox.innerHTML = "";
    (data.files || []).forEach(f => filesBox.appendChild(fileRow(f.label||"", f.url||"")));

    editJson.href = baseRepo + "/edit/main/data/" + id + ".json";

    guideSay("Hai caricato la vetrina. Ora puoi aggiungere file e poi copiare il JSON pronto.");
  }

  document.getElementById("addFile").onclick = () => {
    filesBox.appendChild(fileRow("Manuale", "files/manuale.pdf"));
    guideSay("Aggiunto un file ‚ÄòManuale‚Äô. Ora carica manuale.pdf nella cartella files/ e poi copia il JSON.");
  };

  document.getElementById("openVetrina").onclick = () => {
    location.href = "./vetrina.html?id=" + encodeURIComponent(idEl.value);
  };

  document.getElementById("openChecklist").onclick = () => {
    location.href = "./checklist.html?id=" + encodeURIComponent(idEl.value);
  };

  document.getElementById("copyJson").onclick = async () => {
    const id = idEl.value.trim();
    const files = [...filesBox.querySelectorAll(".filesRow")].map(r=>{
      const ins = r.querySelectorAll("input");
      return { label: ins[0].value.trim(), url: ins[1].value.trim() };
    }).filter(x=>x.label && x.url);

    const out = {
      id,
      title: titleEl.value.trim(),
      description: descEl.value.trim(),
      voice: { lang: navigator.language || "it-IT", text: voiceEl.value.trim() || ("Benvenuto nella vetrina " + (titleEl.value.trim()||id)) },
      showGuide: (showGuideEl.value === "true"),
      tags: [],
      media: [],
      files,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };

    const txt = JSON.stringify(out, null, 2);
    await navigator.clipboard.writeText(txt);
    SCTGuide.toast("JSON copiato ‚úÖ");
    guideSay("JSON copiato. Ora apri GitHub e incollalo in data/" + id + ".json, poi salva.");
  };

  loadIndex();
</script>
</body>
</html>
