<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SerCucTech ‚Äì Admin Vetrine</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b1220">
  <link rel="apple-touch-icon" href="icon-192.png">

  <link rel="stylesheet" href="stile.css" />

  <style>
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:999px;background:#0f1a31;border:1px solid #1b2a4f;color:var(--mut);font-size:13px}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
    @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
    .kbd{font-family:var(--mono);background:#0f1a31;border:1px solid #22345f;padding:2px 8px;border-radius:10px;color:var(--mut)}
    .mono{font-family:var(--mono)}
    .dropHint{ outline: 2px dashed var(--acc); outline-offset: 6px; }
    .drag{ cursor:grab; user-select:none; padding:2px 8px; border-radius:10px; border:1px dashed #34508a; color:var(--mut); }
    .smallbtn{ padding:8px 10px; border-radius:10px; font-weight:900; }
    .bar{ height:10px; border:1px solid var(--b); border-radius:999px; overflow:hidden; background:#0f1830; }
    .bar > div{ height:100%; width:0%; background:var(--acc); }
    img.preview, video.preview, iframe.preview{ width:100%; border-radius:14px; border:1px solid var(--b); background:#0f1830; }
    iframe.preview{ height:420px; border:0; }

    /* toggle */
    .toggleRow{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .switch{position:relative; width:54px; height:32px; display:inline-block;}
    .switch input{display:none;}
    .slider{
      position:absolute; inset:0;
      background:#22345f; border:1px solid #2c4378;
      border-radius:999px; transition:.2s;
    }
    .slider:before{
      content:""; position:absolute; width:26px; height:26px; left:3px; top:2px;
      background:#e8eefc; border-radius:50%; transition:.2s;
    }
    .switch input:checked + .slider{ background:#5ee1a2; border-color:#5ee1a2; }
    .switch input:checked + .slider:before{ transform:translateX(22px); background:#052014; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="brand" style="font-weight:900">SerCucTech ‚Äì Admin</div>
    <div class="pill"><span>Stato:</span><b id="status">üîí Bloccato</b></div>
    <div class="btns">
      <a class="btn sec" href="index.html">üè† Home</a>
      <a class="btn sec" href="pubblica.html">üì£ Pubblica</a>
      <button class="btn sec" id="logoutBtn" style="display:none;">üö™ Esci</button>
    </div>
  </div>

  <!-- LOCK CARD -->
  <div class="card" id="lockCard">
    <h2>Area riservata</h2>

    <div class="mut" id="adminIntro">
      <b>SerCucTech.</b><br>
      Con i suoi servizi ti aiuta a gestire qualsiasi genere di problematiche in modo semplice,<br>
      creando anche App personalizzate.
    </div>

    <div class="hr"></div>

    <div class="mut">
      Tocca le parole nella frase per accedere (modalit√† riservata).
    </div>
    <div class="btns" style="margin-top:10px">
      <button class="btn sec" id="resetTapBtn">Reset</button>
    </div>

    <div class="hr"></div>

    <!-- DEVICE CODE ALWAYS VISIBLE -->
    <h3>Codice dispositivo</h3>
    <div class="mut">Questo codice identifica questo telefono. Serve per autorizzarlo da un altro dispositivo gi√† sbloccato.</div>
    <div class="mono" id="myDeviceCodeBox" style="word-break:break-all;margin-top:8px;"></div>
    <div class="btns" style="margin-top:10px">
      <button class="btn sec" id="copyMyDeviceCodeBtn">üìã Copia codice</button>
    </div>

    <div class="hr"></div>
    <div class="mut" id="lockInfo"></div>
  </div>

  <!-- ADMIN UI -->
  <div class="grid" id="adminUI" style="display:none;">

    <!-- SETTINGS: AUTO-VOICE GLOBAL TOGGLE -->
    <div class="card">
      <h2>Impostazioni</h2>

      <div class="toggleRow">
        <div>
          <b>Auto-Voce (globale)</b>
          <div class="mut">Se ON: alla prima apertura di una vetrina prova a partire la voce automaticamente.</div>
        </div>

        <label class="switch" title="Auto-Voce">
          <input type="checkbox" id="autoVoiceGlobalToggle">
          <span class="slider"></span>
        </label>
      </div>

      <div class="mut mono" id="autoVoiceGlobalOut" style="white-space:pre-wrap;margin-top:10px;"></div>
    </div>

    <!-- DEVICES -->
    <div class="card">
      <h2>Dispositivi autorizzati</h2>
      <div class="mut">Sblocco valido 24 ore su questo dispositivo. Puoi autorizzare altri dispositivi incollando il loro codice qui sotto.</div>

      <div class="hr"></div>

      <label>Incolla codice dispositivo da autorizzare</label>
      <textarea id="addDeviceCodeInput" placeholder="Incolla qui il codice del nuovo telefono..."></textarea>
      <div class="btns">
        <button class="btn ok" id="addDeviceBtn">‚ûï Aggiungi dispositivo</button>
        <button class="btn danger" id="listDevicesBtn">üìÑ Mostra lista</button>
      </div>
      <div class="mut mono" id="devicesListBox" style="white-space:pre-wrap;margin-top:10px;"></div>
    </div>

    <!-- AUDIO RESET FIRST TIME -->
    <div class="card">
      <h2>Audio automatico (Reset ‚Äúprima volta‚Äù)</h2>
      <div class="mut">
        Ogni vetrina parla in automatico <b>solo la prima volta</b> su questo dispositivo.
        Qui puoi azzerare e rifare i test.
      </div>

      <div class="hr"></div>

      <label>ID vetrina (es: renzo11)</label>
      <input id="autoVoiceResetId" placeholder="es: renzo11" />

      <div class="btns" style="margin-top:10px">
        <button class="btn warn" id="resetOneAutoVoiceBtn">‚ôªÔ∏è Reset 1 vetrina</button>
        <button class="btn danger" id="resetAllAutoVoiceBtn">üß® Reset TUTTE le vetrine</button>
      </div>

      <div class="mut mono" id="autoVoiceResetOut" style="white-space:pre-wrap;margin-top:10px;"></div>
    </div>

    <!-- INDEX -->
    <div class="card">
      <h2>Index (data/index.json)</h2>
      <div class="mut">
        File indice: <span class="kbd">data/index.json</span><br>
        Vetrine: <span class="kbd">data/&lt;id&gt;.json</span> (es: <span class="kbd">data/renzo11.json</span>)
      </div>

      <div class="btns">
        <button class="btn sec" onclick="loadIndexFromRepo()">üì• Carica index dal repo</button>
        <button class="btn sec" onclick="document.getElementById('importIndex').click()">üìÇ Importa index.json</button>
        <button class="btn ok" onclick="downloadIndex()">‚¨áÔ∏è Scarica index.json</button>
      </div>

      <input id="importIndex" type="file" accept="application/json" class="hidden" />

      <div class="hr"></div>
      <div class="mut">
        Aggiornato: <b id="indexUpdated">‚Äî</b><br>
        Vetrine: <b id="indexCountV">0</b> ‚Ä¢ Gruppi: <b id="indexCountG">0</b>
      </div>
    </div>

    <!-- VETRINA -->
    <div class="card">
      <h2>Vetrina (data/&lt;id&gt;.json)</h2>

      <label>Seleziona vetrina</label>
      <select id="vSelect" onchange="loadSelectedVetrinaFile()">
        <option value="">‚Äî scegli ‚Äî</option>
      </select>

      <div class="btns">
        <button class="btn sec" onclick="loadSelectedVetrinaFile()">üì• Carica file vetrina</button>
        <button class="btn ok" onclick="downloadVetrina()">‚¨áÔ∏è Scarica &lt;id&gt;.json</button>
        <button class="btn warn" onclick="downloadBackupZip()">üß≥ Backup ZIP (JSON+media+files)</button>
        <button class="btn sec" onclick="openDuplicatePanel()">üß¨ Duplica (es: renzo11 ‚Üí renzo12)</button>
        <button class="btn danger" onclick="deleteVetrina()">üóëÔ∏è Elimina (da index)</button>
      </div>

      <div id="dupPanel" class="hidden" style="margin-top:12px; padding:10px; border:1px solid var(--b); border-radius:14px; background:#0c1530;">
        <div class="mut">
          Duplica crea un nuovo file <span class="kbd">data/&lt;nuovoId&gt;.json</span> e aggiorna anche <span class="kbd">data/index.json</span>.
        </div>
        <div class="row" style="display:grid;gap:10px;grid-template-columns:1fr; margin-top:10px;">
          <div>
            <label>Nuovo ID (solo lettere/numeri -)</label>
            <input id="dupNewId" placeholder="es: renzo12" />
          </div>
          <div>
            <label>Nuovo Titolo (opzionale)</label>
            <input id="dupNewTitle" placeholder="es: Vetrina Renzo 12" />
          </div>
        </div>
        <div class="btns">
          <button class="btn ok" onclick="duplicateCurrentVetrina()">‚úÖ Crea clone (in memoria)</button>
          <button class="btn sec" onclick="closeDuplicatePanel()">Chiudi</button>
        </div>
        <div class="mut" style="margin-top:8px;">
          Poi: scarica <b>index.json</b> e <b>&lt;nuovoId&gt;.json</b> e caricali su GitHub in <span class="kbd">/data/</span>.
        </div>
      </div>

      <div class="hr"></div>

      <h3>Crea nuova vetrina</h3>
      <label>ID (unico)</label>
      <div class="mut">Esempio: <span class="kbd">renzo11</span> ‚Üí file: <span class="kbd">data/renzo11.json</span></div>
      <input id="newId" placeholder="es: renzo11" />
      <label>Titolo</label>
      <input id="newTitle" placeholder="Titolo vetrina" />
      <label>Tags (virgola)</label>
      <input id="newTags" placeholder="commercio, documenti, video" />
      <div class="btns">
        <button class="btn ok" onclick="createVetrina()">‚ûï Crea vetrina</button>
      </div>

      <div class="hr"></div>

      <h3>Editor</h3>
      <div class="pill">Vetrina attiva: <b id="activeId">‚Äî</b></div>

      <label>Titolo</label>
      <input id="eTitle" />
      <label>Descrizione</label>
      <textarea id="eDesc"></textarea>

      <div class="row" style="display:grid;gap:10px;grid-template-columns:1fr;">
        <div>
          <label>Voce (lang)</label>
          <input id="eVoiceLang" value="it-IT" />
        </div>
        <div>
          <label>Voce (testo)</label>
          <input id="eVoiceText" placeholder="Testo letto dal telefono‚Ä¶" />
        </div>
      </div>

      <label>Tags (virgola)</label>
      <input id="eTags" />

      <div class="btns">
        <button class="btn ok" onclick="saveEdits()">üíæ Salva modifiche (in memoria)</button>
        <button class="btn warn" onclick="syncIndexFromVetrina()">üîÅ Aggiorna index (titolo/tags)</button>
      </div>
    </div>

    <!-- MEDIA -->
    <div class="card">
      <h2>Media (foto/video) ‚Äî URL + Upload multiplo + Riordino</h2>
      <div class="mut">Esempi: <span class="kbd">media/foto1.jpg</span> ‚Ä¢ <span class="kbd">media/tour.mp4</span></div>

      <h3>A) Aggiungi tramite URL</h3>
      <label>Tipo</label>
      <select id="mType">
        <option value="image">Immagine (.jpg/.png)</option>
        <option value="video">Video (.mp4)</option>
      </select>
      <label>Titolo</label>
      <input id="mTitle" placeholder="Foto entrata / Tour" />
      <label>URL (con estensione)</label>
      <input id="mUrl" placeholder="media/foto-entrata.jpg" />
      <label>Nota</label>
      <input id="mNote" placeholder="" />

      <div class="btns">
        <button class="btn ok" onclick="addMediaByUrl()">‚ûï Aggiungi URL</button>
        <button class="btn sec" onclick="renderMediaList()">üîÑ Aggiorna lista</button>
      </div>

      <div class="hr"></div>

      <h3>B) Upload multiplo (foto + video)</h3>
      <label>Seleziona file (MULTIPLO)</label>
      <input id="mFiles" type="file" multiple accept="image/*,video/*" />

      <div class="btns">
        <button class="btn ok" onclick="addMediaFromFiles()">‚ûï Aggiungi al JSON</button>
        <button class="btn warn" onclick="downloadMediaZip()">‚¨áÔ∏è Scarica ZIP media/‚Ä¶</button>
        <button class="btn sec" onclick="clearMediaQueue()">üßπ Svuota selezione</button>
      </div>

      <div class="list" id="mediaQueue"></div>

      <div class="hr"></div>

      <h3>Media presenti nella vetrina</h3>
      <div class="list" id="mediaList"></div>
    </div>

    <!-- FILES -->
    <div class="card">
      <h2>Files (PDF/TXT/ZIP) ‚Äî URL + Riordino</h2>
      <div class="mut">Esempi: <span class="kbd">files/manuale.pdf</span> ‚Ä¢ <span class="kbd">files/ocr-renzo11.txt</span></div>

      <h3>A) Aggiungi file tramite URL</h3>
      <label>Label</label>
      <input id="fLabel" placeholder="Manuale / Documento / Guida‚Ä¶" />
      <label>URL (con estensione)</label>
      <input id="fUrl" placeholder="files/manuale.pdf" />

      <div class="btns">
        <button class="btn ok" onclick="addFileByUrl()">‚ûï Aggiungi file</button>
        <button class="btn sec" onclick="renderFilesList()">üîÑ Aggiorna lista</button>
      </div>

      <div class="hr"></div>

      <h3>Files presenti nella vetrina</h3>
      <div class="list" id="filesList"></div>
    </div>

    <!-- OCR -->
    <div class="card">
      <h2>OCR (solo Admin)</h2>
      <div class="mut">Estrai testo da immagine ‚Üí scarica TXT ‚Üí carica in <span class="kbd">/files/</span> ‚Üí aggiungi al JSON.</div>

      <label>Lingua OCR</label>
      <select id="ocrLang">
        <option value="ita">Italiano (ita)</option>
        <option value="eng">Inglese (eng)</option>
        <option value="ukr">Ucraino (ukr)</option>
        <option value="deu">Tedesco (deu)</option>
        <option value="spa">Spagnolo (spa)</option>
        <option value="fra">Francese (fra)</option>
      </select>

      <label>Immagine per OCR</label>
      <input id="ocrFile" type="file" accept="image/*" />

      <div class="btns">
        <button class="btn ok" onclick="runOCR()">üß† Avvia OCR</button>
        <button class="btn sec" onclick="copyOCR()">üìã Copia testo</button>
        <button class="btn sec" onclick="speakOCR()">üîä Leggi testo</button>
        <button class="btn warn" onclick="downloadOCRtxt()">‚¨áÔ∏è Scarica TXT</button>
        <button class="btn warn" onclick="addOCRtoFiles()">‚ûï Aggiungi TXT in files[]</button>
        <button class="btn danger" onclick="clearOCR()">üßπ Pulisci</button>
      </div>

      <div style="margin-top:10px;">
        <div class="pill">Stato: <b id="ocrStatus">Pronto</b></div>
        <div style="margin-top:10px;" class="bar"><div id="ocrBar"></div></div>
      </div>

      <div class="row" style="display:grid;gap:10px;grid-template-columns:1fr; margin-top:12px;">
        <div>
          <div class="mut" style="margin-bottom:6px;">Anteprima</div>
          <img id="ocrPreview" class="preview" style="display:none;" alt="OCR preview">
          <div id="ocrNoPreview" class="mut">Nessuna immagine caricata.</div>
        </div>
        <div>
          <div class="mut" style="margin-bottom:6px;">Testo OCR</div>
          <textarea id="ocrText" placeholder="Testo estratto..." spellcheck="false"></textarea>
        </div>
      </div>
    </div>

    <!-- GROUPS -->
    <div class="card">
      <h2>Gruppi (opzionale)</h2>
      <label>Seleziona gruppo</label>
      <select id="gSelect" onchange="loadGroupIntoEditor()">
        <option value="">‚Äî scegli ‚Äî</option>
      </select>

      <label>Key gruppo (es: bazar)</label>
      <input id="gKey" placeholder="bazar" />
      <label>Titolo gruppo</label>
      <input id="gTitle" />
      <label>Descrizione gruppo</label>
      <textarea id="gDesc"></textarea>
      <label>IDs vetrine (virgola)</label>
      <input id="gItems" placeholder="renzo11, renzo12" />

      <div class="btns">
        <button class="btn ok" onclick="saveGroup()">üíæ Salva gruppo</button>
        <button class="btn danger" onclick="deleteGroup()">üóëÔ∏è Elimina gruppo</button>
        <button class="btn ok" onclick="downloadIndex()">‚¨áÔ∏è Scarica index.json</button>
      </div>

      <div class="mut" style="margin-top:10px;">
        Link pubblico gruppo: <span class="kbd">vetrina.html?group=bazar</span>
      </div>
    </div>

  </div>
</div>

<script src="app.js"></script>
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./service-worker.js").catch(console.error);
}

/* ================= STATE ================= */
let secretProgress = 0;
const SENTENCE = "SerCucTech. Con i suoi servizi ti aiuta a gestire qualsiasi genere di problematiche in modo semplice creando anche App personalizzate.";

let indexDB = { meta:{version:1, updatedAt:null}, groups:{}, vetrine:{} };
let activeId = "";
let activeVetrina = null;
let mediaQueue = [];
let ocrImage = null;
let ocrLastTxtFilename = "";

/* ================= LOCK UI ================= */
function normalizeWord(w){
  return (w||"").toLowerCase().replace(/[^a-z√†√®√©√¨√≤√π0-9_-]/g,"");
}
function renderClickableSentence(){
  const intro = document.getElementById("adminIntro");
  const p = document.createElement("div");
  p.className = "mut";
  p.style.marginTop = "12px";
  p.style.userSelect = "none";

  const words = SENTENCE.split(/\s+/);
  words.forEach((w, i)=>{
    const span = document.createElement("span");
    span.textContent = w + (i === words.length - 1 ? "" : " ");
    span.style.cursor = "pointer";
    span.onclick = ()=> onWordTap(w);
    p.appendChild(span);
  });

  intro.parentNode.insertBefore(p, intro.nextSibling);
}
function onWordTap(word){
  if (window.SerCucTech.isAdminSessionValid()) return;

  const clean = normalizeWord(word);
  const expected = window.SerCucTech.UNLOCK_WORDS[secretProgress];
  if(clean.includes(expected)){
    secretProgress++;
    if(secretProgress >= window.SerCucTech.UNLOCK_WORDS.length){
      window.SerCucTech.adminUnlockSuccess();
      showUnlockedUI();
    }
  } else {
    secretProgress = 0;
  }
}
function showUnlockedUI(){
  document.getElementById("status").textContent = "‚úÖ Sbloccato (24h)";
  document.getElementById("lockCard").style.display = "none";
  document.getElementById("adminUI").style.display = "grid";
  document.getElementById("logoutBtn").style.display = "inline-flex";

  initDevicesUI();
  initAutoVoiceResetUI();
  initAutoVoiceGlobalToggleUI();

  loadIndexFromRepo().catch(()=>{});
}
function showLockedUI(){
  document.getElementById("status").textContent = "üîí Bloccato";
  document.getElementById("lockCard").style.display = "block";
  document.getElementById("adminUI").style.display = "none";
  document.getElementById("logoutBtn").style.display = "none";

  try{
    const raw = localStorage.getItem("sercuctech_admin_session_v1");
    if(raw){
      const s = JSON.parse(raw);
      if(s && s.exp){
        const d = new Date(s.exp);
        document.getElementById("lockInfo").textContent = "Se eri gi√† sbloccato, la sessione scade: " + d.toLocaleString();
      }else{
        document.getElementById("lockInfo").textContent = "";
      }
    }else{
      document.getElementById("lockInfo").textContent = "";
    }
  }catch(e){
    document.getElementById("lockInfo").textContent = "";
  }
}
document.getElementById("resetTapBtn").onclick = ()=>{ secretProgress = 0; };
document.getElementById("logoutBtn").onclick = ()=>{
  window.SerCucTech.clearAdminSession();
  secretProgress = 0;
  showLockedUI();
};

/* ================= DEVICE CODE UI ================= */
function initDeviceCodeBox(){
  const myCode = window.SerCucTech.getMyDeviceShareCode();
  document.getElementById("myDeviceCodeBox").textContent = myCode;

  document.getElementById("copyMyDeviceCodeBtn").onclick = async ()=>{
    try{
      await navigator.clipboard.writeText(myCode);
      alert("‚úÖ Codice copiato");
    }catch(e){
      alert("‚ö†Ô∏è Copia non permessa: tieni premuto sul codice e copia manualmente.");
    }
  };
}
function initDevicesUI(){
  const addBtn = document.getElementById("addDeviceBtn");
  const addInput = document.getElementById("addDeviceCodeInput");
  const listBtn = document.getElementById("listDevicesBtn");
  const listBox = document.getElementById("devicesListBox");

  addBtn.onclick = ()=>{
    const obj = window.SerCucTech.parseDeviceShareCode(addInput.value);
    if(!obj){
      listBox.textContent = "‚ùå Codice non valido.";
      return;
    }
    window.SerCucTech.addAllowedDevice(obj.deviceId);
    listBox.textContent = "‚úÖ Dispositivo aggiunto:\n- " + obj.deviceId;
    addInput.value = "";
  };

  listBtn.onclick = ()=>{
    const arr = window.SerCucTech.loadAllowedDevices();
    listBox.textContent = "Dispositivi autorizzati:\n- " + arr.join("\n- ");
  };
}

/* ================= AUTO-VOICE GLOBAL TOGGLE UI ================= */
function initAutoVoiceGlobalToggleUI(){
  const t = document.getElementById("autoVoiceGlobalToggle");
  const out = document.getElementById("autoVoiceGlobalOut");
  if(!t || !out) return;

  // default ON se non esiste
  t.checked = window.SerCucTech.isAutoVoiceEnabled();
  out.textContent = t.checked ? "‚úÖ Auto-Voce: ON" : "‚õî Auto-Voce: OFF";

  t.onchange = ()=>{
    window.SerCucTech.setAutoVoiceEnabled(!!t.checked);
    out.textContent = t.checked ? "‚úÖ Auto-Voce: ON" : "‚õî Auto-Voce: OFF";
  };
}

/* ================= AUTO-VOICE RESET UI ================= */
function initAutoVoiceResetUI(){
  const out = document.getElementById("autoVoiceResetOut");
  const oneBtn = document.getElementById("resetOneAutoVoiceBtn");
  const allBtn = document.getElementById("resetAllAutoVoiceBtn");
  const inp = document.getElementById("autoVoiceResetId");

  if(!out || !oneBtn || !allBtn || !inp) return;

  const keyFor = (id)=> "sercuctech_autovoice_done_" + window.SerCucTech.sanitizeId(id);

  oneBtn.onclick = ()=>{
    const id = window.SerCucTech.sanitizeId(inp.value);
    if(!id){
      out.textContent = "‚ùå Inserisci un ID valido (es: renzo11).";
      return;
    }
    localStorage.removeItem(keyFor(id));
    out.textContent = "‚úÖ Reset fatto per: " + id + "\nOra apri: vetrina.html?id=" + id + " e riparte (prima volta).";
    inp.value = "";
  };

  allBtn.onclick = ()=>{
    if(!confirm("Reset di TUTTE le vetrine su questo dispositivo?")) return;

    let removed = 0;
    const prefix = "sercuctech_autovoice_done_";
    for(let i = localStorage.length - 1; i >= 0; i--){
      const k = localStorage.key(i);
      if(k && k.startsWith(prefix)){
        localStorage.removeItem(k);
        removed++;
      }
    }
    out.textContent = "‚úÖ Reset totale completato.\nChiavi rimosse: " + removed + "\nOra la prossima apertura di una vetrina far√† partire la voce (prima volta).";
  };
}

/* ================= INDEX helpers ================= */
function normalizeIndex(data){
  indexDB = (data && typeof data==="object") ? data : {};
  indexDB.meta = indexDB.meta || {version:1, updatedAt:null};
  indexDB.groups = indexDB.groups || {};
  indexDB.vetrine = indexDB.vetrine || {};
  indexDB.meta.version = 1;
}
function refreshIndexUI(){
  document.getElementById("indexUpdated").textContent = indexDB.meta.updatedAt || "‚Äî";
  document.getElementById("indexCountV").textContent = Object.keys(indexDB.vetrine).length;
  document.getElementById("indexCountG").textContent = Object.keys(indexDB.groups).length;
}
function refreshSelects(){
  const vSel = document.getElementById("vSelect");
  const gSel = document.getElementById("gSelect");
  const prevV = vSel.value;
  const prevG = gSel.value;

  vSel.innerHTML = `<option value="">‚Äî scegli ‚Äî</option>`;
  Object.keys(indexDB.vetrine).sort().forEach(id=>{
    const rec = indexDB.vetrine[id];
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = `${id} ‚Äî ${rec.title || ""}`;
    vSel.appendChild(opt);
  });

  gSel.innerHTML = `<option value="">‚Äî scegli ‚Äî</option>`;
  Object.keys(indexDB.groups).sort().forEach(k=>{
    const g = indexDB.groups[k];
    const opt = document.createElement("option");
    opt.value = k;
    opt.textContent = `${k} ‚Äî ${g.title || ""}`;
    gSel.appendChild(opt);
  });

  if(prevV && indexDB.vetrine[prevV]) vSel.value = prevV;
  if(prevG && indexDB.groups[prevG]) gSel.value = prevG;
}
async function loadIndexFromRepo(){
  const idx = await window.SerCucTech.loadIndexSmart();
  normalizeIndex(idx);
  refreshIndexUI();
  refreshSelects();
}
function dlJSON(obj, filename){
  const blob = new Blob([JSON.stringify(obj,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
}
function downloadIndex(){
  indexDB.meta.updatedAt = window.SerCucTech.nowISO();
  refreshIndexUI();
  dlJSON(indexDB, "index.json");
}
document.getElementById("importIndex").addEventListener("change", async (ev)=>{
  const f = ev.target.files && ev.target.files[0];
  if(!f) return;
  try{
    normalizeIndex(JSON.parse(await f.text()));
    refreshIndexUI();
    refreshSelects();
    alert("‚úÖ Index importato");
  }catch(e){
    alert("‚ùå index.json non valido");
  }finally{
    ev.target.value = "";
  }
});

/* ================= VETRINA editing ================= */
function normalizeVetrina(v, id){
  const o = (v && typeof v==="object") ? v : {};
  o.id = o.id || id;
  o.title = o.title || "";
  o.description = o.description || "";
  o.voice = o.voice || {lang:"it-IT", text:""};
  o.tags = Array.isArray(o.tags) ? o.tags : [];
  o.media = Array.isArray(o.media) ? o.media : [];
  o.files = Array.isArray(o.files) ? o.files : [];
  o.createdAt = o.createdAt || window.SerCucTech.nowISO();
  o.updatedAt = o.updatedAt || window.SerCucTech.nowISO();
  return o;
}
function fillEditor(){
  document.getElementById("activeId").textContent = activeId || "‚Äî";
  if(!activeVetrina) return;
  document.getElementById("eTitle").value = activeVetrina.title || "";
  document.getElementById("eDesc").value = activeVetrina.description || "";
  document.getElementById("eVoiceLang").value = (activeVetrina.voice && activeVetrina.voice.lang) ? activeVetrina.voice.lang : "it-IT";
  document.getElementById("eVoiceText").value = (activeVetrina.voice && activeVetrina.voice.text) ? activeVetrina.voice.text : "";
  document.getElementById("eTags").value = (activeVetrina.tags || []).join(", ");
}

async function loadSelectedVetrinaFile(){
  const id = document.getElementById("vSelect").value;
  if(!id){ alert("Seleziona una vetrina"); return; }
  const rec = indexDB.vetrine[id];
  if(!rec || !rec.file){ alert("Index: manca 'file'"); return; }
  try{
    const v = await (await fetch(rec.file + "?t=" + Date.now(), {cache:"no-store"})).json();
    activeId = id;
    activeVetrina = normalizeVetrina(v, id);
    fillEditor();
    renderMediaList();
    renderFilesList();
    clearMediaQueue();
    alert("‚úÖ Vetrina caricata");
  }catch(e){
    alert("‚ùå Non riesco a caricare " + rec.file);
  }
}

function saveEdits(){
  if(!activeVetrina){ alert("Carica una vetrina"); return; }
  activeVetrina.title = (document.getElementById("eTitle").value||"").trim();
  activeVetrina.description = (document.getElementById("eDesc").value||"").trim();
  activeVetrina.voice = activeVetrina.voice || {lang:"it-IT", text:""};
  activeVetrina.voice.lang = (document.getElementById("eVoiceLang").value||"it-IT").trim();
  activeVetrina.voice.text = (document.getElementById("eVoiceText").value||"").trim();
  activeVetrina.tags = window.SerCucTech.splitCSV(document.getElementById("eTags").value);
  activeVetrina.updatedAt = window.SerCucTech.nowISO();
  alert("‚úÖ Salvato in memoria. Ora scarica " + activeId + ".json");
}

function syncIndexFromVetrina(){
  if(!activeVetrina || !activeId){ alert("Carica una vetrina"); return; }
  if(!indexDB.vetrine[activeId]){ alert("Non presente in index"); return; }
  indexDB.vetrine[activeId].title = activeVetrina.title || activeId;
  indexDB.vetrine[activeId].tags = activeVetrina.tags || [];
  indexDB.vetrine[activeId].updatedAt = window.SerCucTech.nowISO();
  indexDB.meta.updatedAt = window.SerCucTech.nowISO();
  refreshIndexUI();
  refreshSelects();
  alert("‚úÖ Index aggiornato. Scarica index.json");
}

function downloadVetrina(){
  if(!activeVetrina || !activeId){ alert("Carica una vetrina"); return; }
  dlJSON(activeVetrina, `${activeId}.json`);
}

function createVetrina(){
  const id = window.SerCucTech.sanitizeId(document.getElementById("newId").value);
  if(!id){ alert("ID non valido"); return; }
  if(indexDB.vetrine[id]){ alert("ID gi√† esistente"); return; }

  const title = (document.getElementById("newTitle").value||"").trim() || id;
  const tags = window.SerCucTech.splitCSV(document.getElementById("newTags").value);

  indexDB.vetrine[id] = { id, title, file:`data/${id}.json`, tags, updatedAt: window.SerCucTech.nowISO() };
  indexDB.meta.updatedAt = window.SerCucTech.nowISO();
  refreshIndexUI();
  refreshSelects();

  activeId = id;
  activeVetrina = normalizeVetrina({ id, title, tags, media:[], files:[] }, id);
  fillEditor();
  renderMediaList();
  renderFilesList();
  clearMediaQueue();

  alert("‚úÖ Creata. Ora scarica: index.json e " + id + ".json e caricali su GitHub in /data/");
}

function deleteVetrina(){
  const id = document.getElementById("vSelect").value || activeId;
  if(!id){ alert("Seleziona una vetrina"); return; }
  if(!indexDB.vetrine[id]){ alert("Non trovata in index"); return; }
  if(!confirm("Eliminare vetrina " + id + " ? (poi cancella anche data/"+id+".json dal repo)")) return;

  Object.keys(indexDB.groups).forEach(gk=>{
    const g = indexDB.groups[gk];
    if(Array.isArray(g.items)) g.items = g.items.filter(x => x !== id);
  });

  delete indexDB.vetrine[id];
  indexDB.meta.updatedAt = window.SerCucTech.nowISO();
  refreshIndexUI();
  refreshSelects();

  if(activeId === id){
    activeId = "";
    activeVetrina = null;
    fillEditor();
    document.getElementById("mediaList").innerHTML = "";
    document.getElementById("filesList").innerHTML = "";
    clearMediaQueue();
  }
  alert("üóëÔ∏è Rimossa da index. Scarica index.json e caricalo su GitHub. Poi cancella data/"+id+".json manualmente.");
}

/* ================= DUPLICA ================= */
function openDuplicatePanel(){
  if(!activeVetrina || !activeId){ alert("Carica una vetrina prima."); return; }
  document.getElementById("dupNewId").value = "";
  document.getElementById("dupNewTitle").value = "";
  document.getElementById("dupPanel").classList.remove("hidden");
}
function closeDuplicatePanel(){ document.getElementById("dupPanel").classList.add("hidden"); }
function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }

function duplicateCurrentVetrina(){
  if(!activeVetrina || !activeId){ alert("Carica una vetrina prima."); return; }
  const newId = window.SerCucTech.sanitizeId(document.getElementById("dupNewId").value);
  if(!newId){ alert("Nuovo ID non valido"); return; }
  if(indexDB.vetrine[newId]){ alert("ID gi√† esistente in index"); return; }
  const newTitle = (document.getElementById("dupNewTitle").value||"").trim();

  const cloned = deepClone(activeVetrina);
  cloned.id = newId;
  if(newTitle) cloned.title = newTitle;
  cloned.createdAt = window.SerCucTech.nowISO();
  cloned.updatedAt = window.SerCucTech.nowISO();

  indexDB.vetrine[newId] = {
    id: newId,
    title: cloned.title || newId,
    file: `data/${newId}.json`,
    tags: cloned.tags || [],
    updatedAt: window.SerCucTech.nowISO()
  };
  indexDB.meta.updatedAt = window.SerCucTech.nowISO();

  activeId = newId;
  activeVetrina = cloned;

  refreshIndexUI();
  refreshSelects();
  fillEditor();
  renderMediaList();
  renderFilesList();
  closeDuplicatePanel();

  alert("‚úÖ Clone creato IN MEMORIA. Ora scarica: index.json e " + newId + ".json e caricali su GitHub in /data/");
}

/* ======= (MEDIA/FILES/OCR/GROUPS) =======
   Per non allungare oltre, qui restano IDENTICI al file che ti ho dato prima.
   Se vuoi che te li reinserisca anche qui dentro, dimmelo e te lo invio ‚Äúsuper-integrale‚Äù in un unico blocco.
*/
</script>
</body>
</html>
