<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SerCucTech Admin ‚Äì Vetrine (Index + File)</title>
  <style>
    :root { --bg:#0b1220; --card:#111b2e; --txt:#e8eefc; --mut:#a9b8dd; --acc:#5ee1a2; --warn:#ffcc66; --danger:#ff6b6b; }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:linear-gradient(180deg,#081024,#0b1220); color:var(--txt); }
    .wrap { max-width:1100px; margin:0 auto; padding:18px; }
    .top { display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .brand { font-weight:800; letter-spacing:.3px; }
    .pill { display:inline-flex; gap:8px; align-items:center; padding:8px 12px; border-radius:999px; background:#0f1a31; border:1px solid #1b2a4f; color:var(--mut); font-size:13px; }
    .grid { display:grid; grid-template-columns:1fr; gap:14px; margin-top:14px; }
    @media (min-width: 900px){ .grid { grid-template-columns: 1fr 1fr; } }
    .card { background:rgba(17,27,46,.92); border:1px solid #1b2a4f; border-radius:16px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.22); }
    h2 { margin:0 0 10px 0; font-size:18px; }
    h3 { margin:14px 0 8px 0; font-size:15px; color:var(--mut); font-weight:700; }
    label { display:block; margin:10px 0 6px; color:var(--mut); font-size:13px; }
    input, textarea, select { width:100%; box-sizing:border-box; padding:10px 12px; border-radius:12px; border:1px solid #22345f; background:#0f1830; color:var(--txt); outline:none; }
    textarea { min-height:88px; resize:vertical; }
    .row { display:grid; gap:10px; grid-template-columns:1fr; }
    @media (min-width: 600px){ .row { grid-template-columns: 1fr 1fr; } }
    .btns { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button { cursor:pointer; border:0; padding:10px 14px; border-radius:12px; font-weight:800; }
    .ok { background:var(--acc); color:#052014; }
    .sec { background:#22345f; color:var(--txt); }
    .warn { background:var(--warn); color:#231a06; }
    .danger { background:var(--danger); color:#2b0909; }
    .mini { font-size:12px; color:var(--mut); line-height:1.35; }
    .list { display:grid; gap:8px; margin-top:10px; }
    .item { display:flex; gap:10px; align-items:flex-start; justify-content:space-between; padding:10px; border-radius:14px; border:1px solid #22345f; background:#0c1530; }
    .item .meta { flex:1; }
    .hr { height:1px; background:#1b2a4f; margin:14px 0; }
    .hidden { display:none !important; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas; background:#0f1a31; border:1px solid #22345f; padding:2px 8px; border-radius:10px; color:var(--mut); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">SerCucTech ‚Äì Admin Vetrine (Index + File)</div>
      <div class="pill"><span>Stato:</span><b id="status">üîí Bloccato</b></div>
    </div>

    <!-- Lock -->
    <div class="card" id="lockCard">
      <h2>Accesso</h2>
      <div class="mini">
        Tocca due parole *in sequenza* dentro questa frase per sbloccare l‚Äôadmin.<br>
        Frase: <span id="secretSentence"></span>
      </div>
      <div class="mini" style="margin-top:10px;">
        Segreto: <span class="kbd">LUCE</span> poi <span class="kbd">PORTA</span>
      </div>
      <div class="btns"><button class="sec" onclick="resetLock()">Reset</button></div>
    </div>

    <div class="grid hidden" id="adminUI">

      <!-- INDEX -->
      <div class="card">
        <h2>Index (data/index.json)</h2>
        <div class="mini">
          Questo file contiene la lista vetrine e gruppi. Le singole vetrine stanno in <span class="kbd">data/&lt;id&gt;.json</span>.
        </div>

        <div class="btns">
          <button class="sec" onclick="loadIndexFromRepo()">üì• Carica index dal repo</button>
          <button class="sec" onclick="document.getElementById('importIndex').click()">üìÇ Importa index.json</button>
          <button class="ok" onclick="exportIndex()">‚¨áÔ∏è Scarica index.json</button>
        </div>

        <input id="importIndex" type="file" accept="application/json" class="hidden" />
        <div class="hr"></div>
        <div class="mini">
          Ultimo aggiornamento index: <b id="indexUpdated">‚Äî</b><br>
          Vetrine in index: <b id="indexCountV">0</b> ‚Ä¢ Gruppi: <b id="indexCountG">0</b>
        </div>
      </div>

      <!-- VETRINE -->
      <div class="card">
        <h2>Vetrine</h2>

        <h3>Seleziona vetrina</h3>
        <select id="vSelect" onchange="loadSelectedVetrinaFile()">
          <option value="">‚Äî scegli ‚Äî</option>
        </select>

        <div class="btns">
          <button class="sec" onclick="loadSelectedVetrinaFile()">üì• Carica file vetrina</button>
          <button class="ok" onclick="downloadVetrinaFile()">‚¨áÔ∏è Scarica &lt;id&gt;.json</button>
          <button class="danger" onclick="deleteVetrina()">üóëÔ∏è Elimina vetrina</button>
        </div>

        <div class="hr"></div>

        <h3>Crea nuova vetrina</h3>
        <label>ID (unico)</label>
        <input id="newId" placeholder="es: scalvini10" />
        <label>Titolo</label>
        <input id="newTitle" placeholder="Titolo vetrina" />
        <label>Tags (virgola)</label>
        <input id="newTags" placeholder="casa, documenti" />

        <div class="btns">
          <button class="ok" onclick="createVetrina()">‚ûï Crea vetrina</button>
        </div>

        <div class="hr"></div>

        <h3>Editor vetrina (file data/&lt;id&gt;.json)</h3>
        <div class="pill">Vetrina attiva: <b id="activeId">‚Äî</b></div>

        <label>Titolo</label>
        <input id="eTitle" />
        <label>Descrizione</label>
        <textarea id="eDesc"></textarea>

        <div class="row">
          <div>
            <label>Voce lang</label>
            <input id="eVoiceLang" value="it-IT" />
          </div>
          <div>
            <label>Voce testo</label>
            <input id="eVoiceText" />
          </div>
        </div>

        <label>Tags (virgola)</label>
        <input id="eTags" />

        <div class="btns">
          <button class="ok" onclick="saveEdits()">üíæ Salva modifiche (in memoria)</button>
          <button class="warn" onclick="syncIndexFromVetrina()">üîÅ Aggiorna index (titolo/tags)</button>
        </div>

        <div class="mini" style="margin-top:10px;">
          Ricorda: dopo aver modificato, scarica <b>index.json</b> e <b>&lt;id&gt;.json</b> e ricaricali su GitHub.
        </div>
      </div>

      <!-- MEDIA -->
      <div class="card">
        <h2>Media (immagini/video)</h2>
        <div class="mini">Aggiungi URL a media gi√† caricati nel repo (o link diretti).</div>

        <div class="row">
          <div>
            <label>Tipo</label>
            <select id="mType">
              <option value="image">Immagine</option>
              <option value="video">Video</option>
            </select>
          </div>
          <div>
            <label>Titolo</label>
            <input id="mTitle" placeholder="Foto 1 / Tour" />
          </div>
        </div>

        <label>URL</label>
        <input id="mUrl" placeholder="media/file.jpg oppure https://..." />
        <label>Nota</label>
        <input id="mNote" placeholder="" />

        <div class="btns">
          <button class="ok" onclick="addMedia()">‚ûï Aggiungi</button>
          <button class="sec" onclick="renderMediaList()">üîÑ Aggiorna lista</button>
        </div>

        <div class="list" id="mediaList"></div>
      </div>

      <!-- GROUPS -->
      <div class="card">
        <h2>Gruppi</h2>

        <label>Seleziona gruppo</label>
        <select id="gSelect" onchange="loadGroupIntoEditor()">
          <option value="">‚Äî scegli ‚Äî</option>
        </select>

        <label>Key gruppo</label>
        <input id="gKey" placeholder="scalvini" />
        <label>Titolo gruppo</label>
        <input id="gTitle" />
        <label>Descrizione gruppo</label>
        <textarea id="gDesc"></textarea>
        <label>IDs vetrine (virgola)</label>
        <input id="gItems" placeholder="scalvini10, altroId" />

        <div class="btns">
          <button class="ok" onclick="saveGroup()">üíæ Salva gruppo</button>
          <button class="danger" onclick="deleteGroup()">üóëÔ∏è Elimina gruppo</button>
        </div>

        <div class="mini" style="margin-top:10px;">
          Pubblico gruppo: <span class="kbd">vetrina.html?group=scalvini</span>
        </div>
      </div>

    </div>
  </div>

<script>
/* ===== CONFIG ===== */
const INDEX_PATH = "data/index.json";
const SECRET_WORDS = ["LUCE","PORTA"];
const SENTENCE = "Per entrare nell'area tecnica tocca LUCE poi PORTA nella frase.";

/* ===== STATE ===== */
let unlocked = false;
let secretProgress = 0;

let indexDB = { meta:{version:1, updatedAt:null}, groups:{}, vetrine:{} };
let activeId = "";
let activeVetrina = null; // contenuto data/<id>.json

/* ===== UTILS ===== */
function nowISO(){
  const d = new Date();
  const pad = n => String(n).padStart(2,"0");
  const offMin = -d.getTimezoneOffset();
  const sign = offMin >= 0 ? "+" : "-";
  const hh = pad(Math.floor(Math.abs(offMin)/60));
  const mm = pad(Math.abs(offMin)%60);
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}${sign}${hh}:${mm}`;
}
function sanitizeId(s){
  return (s||"").trim().toLowerCase().replace(/\s+/g,"").replace(/[^a-z0-9_-]/g,"");
}
function splitCSV(s){
  return (s||"").split(",").map(x=>x.trim()).filter(Boolean);
}
function escapeHTML(s){
  return String(s||"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function dlJSON(obj, filename){
  const blob = new Blob([JSON.stringify(obj,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
}
function setStatus(txt){ document.getElementById("status").textContent = txt; }

/* ===== LOCK ===== */
function normalizeWord(w){ return (w||"").toUpperCase().replace(/[^\p{L}]/gu,""); }
function renderSecretSentence(){
  const el = document.getElementById("secretSentence");
  el.innerHTML = "";
  SENTENCE.split(" ").forEach((w,i)=>{
    const span = document.createElement("span");
    span.textContent = w + (i === SENTENCE.split(" ").length-1 ? "" : " ");
    span.style.cursor = "pointer";
    span.style.userSelect = "none";
    const clean = normalizeWord(w);
    span.style.fontWeight = (clean==="LUCE"||clean==="PORTA") ? "900" : "600";
    span.onclick = ()=> secretClick(w);
    el.appendChild(span);
  });
}
function secretClick(w){
  if(unlocked) return;
  const clean = normalizeWord(w);
  const expected = SECRET_WORDS[secretProgress];
  if(clean === expected){
    secretProgress++;
    if(secretProgress >= SECRET_WORDS.length) unlockAdmin();
  } else {
    secretProgress = 0;
  }
}
function resetLock(){ secretProgress=0; setStatus("üîí Bloccato"); }
function unlockAdmin(){
  unlocked = true;
  setStatus("‚úÖ Sbloccato");
  document.getElementById("lockCard").classList.add("hidden");
  document.getElementById("adminUI").classList.remove("hidden");
}

/* ===== INDEX LOAD/IMPORT/EXPORT ===== */
async function loadIndexFromRepo(){
  try{
    const res = await fetch(INDEX_PATH + "?t=" + Date.now(), {cache:"no-store"});
    if(!res.ok) throw new Error(res.status);
    const data = await res.json();
    normalizeIndex(data);
    refreshIndexUI();
    refreshSelects();
    alert("‚úÖ Index caricato");
  }catch(e){
    console.error(e);
    alert("‚ùå Non trovo data/index.json. Devi crearlo (ti ho dato il file pronto).");
  }
}
function normalizeIndex(data){
  indexDB = (data && typeof data==="object") ? data : {};
  indexDB.meta = indexDB.meta || {version:1, updatedAt:null};
  indexDB.groups = indexDB.groups || {};
  indexDB.vetrine = indexDB.vetrine || {};
  indexDB.meta.version = 1;
}
function refreshIndexUI(){
  document.getElementById("indexUpdated").textContent = indexDB.meta.updatedAt || "‚Äî";
  document.getElementById("indexCountV").textContent = Object.keys(indexDB.vetrine).length;
  document.getElementById("indexCountG").textContent = Object.keys(indexDB.groups).length;
}
function exportIndex(){
  indexDB.meta.updatedAt = nowISO();
  refreshIndexUI();
  dlJSON(indexDB, "index.json");
}
document.getElementById("importIndex").addEventListener("change", async (ev)=>{
  const f = ev.target.files && ev.target.files[0];
  if(!f) return;
  try{
    const txt = await f.text();
    const data = JSON.parse(txt);
    normalizeIndex(data);
    refreshIndexUI();
    refreshSelects();
    alert("‚úÖ Index importato");
  }catch(e){
    console.error(e);
    alert("‚ùå index.json non valido");
  }finally{
    ev.target.value = "";
  }
});

/* ===== SELECTS ===== */
function refreshSelects(){
  const vSel = document.getElementById("vSelect");
  const gSel = document.getElementById("gSelect");

  const prevV = vSel.value;
  const prevG = gSel.value;

  vSel.innerHTML = `<option value="">‚Äî scegli ‚Äî</option>`;
  Object.keys(indexDB.vetrine).sort().forEach(id=>{
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = `${id} ‚Äî ${indexDB.vetrine[id].title || ""}`;
    vSel.appendChild(opt);
  });

  gSel.innerHTML = `<option value="">‚Äî scegli ‚Äî</option>`;
  Object.keys(indexDB.groups).sort().forEach(k=>{
    const opt = document.createElement("option");
    opt.value = k;
    opt.textContent = `${k} ‚Äî ${indexDB.groups[k].title || ""}`;
    gSel.appendChild(opt);
  });

  if(prevV && indexDB.vetrine[prevV]) vSel.value = prevV;
  if(prevG && indexDB.groups[prevG]) gSel.value = prevG;
}

/* ===== VETRINA FILE LOAD/EDIT ===== */
async function loadSelectedVetrinaFile(){
  const id = document.getElementById("vSelect").value;
  if(!id){ alert("Seleziona una vetrina"); return; }
  if(!indexDB.vetrine[id] || !indexDB.vetrine[id].file){
    alert("Index non ha il campo file per questa vetrina.");
    return;
  }
  const filePath = indexDB.vetrine[id].file;

  try{
    const res = await fetch(filePath + "?t=" + Date.now(), {cache:"no-store"});
    if(!res.ok) throw new Error(res.status);
    const data = await res.json();

    activeId = id;
    activeVetrina = normalizeVetrina(data, id);
    fillEditor();
    renderMediaList();
    document.getElementById("activeId").textContent = activeId;
    alert("‚úÖ File vetrina caricato");
  }catch(e){
    console.error(e);
    alert("‚ùå Non riesco a caricare: " + filePath + " (controlla che esista)");
  }
}
function normalizeVetrina(v, id){
  const o = (v && typeof v==="object") ? v : {};
  o.id = o.id || id;
  o.title = o.title || "";
  o.description = o.description || "";
  o.voice = o.voice || {lang:"it-IT", text:""};
  o.tags = Array.isArray(o.tags) ? o.tags : [];
  o.media = Array.isArray(o.media) ? o.media : [];
  o.files = Array.isArray(o.files) ? o.files : [];
  o.createdAt = o.createdAt || nowISO();
  o.updatedAt = o.updatedAt || nowISO();
  return o;
}
function fillEditor(){
  if(!activeVetrina) return;
  document.getElementById("eTitle").value = activeVetrina.title || "";
  document.getElementById("eDesc").value = activeVetrina.description || "";
  document.getElementById("eVoiceLang").value = (activeVetrina.voice && activeVetrina.voice.lang) ? activeVetrina.voice.lang : "it-IT";
  document.getElementById("eVoiceText").value = (activeVetrina.voice && activeVetrina.voice.text) ? activeVetrina.voice.text : "";
  document.getElementById("eTags").value = (activeVetrina.tags || []).join(", ");
}
function saveEdits(){
  if(!activeVetrina){ alert("Carica prima una vetrina"); return; }
  activeVetrina.title = (document.getElementById("eTitle").value||"").trim();
  activeVetrina.description = (document.getElementById("eDesc").value||"").trim();
  activeVetrina.voice = activeVetrina.voice || {lang:"it-IT", text:""};
  activeVetrina.voice.lang = (document.getElementById("eVoiceLang").value||"it-IT").trim();
  activeVetrina.voice.text = (document.getElementById("eVoiceText").value||"").trim();
  activeVetrina.tags = splitCSV(document.getElementById("eTags").value);
  activeVetrina.updatedAt = nowISO();
  alert("‚úÖ Salvato in memoria. Ora scarica il file JSON.");
}
function syncIndexFromVetrina(){
  if(!activeVetrina || !activeId){ alert("Carica prima una vetrina"); return; }
  const rec = indexDB.vetrine[activeId];
  if(!rec){ alert("Questa vetrina non √® in index"); return; }
  rec.title = activeVetrina.title || rec.title || activeId;
  rec.tags = activeVetrina.tags || rec.tags || [];
  rec.updatedAt = nowISO();
  indexDB.meta.updatedAt = nowISO();
  refreshIndexUI();
  refreshSelects();
  alert("‚úÖ Index aggiornato (titolo/tags)");
}
function downloadVetrinaFile(){
  if(!activeVetrina || !activeId){ alert("Carica una vetrina"); return; }
  dlJSON(activeVetrina, `${activeId}.json`);
}

/* ===== CREATE/DELETE VETRINA ===== */
function createVetrina(){
  const id = sanitizeId(document.getElementById("newId").value);
  if(!id){ alert("ID non valido"); return; }
  if(indexDB.vetrine[id]){ alert("ID gi√† esistente"); return; }

  const title = (document.getElementById("newTitle").value||"").trim() || id;
  const tags = splitCSV(document.getElementById("newTags").value);

  // aggiorna index
  indexDB.vetrine[id] = {
    id,
    title,
    file: `data/${id}.json`,
    tags,
    updatedAt: nowISO()
  };
  indexDB.meta.updatedAt = nowISO();
  refreshIndexUI();
  refreshSelects();

  // crea vetrina in memoria
  activeId = id;
  activeVetrina = normalizeVetrina({
    id,
    title,
    description: "",
    voice: {lang:"it-IT", text:""},
    tags,
    media: [],
    files: [],
    createdAt: nowISO(),
    updatedAt: nowISO()
  }, id);

  fillEditor();
  renderMediaList();
  document.getElementById("activeId").textContent = activeId;

  alert("‚úÖ Creata. Ora scarica: index.json e " + id + ".json e caricali su GitHub in /data/");
}

function deleteVetrina(){
  const id = document.getElementById("vSelect").value || activeId;
  if(!id){ alert("Seleziona una vetrina"); return; }
  if(!indexDB.vetrine[id]){ alert("Non trovata in index"); return; }
  if(!confirm("Eliminare vetrina " + id + " ? (Ricorda: poi devi cancellare anche data/"+id+".json dal repo)")) return;

  // rimuovi da gruppi
  Object.keys(indexDB.groups).forEach(gk=>{
    const g = indexDB.groups[gk];
    if(Array.isArray(g.items)) g.items = g.items.filter(x => x !== id);
  });

  delete indexDB.vetrine[id];
  indexDB.meta.updatedAt = nowISO();
  refreshIndexUI();
  refreshSelects();

  if(activeId === id){
    activeId = "";
    activeVetrina = null;
    document.getElementById("activeId").textContent = "‚Äî";
    document.getElementById("mediaList").innerHTML = "";
  }

  alert("üóëÔ∏è Rimossa da index. Ora scarica index.json e caricalo su GitHub. Poi cancella anche il file data/"+id+".json manualmente.");
}

/* ===== MEDIA ===== */
function addMedia(){
  if(!activeVetrina){ alert("Carica una vetrina"); return; }
  const type = document.getElementById("mType").value;
  const url = (document.getElementById("mUrl").value||"").trim();
  const title = (document.getElementById("mTitle").value||"").trim();
  const note = (document.getElementById("mNote").value||"").trim();
  if(!url){ alert("Inserisci URL"); return; }

  activeVetrina.media.push({type,url,title,note});
  activeVetrina.updatedAt = nowISO();
  renderMediaList();

  document.getElementById("mUrl").value="";
  document.getElementById("mTitle").value="";
  document.getElementById("mNote").value="";
}
function renderMediaList(){
  const list = document.getElementById("mediaList");
  list.innerHTML = "";
  if(!activeVetrina){ list.innerHTML = `<div class="mini">Nessuna vetrina caricata.</div>`; return; }
  if(!activeVetrina.media || activeVetrina.media.length===0){
    list.innerHTML = `<div class="mini">Nessun media.</div>`; return;
  }

  activeVetrina.media.forEach((m,idx)=>{
    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `
      <div class="meta">
        <b>${m.type==="video"?"üé¨ Video":"üñºÔ∏è Immagine"} ${m.title? "‚Äî "+escapeHTML(m.title):""}</b>
        <div class="mini">${escapeHTML(m.url||"")}</div>
        ${m.note? `<div class="mini">üìù ${escapeHTML(m.note)}</div>` : ""}
      </div>
      <div><button class="danger" onclick="removeMedia(${idx})">Rimuovi</button></div>
    `;
    list.appendChild(row);
  });
}
function removeMedia(idx){
  if(!activeVetrina) return;
  activeVetrina.media.splice(idx,1);
  activeVetrina.updatedAt = nowISO();
  renderMediaList();
}

/* ===== GROUPS ===== */
function loadGroupIntoEditor(){
  const k = document.getElementById("gSelect").value;
  if(!k) return;
  const g = indexDB.groups[k];
  if(!g) return;
  document.getElementById("gKey").value = k;
  document.getElementById("gTitle").value = g.title || "";
  document.getElementById("gDesc").value = g.description || "";
  document.getElementById("gItems").value = (g.items||[]).join(", ");
}
function saveGroup(){
  const k = sanitizeId(document.getElementById("gKey").value);
  if(!k){ alert("Key gruppo non valida"); return; }
  indexDB.groups[k] = {
    title: (document.getElementById("gTitle").value||"").trim(),
    description: (document.getElementById("gDesc").value||"").trim(),
    items: splitCSV(document.getElementById("gItems").value).map(sanitizeId).filter(Boolean)
  };
  indexDB.meta.updatedAt = nowISO();
  refreshIndexUI();
  refreshSelects();
  alert("‚úÖ Gruppo salvato (scarica index.json)");
}
function deleteGroup(){
  const k = sanitizeId(document.getElementById("gKey").value);
  if(!k || !indexDB.groups[k]){ alert("Gruppo non trovato"); return; }
  if(!confirm("Eliminare gruppo " + k + " ?")) return;
  delete indexDB.groups[k];
  indexDB.meta.updatedAt = nowISO();
  refreshIndexUI();
  refreshSelects();
  alert("üóëÔ∏è Gruppo eliminato (scarica index.json)");
}

/* ===== INIT ===== */
renderSecretSentence();
</script>
</body>
</html>
