<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin SerCucTech</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="wrap">

<div class="card" id="login">
  <h3>Accesso Admin</h3>
  <input id="pin" type="password" placeholder="PIN">
  <button onclick="doLogin()">Entra</button>
  <div class="small">PIN default: <b>1234</b></div>
</div>

<div id="panel" class="hidden">

<div class="card">
  <h3>Modifica completa vetrina</h3>

  <div class="small">Seleziona una vetrina esistente per modificarla:</div>
  <select id="pickVetrina"></select>
  <button onclick="loadSelected()">Carica in modifica</button>

  <hr>

  <input id="vid" placeholder="ID vetrina (es: negozio1)">
  <input id="title" placeholder="Titolo">
  <textarea id="desc" placeholder="Descrizione"></textarea>

  <div class="small">Font e dimensioni</div>
  <select id="fontFamily">
    <option value="system-ui">System</option>
    <option value="Arial, sans-serif">Arial</option>
    <option value="'Times New Roman', serif">Times</option>
    <option value="Georgia, serif">Georgia</option>
    <option value="'Courier New', monospace">Courier</option>
  </select>
  <input type="number" id="baseFontSize" value="16" placeholder="Dimensione testo base (px)">
  <input type="number" id="titleSize" value="32" placeholder="Dimensione titolo (px)">
  <label>Colore titolo</label>
  <input type="color" id="titleColor" value="#ffffff">
  <label>Colore sfondo</label>
  <input type="color" id="bgColor" value="#0b1020">

  <div class="small">Sfondo immagine (opzionale)</div>
  <input type="file" id="bgImage" accept="image/*">
  <div class="small" id="bgInfo"></div>
  <button class="danger" onclick="removeBg()">Rimuovi sfondo immagine</button>

  <hr>

  <div class="small">Presentazione (testo + voce)</div>
  <textarea id="presentationText" placeholder="Testo che verr√† letto quando l‚Äôutente apre la vetrina..."></textarea>
  <select id="voiceLang">
    <option value="it-IT">Italiano (it-IT)</option>
    <option value="uk-UA">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ (uk-UA)</option>
    <option value="en-US">English (en-US)</option>
    <option value="ja-JP">Êó•Êú¨Ë™û (ja-JP)</option>
  </select>
  <input type="number" id="voiceRate" value="1" step="0.1" placeholder="Velocit√† voce (1 = normale)">
  <button onclick="testVoice()">‚ñ∂ Test voce</button>

  <hr>

  <h4>File (upload multiplo)</h4>
  <input type="file" id="files" multiple accept="image/*,video/*,application/pdf">
  <label style="display:flex;gap:10px;align-items:center">
    <input type="checkbox" id="doOcr" style="width:auto">
    <span class="small">OCR (solo immagini: JPG/PNG/WebP). PDF non supportato in OCR in questa versione.</span>
  </label>
  <button onclick="upload()">Carica file</button>
  <div class="small" id="ocrStatus"></div>

  <h4>File gi√† presenti</h4>
  <div id="fileList"></div>

  <div class="row">
    <button onclick="save()">Salva / Aggiorna</button>
    <button class="danger" onclick="deleteVetrina()">üóë Cancella vetrina</button>
  </div>

  <div class="card" style="background:#0b1224;margin-top:10px">
    <button onclick="exportVetrinaJson()">‚¨á Esporta JSON (pubblico)</button>
    <div class="small">Carica su GitHub in: <b>data/ID.json</b> (e se vuoi anteprima WhatsApp: <b>data/ID-cover.jpg</b>)</div>
  </div>
</div>

<div class="card">
  <h3>Vetrine create</h3>
  <div id="list"></div>
</div>

</div>
</div>

<!-- OCR: Tesseract.js (client-side) -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="app.js"></script>
<script>
initPin();

let uploaded = [];          // files della vetrina in modifica (array)
let currentBgData = null;   // base64 dello sfondo immagine

function doLogin(){
  if(pin.value === getPin()){
    login.style.display="none";
    panel.classList.remove("hidden");
    refreshAll();
  } else alert("PIN errato");
}

function refreshAll(){
  renderPicker();
  renderList();
  renderFiles();
  updateBgInfo();
}

function renderPicker(){
  const all = loadAll();
  const ids = Object.keys(all);
  pickVetrina.innerHTML = `<option value="">-- Seleziona --</option>` + ids.map(id=>`<option value="${id}">${id}</option>`).join("");
}

function loadSelected(){
  const id = pickVetrina.value;
  if(!id) return alert("Seleziona una vetrina");
  const all = loadAll();
  const v = all[id];
  if(!v) return alert("Non trovata");

  vid.value = id;
  title.value = v.title || "";
  desc.value = v.desc || "";
  fontFamily.value = v.fontFamily || "system-ui";
  baseFontSize.value = v.baseFontSize ?? 16;
  titleSize.value = v.titleSize ?? 32;
  titleColor.value = v.titleColor || "#ffffff";
  bgColor.value = v.bgColor || "#0b1020";

  presentationText.value = v.presentationText || "";
  voiceLang.value = (v.voice && v.voice.lang) ? v.voice.lang : "it-IT";
  voiceRate.value = (v.voice && v.voice.rate) ? v.voice.rate : 1;

  uploaded = Array.isArray(v.files) ? v.files.slice() : [];
  currentBgData = v.bgImage || null; // base64
  bgImage.value = ""; // reset input (browser non permette prefill)
  refreshAll();
  window.scrollTo({top:0,behavior:"smooth"});
}

async function upload(){
  const fl = [...files.files];
  if(!fl.length) return alert("Seleziona almeno un file");

  ocrStatus.textContent = "";

  // OCR opzionale (solo immagini)
  const wantOcr = doOcr.checked;

  for(const f of fl){
    const data = await toBase64(f);
    const item = { name:f.name, type:f.type, data };

    if(wantOcr && (f.type.startsWith("image/"))){
      // OCR su immagine
      try{
        ocrStatus.textContent = `OCR in corso: ${f.name} ...`;
        const { data: out } = await Tesseract.recognize(data, "eng"); // OCR engine (base). Se vuoi italiano/ukr/ja, si pu√≤ estendere.
        item.ocrText = (out && out.text) ? out.text.trim() : "";
      }catch(e){
        item.ocrText = "";
      }finally{
        ocrStatus.textContent = "";
      }
    }
    uploaded.push(item);
  }
  renderFiles();
}

function renderFiles(){
  fileList.innerHTML = uploaded.length ? uploaded.map((f,i)=>`
    <div class="card" style="background:#0b1224">
      <b>${escapeHtml(f.name)}</b>
      <div class="small">${escapeHtml(f.type || "")}</div>

      ${f.ocrText ? `<details><summary class="small">OCR testo (solo admin)</summary><pre class="small" style="white-space:pre-wrap">${escapeHtml(f.ocrText)}</pre></details>` : ""}

      <div class="row">
        <button onclick="renameFile(${i})">Rinomina</button>
        <button class="danger" onclick="delFile(${i})">Elimina</button>
      </div>
    </div>
  `).join("") : `<div class="small">Nessun file caricato.</div>`;
}

function renameFile(i){
  const n = prompt("Nuovo nome file:", uploaded[i].name);
  if(n && n.trim()){
    uploaded[i].name = n.trim();
    renderFiles();
  }
}

function delFile(i){
  if(!confirm("Eliminare questo file?")) return;
  uploaded.splice(i,1);
  renderFiles();
}

bgImage.addEventListener("change", async ()=>{
  if(bgImage.files[0]){
    currentBgData = await toBase64(bgImage.files[0]); // base64 persistente
    updateBgInfo();
  }
});

function removeBg(){
  currentBgData = null;
  bgImage.value = "";
  updateBgInfo();
}

function updateBgInfo(){
  bgInfo.textContent = currentBgData ? "‚úÖ Sfondo immagine impostato" : "Nessuna immagine di sfondo";
}

function buildVetrinaObject(){
  const id=(vid.value||"").trim();
  return {
    title: title.value || id,
    desc: desc.value || "",
    fontFamily: fontFamily.value || "system-ui",
    baseFontSize: Number(baseFontSize.value || 16),
    titleSize: Number(titleSize.value || 32),
    titleColor: titleColor.value || "#ffffff",
    bgColor: bgColor.value || "#0b1020",
    bgImage: currentBgData || null, // ‚úÖ immagine sfondo persistente
    presentationText: presentationText.value || "",
    voice: {
      lang: voiceLang.value || "it-IT",
      rate: Number(voiceRate.value || 1),
      pitch: 1,
      volume: 1
    },
    files: uploaded
  };
}

function save(){
  const id=(vid.value||"").trim();
  if(!id) return alert("ID obbligatorio");
  const all = loadAll();
  all[id] = buildVetrinaObject();
  saveAll(all);
  alert("Salvato ‚úÖ");
  refreshAll();
}

function deleteVetrina(){
  const id=(vid.value||"").trim();
  if(!id) return alert("Scrivi l‚ÄôID della vetrina");
  const all=loadAll();
  if(!all[id]) return alert("Non trovata in locale");
  if(!confirm(`Cancellare vetrina "${id}"?`)) return;
  delete all[id];
  saveAll(all);

  // reset form
  pickVetrina.value="";
  vid.value=""; title.value=""; desc.value="";
  uploaded=[]; currentBgData=null; bgImage.value="";
  refreshAll();

  alert("Cancellata ‚úÖ");
}

function exportVetrinaJson(){
  const id=(vid.value||"").trim();
  if(!id) return alert("Scrivi l‚ÄôID");
  const all=loadAll();
  const v=all[id];
  if(!v) return alert("Non trovata in locale");

  const blob=new Blob([JSON.stringify(v,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`${id}.json`;
  a.click();
  alert(`Carica su GitHub in: data/${id}.json`);
}

function testVoice(){
  const ok = speakText(presentationText.value, {lang: voiceLang.value, rate: voiceRate.value});
  if(!ok) alert("Sintesi vocale non disponibile su questo browser.");
}

function renderList(){
  const all=loadAll();
  const base = location.origin + location.pathname.replace("admin.html","");
  const ids=Object.keys(all);
  list.innerHTML = ids.length ? ids.map(id=>{
    const link = `${base}vetrina.html?id=${encodeURIComponent(id)}`;
    return `
      <div class="card">
        <b>${id}</b>
        <div class="small">${escapeHtml(all[id].desc||"")}</div>
        <a href="${link}" target="_blank">${link}</a>
      </div>
    `;
  }).join("") : `<div class="small">Nessuna vetrina.</div>`;
}

function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;");
}
</script>

</body>
</html>
