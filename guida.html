<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SerCucTech ‚Äì Percorso Guida Vetrine (per ID)</title>
  <style>
    :root{ --bg:#0b1220; --card:#111b2e; --txt:#e8eefc; --mut:#a9b8dd; --acc:#5ee1a2; --b:#22345f; --warn:#ffcc66; --danger:#ff6b6b; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:linear-gradient(180deg,#081024,#0b1220); color:var(--txt); }
    .wrap{ max-width:980px; margin:0 auto; padding:18px; }
    .card{ background:rgba(17,27,46,.92); border:1px solid #1b2a4f; border-radius:18px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.22); }
    h1{ margin:0 0 8px 0; font-size:20px; }
    .mut{ color:var(--mut); }
    .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    button{ cursor:pointer; border:0; padding:10px 14px; border-radius:12px; font-weight:900; background:var(--acc); color:#052014; }
    .sec{ background:#22345f; color:var(--txt); }
    .warn{ background:var(--warn); color:#231a06; }
    .danger{ background:var(--danger); color:#2b0909; }
    a{ color:#9fe9ff; }
    .list{ margin-top:12px; display:grid; gap:10px; }
    .item{ border:1px solid var(--b); background:#0c1530; border-radius:14px; padding:12px; }
    .toprow{ display:flex; gap:10px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; }
    .check{ display:flex; gap:10px; align-items:center; }
    input[type="checkbox"]{ transform:scale(1.3); }
    .pill{ display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; background:#0f1a31; border:1px solid #1b2a4f; color:var(--mut); font-size:12px; }
    .cur{ outline:2px dashed var(--acc); outline-offset:4px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Percorso guida ‚Äì Vetrine SerCucTech (Audio + Testo)</h1>
    <div class="mut" id="sub">
      Spunta gli step che vuoi usare. Premi ‚ÄúVoce‚Äù per ascoltare lo step corrente.
    </div>

    <div class="row" style="margin-top:10px;">
      <span class="pill">Vetrina ID: <b id="vId">‚Äî</b></span>
      <span class="pill">Stato ID: <b id="idStatus">controllo‚Ä¶</b></span>
    </div>

    <div class="btns">
      <button class="sec" id="prevBtn">‚¨ÖÔ∏è Indietro</button>
      <button id="speakBtn">üîä Voce</button>
      <button class="sec" id="stopBtn">‚èπ Stop</button>
      <button class="sec" id="nextBtn">Avanti ‚û°Ô∏è</button>
      <button class="warn" id="resetBtn">Reset spunte</button>
    </div>

    <div class="btns" id="quickLinks"></div>

    <div class="pill" style="margin-top:10px;">
      Step corrente: <b id="curLabel">‚Äî</b>
    </div>

    <div class="mut" style="margin-top:10px;" id="tips"></div>
  </div>

  <div class="list" id="steps"></div>
</div>

<script>
/* =================== CONFIG =================== */
const INDEX_PATH = "data/index.json";

/* =================== PARAMS =================== */
function getParam(name){
  const u = new URL(location.href);
  return (u.searchParams.get(name) || "").trim();
}
function sanitizeId(s){
  return (s||"").trim().toLowerCase().replace(/\s+/g,"").replace(/[^a-z0-9_-]/g,"");
}
const requestedIdRaw = getParam("id");
const VETRINA_ID = sanitizeId(requestedIdRaw) || "scalvini10";

/* LocalStorage key separata per ogni vetrina */
const KEY = "sercuctech_guida_vetrine_v2_" + VETRINA_ID;

/* =================== TTS =================== */
function stopTTS(){ if('speechSynthesis' in window) window.speechSynthesis.cancel(); }
function speak(text){
  stopTTS();
  if(!('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "it-IT";
  window.speechSynthesis.speak(u);
}

/* =================== LINKS (dinamici) =================== */
function L_admin(){ return "admin.html"; }
function L_vetrina(){ return `vetrina.html?id=${encodeURIComponent(VETRINA_ID)}`; }
function L_json(){ return `data/${encodeURIComponent(VETRINA_ID)}.json`; }
function L_index(){ return INDEX_PATH; }
function L_mediaFolder(){ return "media/"; }
function L_filesFolder(){ return "files/"; }
function L_jsonNew(newId){ return `data/${encodeURIComponent(newId)}.json`; }
function L_vetrinaNew(newId){ return `vetrina.html?id=${encodeURIComponent(newId)}`; }

/* =================== STEPS TEMPLATE =================== */
function buildSteps(){
  const nextIdSuggestion = suggestNextId(VETRINA_ID); // es: scalvini10 -> scalvini11
  return [
    {
      id:"S1",
      title:"Apri Admin e sblocca",
      speak:`Apri l‚Äôadmin. Poi sblocca toccando la parola LUCE e poi la parola PORTA.`,
      links:[ {label:"Apri Admin", url:L_admin()} ],
      detail:[
        "Apri admin.html",
        "Sblocca: tocca LUCE poi PORTA nella frase"
      ]
    },
    {
      id:"S2",
      title:"Carica index dal repo (data/index.json)",
      speak:"In admin, carica l‚Äôindex dal repo. Controlla che vedi la lista vetrine e gruppi.",
      links:[ {label:"Apri index.json", url:L_index()} ],
      detail:[
        "Admin ‚Üí 'Carica index dal repo'",
        "Devi vedere le vetrine nel menu a tendina"
      ]
    },
    {
      id:"S3",
      title:`Carica la vetrina: ${VETRINA_ID}`,
      speak:`Seleziona la vetrina ${VETRINA_ID} e carica il file vetrina. Controlla titolo, descrizione, voce e tags.`,
      links:[
        {label:`Pubblico: ${VETRINA_ID}`, url:L_vetrina()},
        {label:`JSON: ${VETRINA_ID}.json`, url:L_json()}
      ],
      detail:[
        `Admin ‚Üí scegli ${VETRINA_ID}`,
        "Clic 'Carica file vetrina'",
        "Verifica editor: titolo/descrizione/voce/tags"
      ]
    },
    {
      id:"S4",
      title:"Aggiungi un PDF in files[]",
      speak:"Se vuoi un PDF, caricalo in files e aggiungi la riga dentro files nel JSON della vetrina.",
      links:[ {label:"Cartella /files/", url:L_filesFolder()} ],
      detail:[
        "Carica manuale.pdf su GitHub dentro /files/",
        `Nel JSON:  { "label":"Manuale", "url":"files/manuale.pdf" }`,
        `Poi scarica ${VETRINA_ID}.json e ricaricalo in /data/`
      ]
    },
    {
      id:"S5",
      title:"Upload multiplo Media + ZIP",
      speak:"Se vuoi foto o video, seleziona pi√π file. Aggiungili al JSON. Scarica lo ZIP e carica i file dentro media.",
      links:[ {label:"Cartella /media/", url:L_mediaFolder()} ],
      detail:[
        "Admin ‚Üí Media ‚Üí seleziona pi√π file",
        "Clic 'Aggiungi al JSON'",
        "Clic 'Scarica ZIP media'",
        "Estrai e carica i file su GitHub in /media/"
      ]
    },
    {
      id:"S6",
      title:"Riordino Media e Files (DnD oppure ‚Üë ‚Üì)",
      speak:"Riordina media e files con trascinamento o con frecce. Poi scarica il JSON e ricaricalo nel repo.",
      links:[ {label:`Scarica poi: ${VETRINA_ID}.json`, url:"#"} ],
      detail:[
        "Admin ‚Üí Media presenti: trascina o usa ‚Üë ‚Üì",
        "Admin ‚Üí Files presenti: trascina o usa ‚Üë ‚Üì",
        `Poi: Scarica ${VETRINA_ID}.json e caricalo in /data/`
      ]
    },
    {
      id:"S7",
      title:"OCR (solo Admin) + TXT in /files/",
      speak:"Usa OCR in admin. Scarica il testo TXT e caricalo in files. Poi aggiungi il link in files della vetrina.",
      links:[ {label:"Cartella /files/", url:L_filesFolder()} ],
      detail:[
        "Admin ‚Üí OCR ‚Üí carica immagine",
        "Avvia OCR ‚Üí Scarica TXT",
        "Carica TXT in /files/",
        "In Admin: 'Aggiungi TXT in files[]' ‚Üí poi scarica JSON e ricaricalo in /data/"
      ]
    },
    {
      id:"S8",
      title:`Duplica vetrina (esempio: ${VETRINA_ID} ‚Üí ${nextIdSuggestion})`,
      speak:`Per duplicare, premi Duplica vetrina. Inserisci ${nextIdSuggestion} e crea clone. Poi scarica index.json e ${nextIdSuggestion}.json e caricali in data.`,
      links:[
        {label:`Pubblico: ${nextIdSuggestion}`, url:L_vetrinaNew(nextIdSuggestion)},
        {label:`JSON: ${nextIdSuggestion}.json`, url:L_jsonNew(nextIdSuggestion)}
      ],
      detail:[
        `Admin ‚Üí carica ${VETRINA_ID}`,
        "Clic 'Duplica vetrina' ‚Üí scrivi nuovo ID ‚Üí 'Crea clone'",
        "Scarica index.json + nuovoId.json",
        "Caricali in /data/"
      ]
    },
    {
      id:"S9",
      title:"Controllo finale pubblico",
      speak:"Apri la vetrina pubblica e controlla media, file e PDF. Se qualcosa non si vede, controlla i percorsi e le maiuscole.",
      links:[
        {label:`Apri pubblico: ${VETRINA_ID}`, url:L_vetrina()},
        {label:`Apri JSON: ${VETRINA_ID}.json`, url:L_json()}
      ],
      detail:[
        "Percorsi corretti: media/nomefile e files/nomefile",
        "Attenzione: maiuscole/minuscole devono combaciare",
        "Se PDF non si vede: verifica che il file √® davvero in /files/"
      ]
    }
  ];
}

/* =================== Helpers ID next =================== */
function suggestNextId(id){
  // se finisce con numero, incrementa (scalvini10 -> scalvini11)
  const m = String(id).match(/^(.*?)(\d+)$/);
  if(!m) return id + "2";
  const base = m[1];
  const num = parseInt(m[2], 10);
  const next = isNaN(num) ? (m[2] + "2") : String(num + 1);
  return base + next;
}

/* =================== STATE =================== */
function loadState(){
  try{ return JSON.parse(localStorage.getItem(KEY)) || {}; }catch(e){ return {}; }
}
function saveState(st){ localStorage.setItem(KEY, JSON.stringify(st)); }

let steps = buildSteps();
let state = loadState();
if(!state.enabled) state.enabled = {};
if(typeof state.currentIndex !== "number") state.currentIndex = 0;

// default: se √® la prima volta, abilito tutti gli step
if(!state._init){
  steps.forEach(s => state.enabled[s.id] = true);
  state.currentIndex = 0;
  state._init = true;
  saveState(state);
}

/* =================== RENDER =================== */
function renderQuickLinks(){
  const box = document.getElementById("quickLinks");
  box.innerHTML = `
    <a class="pill" href="${L_admin()}" target="_blank" rel="noopener">Apri Admin</a>
    <a class="pill" href="${L_vetrina()}" target="_blank" rel="noopener">Apri Pubblico</a>
    <a class="pill mono" href="${L_json()}" target="_blank" rel="noopener">JSON vetrina</a>
    <a class="pill mono" href="${L_index()}" target="_blank" rel="noopener">index.json</a>
    <a class="pill" href="${L_mediaFolder()}" target="_blank" rel="noopener">/media/</a>
    <a class="pill" href="${L_filesFolder()}" target="_blank" rel="noopener">/files/</a>
  `;
}

function render(){
  document.getElementById("vId").textContent = VETRINA_ID;
  renderQuickLinks();

  const box = document.getElementById("steps");
  box.innerHTML = "";

  steps.forEach((s, idx)=>{
    const div = document.createElement("div");
    div.className = "item" + (idx === state.currentIndex ? " cur" : "");
    const checked = !!state.enabled[s.id];
    const linksHTML = (s.links||[]).map(l => {
      if(l.url === "#") return `<span class="mut">${l.label}</span>`;
      return `<a href="${l.url}" target="_blank" rel="noopener">${l.label}</a>`;
    }).join(" ‚Ä¢ ");
    const detailsHTML = (s.detail||[]).map(x => `<li>${x}</li>`).join("");

    div.innerHTML = `
      <div class="toprow">
        <div>
          <div class="pill"><b>${s.id}</b> ‚Ä¢ ${s.title}</div>
          <div class="mut" style="margin-top:8px;">${linksHTML || ""}</div>
        </div>
        <label class="check">
          <input type="checkbox" ${checked ? "checked" : ""} data-id="${s.id}" />
          <span class="mut">Usa questo step</span>
        </label>
      </div>
      <ul class="mut" style="margin:10px 0 0 18px;">${detailsHTML}</ul>
    `;
    box.appendChild(div);
  });

  const cur = steps[state.currentIndex];
  document.getElementById("curLabel").textContent = cur ? `${cur.id} ‚Äì ${cur.title}` : "‚Äî";

  box.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    cb.addEventListener("change", (e)=>{
      const id = e.target.getAttribute("data-id");
      state.enabled[id] = e.target.checked;
      saveState(state);
    });
  });
}

/* =================== NAV (skip disabled) =================== */
function next(){
  let i = state.currentIndex;
  for(let t=i+1; t<steps.length; t++){
    if(state.enabled[steps[t].id]) { state.currentIndex = t; saveState(state); render(); return; }
  }
  if(i < steps.length-1){ state.currentIndex++; saveState(state); render(); }
}
function prev(){
  let i = state.currentIndex;
  for(let t=i-1; t>=0; t--){
    if(state.enabled[steps[t].id]) { state.currentIndex = t; saveState(state); render(); return; }
  }
  if(i > 0){ state.currentIndex--; saveState(state); render(); }
}

/* =================== BUTTONS =================== */
document.getElementById("speakBtn").onclick = ()=>{
  const cur = steps[state.currentIndex];
  if(!cur) return;
  const on = !!state.enabled[cur.id];
  const prefix = on ? "Step attivo. " : "Step disattivato. ";
  speak(prefix + cur.speak);
};
document.getElementById("stopBtn").onclick = stopTTS;
document.getElementById("nextBtn").onclick = next;
document.getElementById("prevBtn").onclick = prev;
document.getElementById("resetBtn").onclick = ()=>{
  if(!confirm("Reset spunte e progressi per questa vetrina?")) return;
  state = { enabled:{}, currentIndex:0, _init:true };
  steps.forEach(s => state.enabled[s.id] = true);
  saveState(state);
  render();
};

/* =================== CHECK ID EXISTENCE =================== */
async function checkId(){
  const statusEl = document.getElementById("idStatus");
  const tipsEl = document.getElementById("tips");
  try{
    const res = await fetch(INDEX_PATH + "?t=" + Date.now(), {cache:"no-store"});
    if(!res.ok) throw new Error("index non trovato");
    const indexDB = await res.json();
    const exists = !!(indexDB && indexDB.vetrine && indexDB.vetrine[VETRINA_ID]);
    statusEl.textContent = exists ? "‚úÖ presente in index" : "‚ö†Ô∏è NON presente in index";
    tipsEl.innerHTML = exists
      ? `Suggerimento: lavora in admin su <span class="mono">${VETRINA_ID}</span>, poi controlla il pubblico.`
      : `Suggerimento: se non esiste, crea la vetrina in admin oppure correggi l‚ÄôID nella barra: <span class="mono">?id=...</span>`;
  }catch(e){
    statusEl.textContent = "‚ö†Ô∏è non riesco a leggere index";
    tipsEl.innerHTML = `Controlla che esista <span class="mono">data/index.json</span> nel repo.`;
  }
}

/* =================== INIT =================== */
document.getElementById("vId").textContent = VETRINA_ID;
render();
checkId();
</script>
</body>
</html>
