<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Gruppo Vetrine</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div id="app"></div>

<script src="app.js"></script>
<script>
function showFull(html){
  const w=document.createElement("div");
  w.className="full";
  w.innerHTML = html + `<div class="hint">Tocca per chiudere</div>`;
  w.onclick=()=>w.remove();
  document.body.appendChild(w);
}

async function loadPublicVetrina(id){
  try{
    const r = await fetch(`data/${encodeURIComponent(id)}.json`, {cache:"no-store"});
    if(r.ok) return await r.json();
  }catch(e){}
  return null;
}

(async function(){
  const gid = new URLSearchParams(location.search).get("g");
  if(!gid){
    app.innerHTML = `<div class="wrap card">ID gruppo mancante. Usa: bundle.html?g=ID</div>`;
    return;
  }

  const groups = JSON.parse(localStorage.getItem("sercuctech_groups") || "{}");
  const group = groups[gid];

  if(!group){
    app.innerHTML = `
      <div class="wrap card">
        Gruppo <b>${gid}</b> non trovato sul dispositivo.<br><br>
        <div class="small">
          Nota: i gruppi sono locali (admin). Per condividerli a tutti, ti preparo dopo una modalità “gruppo pubblico” con JSON.
        </div>
      </div>`;
    return;
  }

  // Carichiamo le vetrine: prima prova pubblico, poi fallback locale
  const localAll = loadAll();
  const blocks = [];

  for(const id of group.ids){
    const pub = await loadPublicVetrina(id);
    const v = pub || localAll[id];
    if(!v) continue;
    blocks.push({id, v, pub: !!pub});
  }

  if(!blocks.length){
    app.innerHTML = `<div class="wrap card">Nessuna vetrina disponibile nel gruppo.</div>`;
    return;
  }

  // Fullscreen layout
  document.body.style.overflow="hidden";

  app.innerHTML = `
    <div style="width:100vw;height:100vh;overflow:auto;padding:14px">
      <div class="card">
        <h2>${group.title || gid}</h2>
        <div class="small">Contiene ${blocks.length} vetrine</div>
      </div>

      ${blocks.map(({id,v,pub})=>`
        <div class="card" style="background:${v.bgColor||"#111827"}">
          <div style="font-family:${v.fontFamily||"system-ui"};font-size:${v.baseFontSize||16}px">
            <div style="font-weight:900;font-size:${v.titleSize||32}px;color:${v.titleColor||"#fff"}">
              ${v.title || id}
            </div>
            <div class="small">${v.desc||""} ${pub ? "" : " (locale)"}</div>
          </div>

          <div class="grid">
            ${(v.files||[]).map(f=>{
              if((f.type||"").startsWith("video")){
                return `<video class="thumb" src="${f.data}" muted controls onclick="event.stopPropagation();showFull('<video src=&quot;${f.data}&quot; controls autoplay></video>')"></video>`;
              }
              if((f.type||"").startsWith("image")){
                return `<img class="thumb" src="${f.data}" onclick="event.stopPropagation();showFull('<img src=&quot;${f.data}&quot;>')">`;
              }
              return "";
            }).join("")}
          </div>
        </div>
      `).join("")}
    </div>
  `;
})();
</script>

</body>
</html>
