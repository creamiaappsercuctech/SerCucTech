<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Gruppo Vetrine</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div id="app"></div>

<script src="app.js"></script>
<script>
function showFull(html){
  const w=document.createElement("div");
  w.className="full";
  w.innerHTML = html + `<div class="hint">Tocca per chiudere</div>`;
  w.onclick=()=>w.remove();
  document.body.appendChild(w);
}

async function loadPublicGroup(gid){
  try{
    const r = await fetch(`data/groups/${encodeURIComponent(gid)}.json`, {cache:"no-store"});
    if(r.ok) return await r.json();
  }catch(e){}
  return null;
}
async function loadPublicVetrina(id){
  try{
    const r = await fetch(`data/${encodeURIComponent(id)}.json`, {cache:"no-store"});
    if(r.ok) return await r.json();
  }catch(e){}
  return null;
}

(async function(){
  const gid = new URLSearchParams(location.search).get("g");
  if(!gid){
    app.innerHTML = `<div class="wrap card">ID gruppo mancante. Usa: bundle.html?g=ID</div>`;
    return;
  }

  const group = await loadPublicGroup(gid);
  if(!group){
    app.innerHTML = `<div class="wrap card">
      Gruppo <b>${escapeHtml(gid)}</b> non trovato.<br><br>
      <div class="small">Serve: <b>data/groups/${escapeHtml(gid)}.json</b></div>
    </div>`;
    return;
  }

  const blocks = [];
  for(const id of (group.ids||[])){
    const v = await loadPublicVetrina(id);
    blocks.push({id, v});
  }

  app.innerHTML = `
    <div style="width:100vw;height:100vh;overflow:auto;padding:14px">
      <div class="card">
        <h2>${escapeHtml(group.title || gid)}</h2>
        <div class="small">Gruppo pubblico ✅ • ${blocks.length} vetrine</div>
      </div>

      ${blocks.map(({id,v})=>{
        if(!v){
          return `<div class="card" style="background:#3b1d1d">
            <b>${escapeHtml(id)}</b>
            <div class="small">❌ manca data/${escapeHtml(id)}.json</div>
          </div>`;
        }

        return `
        <div class="card" style="background:${v.bgColor||"#0b1020"}">
          <div style="font-family:${v.fontFamily||"system-ui"};font-size:${v.baseFontSize||16}px">
            <div style="font-weight:900;font-size:${v.titleSize||32}px;color:${v.titleColor||"#fff"}">
              ${escapeHtml(v.title || id)}
            </div>
            <div class="small">${escapeHtml(v.desc||"")}</div>
            <div class="small"><a href="vetrina.html?id=${encodeURIComponent(id)}">Apri vetrina</a></div>
          </div>

          <div class="grid">
            ${(v.files||[]).slice(0,12).map(f=>{
              if((f.type||"").startsWith("video/")){
                return `<video class="thumb" src="${f.data}" muted controls onclick="event.stopPropagation();showFull('<video src=&quot;${f.data}&quot; controls autoplay></video>')"></video>`;
              }
              if((f.type||"").startsWith("image/")){
                return `<img class="thumb" src="${f.data}" onclick="event.stopPropagation();showFull('<img src=&quot;${f.data}&quot;>')">`;
              }
              return "";
            }).join("")}
          </div>
        </div>`;
      }).join("")}
    </div>
  `;
})();
</script>
</body>
</html>
