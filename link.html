<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Indice Link â€¢ SerCucTech</title>

  <!-- âœ… usa stile.css vero -->
  <link rel="stylesheet" href="stile.css?v=9999">

  <!-- fallback minimo (se css non carica) -->
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brandDot" aria-hidden="true"></div>
      <div class="titleWrap">
        <h1 class="pageTitle">ğŸ“Œ Indice Link SerCucTech</h1>
        <p class="pageDesc">Scrivi cosa devi fare e trovi la pagina giusta.</p>
      </div>
      <span class="idBadge" id="ver">v9999</span>
    </div>
  </header>

  <main class="content">
    <section class="card">
      <input id="q" class="pinsJsonBox" style="min-height:auto" placeholder="Scrivi cosa devi fareâ€¦ es. numerare oggetti foto renzo11" />
      <div class="smallHint" style="text-align:left;margin-top:10px">
        Suggerimento: prova â€œadminâ€, â€œuploadâ€, â€œnumeriniâ€, â€œrenzo11â€, â€œscalviniâ€.
      </div>
    </section>

    <section class="card">
      <h2 class="h2">Risultati</h2>
      <div id="list" class="filesList"></div>
    </section>
  </main>

  <!-- popup guida -->
  <div class="waModal" id="popup" hidden>
    <div class="waModalCard">
      <div class="waModalTitle" id="popTitle">Guida</div>
      <div class="waModalText" id="popText"></div>

      <div class="waModalBtns" style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap">
        <button type="button" id="popSpeak" class="labelBtn">ğŸ”Š Ripeti</button>
        <button type="button" id="popOpen" class="labelBtn">Apri link</button>
        <button type="button" id="popClose" class="labelBtn danger">Chiudi</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const q = document.getElementById("q");
  const list = document.getElementById("list");

  const popup = document.getElementById("popup");
  const popTitle = document.getElementById("popTitle");
  const popText = document.getElementById("popText");
  const popClose = document.getElementById("popClose");
  const popSpeak = document.getElementById("popSpeak");
  const popOpen  = document.getElementById("popOpen");

  let lastOpenUrl = "";

  function speak(text){
    try{
      if(!("speechSynthesis" in window)) return;
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(String(text||""));
      u.lang = "it-IT";
      u.rate = 1;
      speechSynthesis.speak(u);
    }catch(e){}
  }

  function showPopup(title, text, openUrl){
    lastOpenUrl = openUrl || "";
    popTitle.textContent = title || "Guida";
    popText.textContent  = text || "";
    popup.hidden = false;
    // prova a parlare (se bloccato dal telefono lâ€™utente deve tappare ancora)
    speak(popText.textContent);
  }

  function hidePopup(){ popup.hidden = true; }

  popClose.onclick = hidePopup;
  popSpeak.onclick = () => speak(popText.textContent);
  popOpen.onclick  = () => { if(lastOpenUrl) location.href = lastOpenUrl; };

  popup.addEventListener("click", (e)=>{ if(e.target === popup) hidePopup(); });

  async function fetchJson(url){
    const r = await fetch(url, { cache:"no-store" });
    if(!r.ok) throw new Error(url);
    return r.json();
  }

  // Carica elenco vetrine dal tuo repo (in 2 posizioni possibili)
  async function loadVetrine(){
    const tries = [
      "data/vetrine.json?ts=" + Date.now(),
      "vetrine.json?ts=" + Date.now()
    ];
    for(const u of tries){
      try { return await fetchJson(u); } catch(e) {}
    }
    return { vetrine: [] };
  }

  // Base link â€œfissiâ€
  const base = [
    {
      title: "Admin (gestione vetrine)",
      url: "admin.html",
      guide: "Apri Admin. Sblocca con 2 parole in ordine + PIN. Poi gestisci vetrine e file.",
      keywords: ["admin","pin","gestione","upload","json","media"]
    },
    {
      title: "Indice pubblico vetrine (Home)",
      url: "index.html",
      guide: "Pagina principale con elenco vetrine pubbliche.",
      keywords: ["home","indice","vetrine","pubblico"]
    },
    {
      title: "Indice link (questa pagina)",
      url: "link.html",
      guide: "Qui cerchi un compito e trovi il link giusto. Usa Spiega per voce + popup.",
      keywords: ["link","indice","guida","cerca"]
    }
  ];

  function normalizeList(data){
    const arr = Array.isArray(data?.vetrine) ? data.vetrine : (Array.isArray(data) ? data : []);
    arr.forEach(v=>{
      if(!v || !v.id) return;
      base.push({
        title: `Vetrina: ${v.title || v.id}`,
        url: `vetrina.html?id=${encodeURIComponent(v.id)}`,
        guide: `Apri la vetrina "${v.title || v.id}". Poi usa il pulsante WhatsApp per chiedere info sulla foto.`,
        keywords: [String(v.id).toLowerCase(), String(v.title||"").toLowerCase(), "vetrina", "foto", "whatsapp"]
      });
    });
  }

  function buildItems(filter){
    const f = String(filter||"").trim().toLowerCase();
    const items = base
      .map((it, i) => ({...it, num: i+1}))
      .filter(it => {
        if(!f) return true;
        return (it.title||"").toLowerCase().includes(f)
          || (it.url||"").toLowerCase().includes(f)
          || (it.keywords||[]).some(k => String(k||"").toLowerCase().includes(f));
      });
    return items;
  }

  function render(filter=""){
    const items = buildItems(filter);
    list.innerHTML = "";

    if(!items.length){
      const div = document.createElement("div");
      div.className = "fileLink";
      div.innerHTML = `<div><b>Nessun risultato</b><div style="opacity:.75;font-size:12px">Prova altre parole.</div></div><div></div>`;
      list.appendChild(div);
      return;
    }

    items.forEach(it=>{
      const row = document.createElement("div");
      row.className = "fileLink";
      row.style.alignItems = "center";

      row.innerHTML = `
        <div style="min-width:0">
          <div style="font-weight:900">#${String(it.num).padStart(2,"0")} â€” ${it.title}</div>
          <div style="opacity:.75;font-size:12px;word-break:break-all">${it.url}</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
          <button class="labelBtn" data-spiega>ğŸ”Š Spiega</button>
          <button class="labelBtn" data-apri>Apri</button>
        </div>
      `;

      row.querySelector("[data-spiega]").onclick = () => {
        showPopup(`Guida #${String(it.num).padStart(2,"0")}`, it.guide, it.url);
      };

      row.querySelector("[data-apri]").onclick = () => {
        // prima popup+voce, poi apri
        showPopup(`Apro #${String(it.num).padStart(2,"0")}`, it.guide, it.url);
        setTimeout(()=>{ location.href = it.url; }, 650);
      };

      list.appendChild(row);
    });
  }

  // avvio
  (async () => {
    const data = await loadVetrine();
    normalizeList(data);
    render("");

    q.addEventListener("input", ()=> render(q.value));
  })();

})();
</script>
</body>
</html>
