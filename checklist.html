<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SerCucTech - Checklist</title>
  <script src="./guide.js"></script>
  <style>
    :root{--bg:#0b1220;--card:#0f1a32;--txt:#e8eefc;--mut:#a9b8dd;--ok:#5ee1a2;}
    body{margin:0;font-family:system-ui;background:var(--bg);color:var(--txt);}
    .wrap{max-width:980px;margin:0 auto;padding:18px;}
    .card{background:rgba(27,46,92,.55);border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:16px;}
    h1{margin:0 0 8px 0;font-size:24px;}
    .mut{color:var(--mut);}
    .top{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px;}
    button{cursor:pointer;border:0;padding:10px 14px;border-radius:12px;font-weight:900;background:var(--ok);color:#082016;}
    .sec{background:#22345f;color:var(--txt);}
    .step{display:flex;gap:10px;align-items:flex-start;padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.18);margin-top:10px;}
    .step b{display:block}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 id="title">Checklist</h1>
      <div class="mut" id="desc"></div>

      <div class="top">
        <label style="display:flex;gap:10px;align-items:center;font-weight:900;">
          <input type="checkbox" id="enableChecklist">
          Usa percorso guida (Checklist)
        </label>

        <label style="display:flex;gap:10px;align-items:center;font-weight:900;">
          <input type="checkbox" id="enableVoice" checked>
          Voce telefono
        </label>

        <button class="sec" id="openAdmin">üß∞ Apri Admin</button>
        <button class="sec" id="openVetrina">üåç Apri Vetrina</button>
        <button class="sec" id="stopVoice">‚èπ Stop</button>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div style="font-weight:1000;">Passi</div>
      <div id="steps"></div>
    </div>
  </div>

<script>
  const id = new URL(location.href).searchParams.get("id") || "scalvini10";
  const jsonUrl = "./data/" + id + ".json";

  const enableChecklist = document.getElementById("enableChecklist");
  const enableVoice = document.getElementById("enableVoice");
  enableChecklist.checked = SCTGuide.getBool(SCTGuide.LS.guideChecklist,true);
  enableVoice.checked = SCTGuide.getBool(SCTGuide.LS.voiceEnabled,true);

  enableChecklist.onchange = () => SCTGuide.setBool(SCTGuide.LS.guideChecklist, enableChecklist.checked);
  enableVoice.onchange = () => SCTGuide.setBool(SCTGuide.LS.voiceEnabled, enableVoice.checked);

  document.getElementById("stopVoice").onclick = () => { try{ speechSynthesis.cancel(); }catch(e){} };
  document.getElementById("openVetrina").onclick = () => location.href = "./vetrina.html?id=" + encodeURIComponent(id);
  document.getElementById("openAdmin").onclick = () => location.href = "./admin.html?id=" + encodeURIComponent(id);

  function say(t){
    if(SCTGuide.getBool(SCTGuide.LS.guideChecklist,true)) SCTGuide.speak(t);
  }

  async function load(){
    const r = await fetch(jsonUrl, {cache:"no-store"});
    const data = r.ok ? await r.json() : {};
    document.getElementById("title").textContent = "Checklist ‚Äî " + (data.title || id);
    document.getElementById("desc").textContent = "Spunta ‚ÄòFatto‚Äô e la guida ti dice il prossimo passo.";

    const steps = [
      { key:"s1", title:"Apri Admin", text:"Tocca ‚ÄòApri Admin‚Äô. Qui gestisci vetrine e file." },
      { key:"s2", title:"Duplica vetrina", text:"In Admin premi ‚ÄòDuplica vetrina‚Äô, scrivi nuovo ID (es: scalvini11) e premi ‚ÄòCrea duplicato‚Äô." },
      { key:"s3", title:"Crea file su GitHub", text:"In Admin premi ‚ÄòCrea file su GitHub‚Äô. Si apre data/<nuovoID>.json. Incolla il JSON e salva." },
      { key:"s4", title:"Aggiorna index.json", text:"In Admin premi ‚ÄòApri index.json‚Äô. Dentro vetrine aggiungi la riga nuova e salva." },
      { key:"s5", title:"Apri Vetrina nuova", text:"Ora apri vetrina.html?id=<nuovoID> e controlla che si veda." },
      { key:"s6", title:"Se un file d√† 404", text:"Controlla che il file esista davvero in /files/ o /media/ e che il nome sia identico." },
      { key:"s7", title:"Fine", text:"Hai finito. Se vuoi, aggiungi manuale.pdf in files/ e aggiorna i link nel JSON." }
    ];

    const box = document.getElementById("steps");
    box.innerHTML = "";

    const doneKey = "sct_done_"+id+"_v2";
    const done = JSON.parse(localStorage.getItem(doneKey) || "{}");
    function save(){ localStorage.setItem(doneKey, JSON.stringify(done)); }

    function speakNext(){
      if(!SCTGuide.getBool(SCTGuide.LS.guideChecklist,true)) return;
      const next = steps.find(s => !done[s.key]);
      if(next) say("Prossimo passo: " + next.title + ". " + next.text);
      else say("Tutti i passi completati.");
    }

    steps.forEach(s=>{
      const row = document.createElement("div");
      row.className = "step";
      row.innerHTML = `
        <input type="checkbox" ${done[s.key] ? "checked":""} style="margin-top:4px;">
        <div>
          <b>${s.title}</b>
          <div class="mut">${s.text}</div>
        </div>
      `;
      const cb = row.querySelector("input");
      cb.onchange = () => {
        done[s.key] = cb.checked;
        save();
        if(cb.checked) speakNext();
      };
      box.appendChild(row);
    });

    speakNext();
  }

  load();
</script>
</body>
</html>
