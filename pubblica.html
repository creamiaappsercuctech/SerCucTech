<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SerCucTech â€“ Pubblica</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b1220">
  <link rel="apple-touch-icon" href="icon-192.png">

  <link rel="stylesheet" href="stile.css" />
  <style>
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:999px;background:#0f1a31;border:1px solid #1b2a4f;color:var(--mut);font-size:13px}
    .mono{font-family: var(--mono);}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
    @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
    .box{padding:10px;border-radius:14px;border:1px solid var(--b);background:#0c1530}
    .okdot{color:var(--acc);font-weight:900}
    .baddot{color:var(--danger);font-weight:900}
    .warn{color:var(--warn);font-weight:900}
    .smallbtn{ padding:8px 10px; border-radius:10px; font-weight:900; }
    .list2{display:grid;gap:10px}
    .row2{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .kbd{font-family: var(--mono); background:#0f1a31; border:1px solid #22345f; padding:2px 8px; border-radius:10px; color:var(--mut);}
  </style>
</head>

<body>
<div class="wrap">

  <div class="top">
    <div style="font-weight:900">SerCucTech â€“ Pubblica</div>
    <div class="pill">Repo: <b id="baseUrl">â€”</b></div>
    <div class="btns">
      <a class="btn sec" href="index.html">ğŸ  Home</a>
      <a class="btn sec" href="admin.html">ğŸ› ï¸ Admin</a>
      <button class="btn sec" id="installBtn" style="display:none;">ğŸ“² Installa App</button>
    </div>
  </div>

  <div class="grid">

    <!-- Selezione -->
    <div class="card">
      <h2>Seleziona cosa pubblicare</h2>
      <div class="mut">
        Questo pannello ti genera i link pronti e ti guida passo-passo (1,2,3â€¦).
      </div>

      <div class="hr"></div>

      <label>Vetrina</label>
      <select id="vSelect">
        <option value="">â€” scegli â€”</option>
      </select>

      <div class="btns" style="margin-top:10px">
        <button class="btn sec" id="reloadBtn">ğŸ”„ Ricarica index</button>
        <button class="btn ok" id="buildBtn">âœ… Genera link</button>
      </div>

      <div class="hr"></div>

      <label>Gruppo (opzionale)</label>
      <div class="mut">Esempio: <span class="kbd">bazar</span> â†’ link pubblico: <span class="kbd">vetrina.html?group=bazar</span></div>
      <input id="groupKey" placeholder="es: bazar" />

      <div class="btns" style="margin-top:10px">
        <button class="btn ok" id="buildGroupBtn">âœ… Genera link gruppo</button>
      </div>

      <div class="hr"></div>

      <div class="mut" id="statusMsg">Pronto.</div>
    </div>

    <!-- Link + Copia -->
    <div class="card">
      <h2>Link pronti (copia 1 tap)</h2>

      <div class="box">
        <div class="mut"><b>Link pubblico vetrina</b></div>
        <div class="mono" id="publicLink">â€”</div>
        <div class="row2" style="margin-top:10px">
          <button class="btn ok smallbtn" onclick="copyText('publicLink')">ğŸ“‹ Copia</button>
          <button class="btn sec smallbtn" onclick="openLink('publicLink')">â†— Apri</button>
        </div>
      </div>

      <div class="box" style="margin-top:12px">
        <div class="mut"><b>Link JSON vetrina</b></div>
        <div class="mono" id="jsonLink">â€”</div>
        <div class="row2" style="margin-top:10px">
          <button class="btn ok smallbtn" onclick="copyText('jsonLink')">ğŸ“‹ Copia</button>
          <button class="btn sec smallbtn" onclick="openLink('jsonLink')">â†— Apri</button>
        </div>
      </div>

      <div class="box" style="margin-top:12px">
        <div class="mut"><b>Cartelle</b></div>
        <div class="mut">Media: <span class="kbd">/media/</span> â€¢ Files: <span class="kbd">/files/</span></div>
        <div class="mono" id="mediaFolder">â€”</div>
        <div class="mono" id="filesFolder" style="margin-top:6px">â€”</div>
        <div class="row2" style="margin-top:10px">
          <button class="btn ok smallbtn" onclick="copyText('mediaFolder')">ğŸ“‹ Copia Media</button>
          <button class="btn ok smallbtn" onclick="copyText('filesFolder')">ğŸ“‹ Copia Files</button>
        </div>
      </div>

      <div class="box" style="margin-top:12px">
        <div class="mut"><b>Link gruppo</b> (se usi gruppi)</div>
        <div class="mono" id="groupLink">â€”</div>
        <div class="row2" style="margin-top:10px">
          <button class="btn ok smallbtn" onclick="copyText('groupLink')">ğŸ“‹ Copia</button>
          <button class="btn sec smallbtn" onclick="openLink('groupLink')">â†— Apri</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="btns">
        <button class="btn warn" id="copyAllBtn">ğŸ“‹ Copia TUTTI i link</button>
        <button class="btn sec" id="testBtn">ğŸ§ª Test link</button>
      </div>

      <div class="mut mono" id="testOut" style="white-space:pre-wrap;margin-top:10px;"></div>
    </div>

    <!-- Checklist -->
    <div class="card">
      <h2>Checklist pubblicazione (1,2,3â€¦)</h2>

      <div class="list2" id="checklist">
        <div class="item"><div><b>1) Crea o modifica la vetrina in Admin</b><div class="mut">Compila titolo, descrizione, voce, media e files.</div></div></div>
        <div class="item"><div><b>2) Scarica i JSON</b><div class="mut">Scarica <span class="kbd">index.json</span> e <span class="kbd">&lt;id&gt;.json</span>.</div></div></div>
        <div class="item"><div><b>3) Carica i JSON su GitHub</b><div class="mut">Metti in <span class="kbd">/data/</span> â†’ <span class="kbd">data/index.json</span> e <span class="kbd">data/&lt;id&gt;.json</span>.</div></div></div>
        <div class="item"><div><b>4) Carica i file (se ci sono)</b><div class="mut">Metti foto/video in <span class="kbd">/media/</span> e pdf/txt in <span class="kbd">/files/</span>.</div></div></div>
        <div class="item"><div><b>5) Controlla link</b><div class="mut">Usa â€œTest linkâ€ qui sopra (o apri i link) e verifica che non ci siano 404.</div></div></div>
        <div class="item"><div><b>6) Pulisci cache se non si aggiorna</b><div class="mut">Android Chrome: ğŸ”’ â†’ Impostazioni sito â†’ Archiviazione â†’ Cancella dati.</div></div></div>
        <div class="item"><div><b>7) Condividi il link pubblico</b><div class="mut">Condividi solo <span class="kbd">vetrina.html?id=...</span> (non Admin).</div></div></div>
      </div>
    </div>

    <!-- Note -->
    <div class="card">
      <h2>Note veloci</h2>
      <div class="mut">
        â€¢ ID consigliato: solo lettere/numeri, senza spazi (es: <span class="kbd">renzo11</span>).<br>
        â€¢ Esempio file: <span class="kbd">data/renzo11.json</span>.<br>
        â€¢ Se un file non carica, quasi sempre Ã¨ <b>percorso sbagliato</b> o <b>cache</b>.
      </div>

      <div class="hr"></div>

      <div class="btns">
        <button class="btn sec" id="openIndexJsonBtn">Apri data/index.json</button>
        <button class="btn sec" id="openHomeBtn">Apri Home</button>
      </div>
    </div>

  </div>
</div>

<script src="app.js"></script>
<script>
/* PWA register */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./service-worker.js").catch(console.error);
}

/* Base URL */
const base = location.origin + location.pathname.replace(/\/[^\/]*$/, "/");
document.getElementById("baseUrl").textContent = base;

function setText(id, text){ document.getElementById(id).textContent = text || "â€”"; }
function getText(id){ return (document.getElementById(id).textContent || "").trim(); }

/* Clipboard */
async function copyToClipboard(text){
  try{
    await navigator.clipboard.writeText(text);
    return true;
  }catch(e){
    // fallback
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    document.body.removeChild(ta);
    return true;
  }
}
window.copyText = async (id)=>{
  const t = getText(id);
  if(!t || t==="â€”"){ alert("Niente da copiare."); return; }
  await copyToClipboard(t);
  alert("âœ… Copiato");
};
window.openLink = (id)=>{
  const t = getText(id);
  if(!t || t==="â€”"){ alert("Niente da aprire."); return; }
  window.open(t, "_blank", "noopener");
};

/* Load index */
let indexDB = null;

async function loadIndex(){
  try{
    indexDB = await window.SerCucTech.loadIndexSmart();
    const vSel = document.getElementById("vSelect");
    vSel.innerHTML = `<option value="">â€” scegli â€”</option>`;
    Object.keys(indexDB.vetrine || {}).sort().forEach(id=>{
      const rec = indexDB.vetrine[id] || {};
      const opt = document.createElement("option");
      opt.value = id;
      opt.textContent = `${id} â€” ${rec.title || ""}`;
      vSel.appendChild(opt);
    });
    document.getElementById("statusMsg").textContent = "âœ… Index caricato.";
  }catch(e){
    console.error(e);
    document.getElementById("statusMsg").textContent = "âŒ Non riesco a caricare data/index.json";
  }
}
document.getElementById("reloadBtn").onclick = loadIndex;

/* Build links */
function buildLinksForId(id){
  const clean = window.SerCucTech.sanitizeId(id);
  if(!clean) return null;

  const publicLink = base + "vetrina.html?id=" + encodeURIComponent(clean);
  const jsonLink   = base + "data/" + clean + ".json";
  const mediaFolder = base + "media/";
  const filesFolder = base + "files/";

  setText("publicLink", publicLink);
  setText("jsonLink", jsonLink);
  setText("mediaFolder", mediaFolder);
  setText("filesFolder", filesFolder);

  return { publicLink, jsonLink, mediaFolder, filesFolder };
}

document.getElementById("buildBtn").onclick = ()=>{
  const id = document.getElementById("vSelect").value;
  if(!id){ alert("Seleziona una vetrina"); return; }
  buildLinksForId(id);
  document.getElementById("statusMsg").textContent = "âœ… Link generati.";
};

/* Group link */
document.getElementById("buildGroupBtn").onclick = ()=>{
  const g = window.SerCucTech.sanitizeId(document.getElementById("groupKey").value);
  if(!g){ alert("Inserisci key gruppo"); return; }
  const link = base + "vetrina.html?group=" + encodeURIComponent(g);
  setText("groupLink", link);
  document.getElementById("statusMsg").textContent = "âœ… Link gruppo generato.";
};

/* Copy all */
document.getElementById("copyAllBtn").onclick = async ()=>{
  const pub = getText("publicLink");
  const js  = getText("jsonLink");
  const mf  = getText("mediaFolder");
  const ff  = getText("filesFolder");
  const gl  = getText("groupLink");

  const parts = [];
  if(pub && pub!=="â€”") parts.push("LINK PUBBLICO:\n" + pub);
  if(js && js!=="â€”")  parts.push("JSON:\n" + js);
  if(mf && mf!=="â€”")  parts.push("MEDIA:\n" + mf);
  if(ff && ff!=="â€”")  parts.push("FILES:\n" + ff);
  if(gl && gl!=="â€”")  parts.push("GRUPPO:\n" + gl);

  if(parts.length===0){ alert("Prima genera i link."); return; }
  await copyToClipboard(parts.join("\n\n"));
  alert("âœ… Copiati tutti i link");
};

/* Test links */
async function headOk(url){
  try{
    const res = await fetch(url + (url.includes("?") ? "&" : "?") + "t=" + Date.now(), { method:"GET", cache:"no-store" });
    return res.ok ? { ok:true, code:res.status } : { ok:false, code:res.status };
  }catch(e){
    return { ok:false, code:"ERR" };
  }
}

document.getElementById("testBtn").onclick = async ()=>{
  const out = document.getElementById("testOut");
  out.textContent = "Test in corso...\n";

  const pub = getText("publicLink");
  const js  = getText("jsonLink");
  if(!pub || pub==="â€”" || !js || js==="â€”"){
    out.textContent = "âŒ Prima genera link pubblico + json.\n";
    return;
  }

  const t1 = await headOk(pub);
  out.textContent += `${t1.ok ? "âœ…" : "âŒ"} Pagina vetrina: ${t1.code}\n`;

  const t2 = await headOk(js);
  out.textContent += `${t2.ok ? "âœ…" : "âŒ"} JSON vetrina: ${t2.code}\n`;

  // test index.json
  const idx = base + "data/index.json";
  const t3 = await headOk(idx);
  out.textContent += `${t3.ok ? "âœ…" : "âŒ"} data/index.json: ${t3.code}\n`;

  out.textContent += "\nSe vedi âŒ 404 â†’ file mancante o percorso sbagliato.\nSe vedi ERR â†’ problema rete/cache.\n";
};

/* Quick open */
document.getElementById("openIndexJsonBtn").onclick = ()=> window.open(base+"data/index.json", "_blank", "noopener");
document.getElementById("openHomeBtn").onclick = ()=> location.href = "index.html";

/* Install button */
let deferredPrompt = null;
window.addEventListener("beforeinstallprompt", (e)=>{
  e.preventDefault();
  deferredPrompt = e;
  const btn = document.getElementById("installBtn");
  btn.style.display = "inline-flex";
  btn.onclick = async ()=>{
    try{
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      btn.style.display = "none";
    }catch(err){}
  };
});

/* Init */
loadIndex();
</script>
</body>
</html>
