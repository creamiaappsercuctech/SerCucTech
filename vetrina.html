<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Vetrina</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div id="app"></div>

<script src="app.js"></script>
<script>
function showFull(html){
  const w=document.createElement("div");
  w.className="full";
  w.innerHTML = html + `<div class="hint">Tocca per chiudere</div>`;
  w.onclick=()=>w.remove();
  document.body.appendChild(w);
}

function setMeta(title, desc, imageUrl){
  // OpenGraph base (alcuni client usano solo HTML statico, ma meglio averli)
  const head = document.head;

  const meta = (p,c)=>{ const m=document.createElement("meta"); m.setAttribute(p,c[0]); m.setAttribute("content",c[1]); head.appendChild(m); };

  document.title = title || "Vetrina";
  meta("property",["og:title", title || "SerCucTech Vetrina"]);
  meta("property",["og:description", desc || ""]);
  meta("property",["og:type", "website"]);
  meta("property",["og:url", location.href]);
  if(imageUrl) meta("property",["og:image", imageUrl]);
}

(async function(){
  const id = new URLSearchParams(location.search).get("id");
  if(!id){ app.innerHTML = "<div class='wrap card'>ID mancante</div>"; return; }

  // OG image: se esiste data/ID-cover.jpg
  const cover = `data/${encodeURIComponent(id)}-cover.jpg`;
  setMeta(`SerCucTech – ${id}`, `Vetrina ${id}`, `${location.origin}${location.pathname.replace("vetrina.html","")}${cover}`);

  // 1) prova JSON pubblico
  let v = null;
  let hasPublicJson = false;
  try{
    const r = await fetch(`data/${encodeURIComponent(id)}.json`, {cache:"no-store"});
    if(r.ok){ v = await r.json(); hasPublicJson = true; }
  }catch(e){}

  // 2) fallback localStorage (solo sul tuo telefono)
  if(!v){
    const all = loadAll();
    v = all[id] || null;
  }

  if(!v){
    app.innerHTML = `
      <div class="wrap">
        <div class="card">
          <h3>Vetrina non trovata</h3>
          <div class="small">
            Questa vetrina non è visibile perché non esiste il file pubblico:
            <b>/data/${id}.json</b><br><br>
            ✅ Soluzione (admin): Esporta JSON e caricalo su GitHub in <b>data/${id}.json</b>.
          </div>
        </div>
      </div>`;
    return;
  }

  // Layout fullscreen
  document.body.style.overflow="hidden";
  app.innerHTML = `
    <div style="
      width:100vw;height:100vh;overflow:auto;
      background:${v.bgColor||"#0b1020"};
      font-family:${v.fontFamily||"system-ui"};
      font-size:${v.baseFontSize||16}px;
      padding:16px;
    ">
      <div style="text-align:center;">
        <div style="font-weight:900;font-size:${v.titleSize||32}px;color:${v.titleColor||"#fff"}">
          ${v.title||id}
        </div>
        <div class="small">${v.desc||""}</div>
        ${hasPublicJson ? "" : `<div class="small" style="margin-top:6px;opacity:.75">⚠ Questa vetrina è locale (non pubblicata).</div>`}
      </div>

      <div class="card" style="background:#0b1224">
        <button id="btnSpeak">▶ Ascolta presentazione</button>
        <div class="small">Nota: l’autoplay può essere bloccato dal browser finché non tocchi lo schermo.</div>
      </div>

      <div class="grid" id="grid"></div>
    </div>
  `;

  // Media grid con fullscreen toggle
  const grid = document.getElementById("grid");
  (v.files||[]).forEach(f=>{
    if((f.type||"").startsWith("video")){
      const el=document.createElement("video");
      el.className="thumb";
      el.src=f.data;
      el.muted=true;
      el.controls=true;
      el.onclick=()=>showFull(`<video src="${el.src}" controls autoplay></video>`);
      grid.appendChild(el);
    }else if((f.type||"").startsWith("image")){
      const img=document.createElement("img");
      img.className="thumb";
      img.src=f.data;
      img.onclick=()=>showFull(`<img src="${img.src}">`);
      grid.appendChild(img);
    }
  });

  // Voce (auto + fallback)
  function playVoice(){
    const txt = v.presentationText || "";
    const voice = v.voice || {};
    return speakText(txt, voice);
  }

  document.getElementById("btnSpeak").onclick = () => {
    const ok = playVoice();
    if(!ok) alert("Sintesi vocale non disponibile su questo browser.");
  };

  // Tentativo autoplay
  playVoice();
})();
</script>

</body>
</html>
