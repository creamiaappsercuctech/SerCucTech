<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SerCucTech ‚Äì Vetrina</title>
  <link rel="stylesheet" href="stile.css" />
  <meta name="theme-color" content="#0b1220" />
</head>

<body>
  <div class="appShell" id="appShell">

    <!-- HEADER -->
    <header class="topHeader">
      <div class="badgeLeft" aria-hidden="true"></div>
      <div class="idPill" id="idPill">id: ‚Äî</div>
    </header>

    <!-- HERO (prima schermata) -->
    <section class="hero" id="hero">
      <div class="heroInner">
        <h1 class="heroTitle" id="heroTitle">Vetrina</h1>
        <p class="heroSub" id="heroSub"></p>

        <div class="heroMediaWrap" id="heroMediaWrap">
          <img id="heroImg" class="heroImg" alt="Immagine vetrina" />
          <div class="heroEmpty" id="heroEmpty">
            Nessuna immagine principale disponibile
          </div>
        </div>
      </div>
    </section>

    <!-- CONTENUTO -->
    <main class="content" id="content">
      <section class="card">
        <h2 class="cardTitle">Media</h2>
        <div class="grid" id="mediaGrid"></div>
      </section>

      <section class="card">
        <h2 class="cardTitle">File</h2>
        <div class="files" id="filesList"></div>
      </section>

      <div class="spaceBottom"></div>
    </main>

    <!-- BANNER AUDIO (se autoplay bloccato) -->
    <div class="audioGate" id="audioGate" hidden>
      <div class="audioGateBox">
        <div class="audioGateTitle">Audio bloccato dal telefono</div>
        <div class="audioGateText">Tocca qui per attivare la voce.</div>
        <button class="btnPrimary" id="btnEnableAudio">Attiva audio</button>
      </div>
    </div>

    <!-- BOTTOM BAR -->
    <nav class="bottomBar" id="bottomBar">
      <a class="bBtn" href="index.html" title="Home">üè†<span>Home</span></a>

      <button class="bBtn" id="btnVoice" title="Voce">üîä<span>Voce</span></button>
      <button class="bBtn danger" id="btnStop" title="Stop">‚èπÔ∏è<span>Stop</span></button>

      <button class="bBtn" id="btnFull" title="Schermo intero">‚õ∂<span>Full</span></button>
      <button class="bBtn" id="btnTheme" title="Tema">üåó<span>Tema</span></button>
      <button class="bBtn" id="btnKiosk" title="Kiosk">üß∑<span>Kiosk</span></button>
    </nav>
  </div>

<script>
/* ===================== UTIL ===================== */
function qs(name){
  return new URLSearchParams(location.search).get(name);
}
function esc(s){
  return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
}
function joinUrl(rel){
  // rel tipo "media/renzo11-010.jpg"
  // se rel √® gi√† assoluto lo restituiamo
  if(!rel) return "";
  if(/^https?:\/\//i.test(rel)) return rel;
  return rel.replace(/^\/+/,'');
}

/* ===================== THEME ===================== */
const THEME_KEY = "sercuctech_theme"; // "dark" | "light"
function applyTheme(theme){
  document.documentElement.setAttribute("data-theme", theme);
  localStorage.setItem(THEME_KEY, theme);
  // aggiorna meta theme-color per status bar
  const meta = document.querySelector('meta[name="theme-color"]');
  if(meta){
    meta.setAttribute("content", theme === "light" ? "#f3f6fb" : "#0b1220");
  }
}
function initTheme(){
  const saved = localStorage.getItem(THEME_KEY);
  if(saved === "light" || saved === "dark"){
    applyTheme(saved);
  }else{
    // default: dark
    applyTheme("dark");
  }
}

/* ===================== KIOSK ===================== */
const KIOSK_KEY = "sercuctech_kiosk";
function setKiosk(on){
  localStorage.setItem(KIOSK_KEY, on ? "1":"0");
  document.body.classList.toggle("kiosk", !!on);
}
function initKiosk(){
  setKiosk(localStorage.getItem(KIOSK_KEY)==="1");
}

/* ===================== FULLSCREEN ===================== */
async function goFull(){
  try{
    const el = document.documentElement;
    if(!document.fullscreenElement){
      await el.requestFullscreen();
    }else{
      await document.exitFullscreen();
    }
  }catch(e){
    // ignora
  }
}

/* ===================== SPEECH ===================== */
let lastSpokenText = "";
let autoSpokenOnceKey = ""; // per id vetrina
function stopSpeech(){
  try{ speechSynthesis.cancel(); }catch(e){}
}

function speakText(text, lang){
  if(!text) return false;
  if(!("speechSynthesis" in window)) return false;

  try{
    stopSpeech();

    const u = new SpeechSynthesisUtterance(text);

    // lingua
    u.lang = lang || navigator.language || "it-IT";

    // piccoli tweak per scorrevolezza
    u.rate = 1.12;   // un filo pi√π veloce = meno ‚Äúpause‚Äù
    u.pitch = 1.0;
    u.volume = 1.0;

    speechSynthesis.speak(u);
    lastSpokenText = text;
    return true;
  }catch(e){
    return false;
  }
}

// Prova autoplay: se fallisce (alcuni Android), mostra ‚ÄúaudioGate‚Äù
function tryAutoSpeakOnce(text, lang, uniqueKey){
  const already = localStorage.getItem(uniqueKey)==="1";
  if(already) return;

  // tenta subito
  const ok = speakText(text, lang);
  if(ok){
    localStorage.setItem(uniqueKey,"1");
    return;
  }

  // fallback: mostra pulsante
  const gate = document.getElementById("audioGate");
  gate.hidden = false;

  document.getElementById("btnEnableAudio").onclick = ()=>{
    gate.hidden = true;
    const ok2 = speakText(text, lang);
    if(ok2) localStorage.setItem(uniqueKey,"1");
  };
}

/* ===================== RENDER ===================== */
function renderMediaGrid(media){
  const grid = document.getElementById("mediaGrid");
  grid.innerHTML = "";

  if(!Array.isArray(media) || media.length===0){
    grid.innerHTML = `<div class="muted">Nessun media</div>`;
    return;
  }

  for(const m of media){
    const type = m.type || "image";
    const url  = joinUrl(m.url || "");
    const label = m.label || "";

    if(type === "image"){
      const card = document.createElement("button");
      card.className = "mediaCard";
      card.type = "button";
      card.innerHTML = `
        <img class="mediaThumb" src="${esc(url)}" alt="${esc(label||'immagine')}" loading="lazy">
        <div class="mediaLabel">${esc(label)}</div>
      `;
      card.onclick = ()=>{
        // quando clicchi, mette l'immagine in HERO (prima pagina) e scrolla su
        const heroImg = document.getElementById("heroImg");
        const heroEmpty = document.getElementById("heroEmpty");
        heroImg.src = url;
        heroImg.style.display = "block";
        heroEmpty.style.display = "none";
        window.scrollTo({top:0, behavior:"smooth"});
      };
      grid.appendChild(card);
    }else{
      const box = document.createElement("div");
      box.className = "fileRow";
      box.innerHTML = `
        <div class="fileIcon">üìé</div>
        <div class="fileInfo">
          <div class="fileName">${esc(label || type)}</div>
          <div class="fileSub">${esc(url)}</div>
        </div>
        <a class="fileOpen" href="${esc(url)}" target="_blank" rel="noopener">Apri</a>
      `;
      grid.appendChild(box);
    }
  }
}

function renderFiles(files){
  const list = document.getElementById("filesList");
  list.innerHTML = "";

  if(!Array.isArray(files) || files.length===0){
    list.innerHTML = `<div class="muted">Nessun file</div>`;
    return;
  }

  for(const f of files){
    const url = joinUrl(f.url || "");
    const label = f.label || "File";
    const row = document.createElement("div");
    row.className = "fileRow";
    row.innerHTML = `
      <div class="fileIcon">üìÑ</div>
      <div class="fileInfo">
        <div class="fileName">${esc(label)}</div>
        <div class="fileSub">${esc(url)}</div>
      </div>
      <a class="fileOpen" href="${esc(url)}" target="_blank" rel="noopener">Apri</a>
    `;
    list.appendChild(row);
  }
}

/* ===================== LOAD VETRINA ===================== */
async function loadVetrina(){
  const id = (qs("id") || "").trim();
  const idPill = document.getElementById("idPill");
  idPill.textContent = id ? `id: ${id}` : "id: ‚Äî";

  if(!id){
    document.getElementById("heroTitle").textContent = "Manca id";
    document.getElementById("heroSub").textContent = "Apri cos√¨: vetrina.html?id=renzo11";
    return;
  }

  // carico JSON
  const url = `data/${encodeURIComponent(id)}.json?ts=${Date.now()}`;
  let data;
  try{
    const r = await fetch(url, {cache:"no-store"});
    if(!r.ok) throw new Error("HTTP "+r.status);
    data = await r.json();
  }catch(e){
    document.getElementById("heroTitle").textContent = "Errore caricamento";
    document.getElementById("heroSub").textContent = `Non riesco a leggere ${url}`;
    return;
  }

  // Titolo centrale richiesto
  // Se vuoi ‚Äúsempre fisso‚Äù, lasciamo cos√¨. Altrimenti potresti usare: `${data.title} con SerCucTech`
  const title = (id === "renzo11")
    ? "Bazar di Bostone con SerCucTech"
    : `${data.title || id} con SerCucTech`;

  document.getElementById("heroTitle").textContent = title;
  document.getElementById("heroSub").textContent = data.description || "";

  // HERO IMAGE = prima immagine del media
  const heroImg = document.getElementById("heroImg");
  const heroEmpty = document.getElementById("heroEmpty");

  const firstImg = Array.isArray(data.media) ? data.media.find(x => (x.type||"image")==="image" && x.url) : null;
  if(firstImg){
    heroImg.src = joinUrl(firstImg.url);
    heroImg.style.display = "block";
    heroEmpty.style.display = "none";
  }else{
    heroImg.style.display = "none";
    heroEmpty.style.display = "grid";
  }

  renderMediaGrid(data.media || []);
  renderFiles(data.files || []);

  // AUDIO: testo voce + anti-pause consigliato
  const voice = data.voice || {};
  const voiceLang = voice.lang || "it-IT";
  const voiceText = (voice.text || "").trim();

  // autoplay solo la prima volta per questa vetrina (salvato in localStorage)
  autoSpokenOnceKey = `sercuctech_autovoice_${id}`;
  if(voiceText){
    tryAutoSpeakOnce(voiceText, voiceLang, autoSpokenOnceKey);
  }

  // bottoni
  document.getElementById("btnVoice").onclick = ()=>{
    if(voiceText) speakText(voiceText, voiceLang);
  };
  document.getElementById("btnStop").onclick = ()=>stopSpeech();
}

(function init(){
  initTheme();
  initKiosk();

  document.getElementById("btnTheme").onclick = ()=>{
    const cur = document.documentElement.getAttribute("data-theme") || "dark";
    applyTheme(cur === "dark" ? "light" : "dark");
  };

  document.getElementById("btnFull").onclick = ()=>goFull();

  document.getElementById("btnKiosk").onclick = ()=>{
    const now = localStorage.getItem(KIOSK_KEY)==="1";
    setKiosk(!now);
  };

  loadVetrina();
})();
</script>
</body>
</html>
