<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>SerCucTech â€” Vetrina</title>

  <link rel="stylesheet" href="stile.css" />

  <!-- PWA (non rompe se mancano i file) -->
  <link rel="manifest" href="manifest.webmanifest" />
</head>

<body>
  <header class="topBar">
    <a class="chipBtn" href="index.html" aria-label="Home">ğŸ  Home</a>
    <div class="topTitle" id="topTitle">SerCucTech</div>
    <div class="topRight">
      <span class="chip" id="chipId">id: â€”</span>
    </div>
  </header>

  <main class="page">
    <section class="hero">
      <h1 class="heroTitle" id="heroTitle">Caricamentoâ€¦</h1>
      <p class="heroDesc" id="heroDesc">Attendiâ€¦</p>
    </section>

    <!-- GALLERY (scorrevole) -->
    <section class="galleryWrap" id="galleryWrap" hidden>
      <div class="gallery" id="gallery"></div>
      <div class="galleryDots" id="galleryDots" aria-hidden="true"></div>
    </section>

    <!-- FILES -->
    <section class="card" id="filesCard" hidden>
      <div class="cardTitle">File</div>
      <div class="list" id="filesList"></div>
    </section>

    <section class="card" id="infoCard" hidden>
      <div class="cardTitle">Info</div>
      <div class="muted" id="infoMeta"></div>
    </section>
  </main>

  <!-- SHARE WHATSAPP (sopra barra inferiore) -->
  <div class="shareWhatsApp" id="shareWhatsApp" hidden>
    <button id="btnShareWA" type="button">ğŸ“² Condividi questa vetrina su WhatsApp</button>
  </div>

  <!-- AUDIO BLOCKED OVERLAY -->
  <div class="audioGate" id="audioGate" hidden>
    <div class="audioGateCard">
      <div class="audioGateTitle">Audio bloccato dal telefono</div>
      <div class="audioGateText">Tocca qui per attivare la voce (poi partirÃ  in automatico).</div>
      <button id="btnEnableAudio" type="button">Attiva audio</button>
      <button id="btnSkipAudio" type="button" class="ghost">Non ora</button>
    </div>
  </div>

  <!-- BOTTOM BAR -->
  <nav class="bottomBar" aria-label="Azioni">
    <button class="navBtn" id="btnVoice" type="button">ğŸ”Š<span>Voce</span></button>
    <button class="navBtn" id="btnStop" type="button">â¹ï¸<span>Stop</span></button>
    <button class="navBtn" id="btnFull" type="button">â›¶<span>Full</span></button>
    <button class="navBtn" id="btnTheme" type="button">ğŸŒ“<span>Tema</span></button>
    <button class="navBtn" id="btnKiosk" type="button">ğŸ“Œ<span>Kiosk</span></button>
  </nav>

<script>
/* ===================== UTIL ===================== */
function qs(name){
  const u = new URL(location.href);
  return u.searchParams.get(name);
}
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;");
}
function nowIso(){
  try{ return new Date().toISOString(); }catch(e){ return ""; }
}

/* ===================== THEME ===================== */
const THEME_KEY = "sercuctech_theme";
function applyTheme(mode){
  document.documentElement.setAttribute("data-theme", mode);
  localStorage.setItem(THEME_KEY, mode);
}
(function initTheme(){
  const saved = localStorage.getItem(THEME_KEY);
  if(saved === "light" || saved === "dark") applyTheme(saved);
  else {
    const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
    applyTheme(prefersDark ? "dark" : "light");
  }
})();

/* ===================== SPEECH (1 UTTERANCE = NO PAUSE) ===================== */
let voiceUnlocked = false;
let isSpeaking = false;

function speechAvailable(){
  return ("speechSynthesis" in window) && ("SpeechSynthesisUtterance" in window);
}

function stopSpeech(){
  try{ speechSynthesis.cancel(); }catch(e){}
  isSpeaking = false;
}

function speakOnce(text, lang){
  if(!speechAvailable()) return false;
  if(!text) return false;
  try{
    stopSpeech();
    const u = new SpeechSynthesisUtterance(String(text));
    u.lang = lang || (navigator.language || "it-IT");
    u.rate = 1.03;   // leggermente piÃ¹ veloce, meno â€œpauseâ€
    u.pitch = 1.0;
    u.volume = 1.0;
    u.onend = ()=>{ isSpeaking = false; };
    u.onerror = ()=>{ isSpeaking = false; };
    isSpeaking = true;
    speechSynthesis.speak(u);
    return true;
  }catch(e){
    return false;
  }
}

/* ===================== FULLSCREEN + KIOSK ===================== */
let kioskOn = false;
let wakeLockObj = null;

async function requestWakeLock(){
  try{
    if("wakeLock" in navigator && !wakeLockObj){
      wakeLockObj = await navigator.wakeLock.request("screen");
      wakeLockObj.addEventListener("release", ()=>{ wakeLockObj = null; });
    }
  }catch(e){}
}
async function releaseWakeLock(){
  try{
    if(wakeLockObj){
      await wakeLockObj.release();
      wakeLockObj = null;
    }
  }catch(e){}
}

async function enterFullscreen(){
  const el = document.documentElement;
  try{
    if(el.requestFullscreen) await el.requestFullscreen();
  }catch(e){}
}
async function exitFullscreen(){
  try{
    if(document.exitFullscreen) await document.exitFullscreen();
  }catch(e){}
}
function isFullscreen(){
  return !!document.fullscreenElement;
}

/* ===================== SHARE ===================== */
function setupShareButton(title){
  const shareWrap = document.getElementById("shareWhatsApp");
  const btnShareWA = document.getElementById("btnShareWA");
  if(!shareWrap || !btnShareWA) return;

  shareWrap.hidden = false;

  btnShareWA.onclick = () => {
    const url = location.href;
    const msg = `${title}\nGuarda la vetrina:\n${url}`;
    const waUrl = `https://wa.me/?text=${encodeURIComponent(msg)}`;
    window.open(waUrl, "_blank", "noopener");
  };
}

/* ===================== GALLERY ===================== */
function buildGallery(mediaList){
  const wrap = document.getElementById("galleryWrap");
  const g = document.getElementById("gallery");
  const dots = document.getElementById("galleryDots");
  g.innerHTML = "";
  dots.innerHTML = "";

  const images = (mediaList || []).filter(x => (x && (x.type==="image" || !x.type) && x.url));

  if(images.length === 0){
    wrap.hidden = true;
    return;
  }

  wrap.hidden = false;

  images.forEach((m, idx)=>{
    const card = document.createElement("div");
    card.className = "gItem";

    const img = document.createElement("img");
    img.loading = idx===0 ? "eager" : "lazy";
    img.decoding = "async";
    img.alt = m.label ? String(m.label) : ("Foto " + (idx+1));
    img.src = m.url; // es: media/renzo11-010.jpg
    card.appendChild(img);

    if(m.label){
      const cap = document.createElement("div");
      cap.className = "gCap";
      cap.textContent = m.label;
      card.appendChild(cap);
    }

    g.appendChild(card);

    const dot = document.createElement("span");
    dot.className = "dot" + (idx===0 ? " on" : "");
    dot.onclick = ()=> {
      const w = g.clientWidth;
      g.scrollTo({ left: idx * w, behavior: "smooth" });
    };
    dots.appendChild(dot);
  });

  // update dots on scroll
  g.addEventListener("scroll", ()=>{
    const w = g.clientWidth || 1;
    const idx = clamp(Math.round(g.scrollLeft / w), 0, images.length-1);
    [...dots.children].forEach((d,i)=> d.classList.toggle("on", i===idx));
  }, { passive:true });
}

/* ===================== FILE LIST ===================== */
function buildFiles(filesList){
  const card = document.getElementById("filesCard");
  const list = document.getElementById("filesList");
  list.innerHTML = "";

  const files = (filesList || []).filter(x => x && x.url);
  if(files.length === 0){
    card.hidden = true;
    return;
  }
  card.hidden = false;

  files.forEach(f=>{
    const a = document.createElement("a");
    a.className = "fileRow";
    a.href = f.url;
    a.target = "_blank";
    a.rel = "noopener";
    a.innerHTML = `<span class="fileIcon">ğŸ“„</span><span class="fileName">${escapeHtml(f.label || f.url)}</span><span class="fileGo">Apri</span>`;
    list.appendChild(a);
  });
}

/* ===================== LOAD DATA ===================== */
async function loadVetrina(){
  const id = (qs("id") || "").trim();
  const chip = document.getElementById("chipId");
  chip.textContent = "id: " + (id || "â€”");

  if(!id){
    document.getElementById("heroTitle").textContent = "Manca id";
    document.getElementById("heroDesc").textContent = "Apri cosÃ¬: vetrina.html?id=renzo11";
    return null;
  }

  const url = `data/${encodeURIComponent(id)}.json`;
  try{
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    return data;
  }catch(e){
    document.getElementById("heroTitle").textContent = "Errore caricamento";
    document.getElementById("heroDesc").textContent = `Non riesco a leggere ${url}`;
    return null;
  }
}

/* ===================== AUDIO AUTOSTART (FIRST TIME) ===================== */
function shouldAutoPlay(id){
  // autoplay SOLO la prima volta per quella vetrina, poi non disturba piÃ¹
  const key = "sercuctech_autoplay_done_" + id;
  if(localStorage.getItem(key) === "1") return false;
  localStorage.setItem(key, "1");
  return true;
}

function showAudioGate(onEnable){
  const gate = document.getElementById("audioGate");
  const btn = document.getElementById("btnEnableAudio");
  const skip = document.getElementById("btnSkipAudio");
  gate.hidden = false;

  btn.onclick = async ()=>{
    gate.hidden = true;
    voiceUnlocked = true;
    try{ await enterFullscreen(); }catch(e){}
    onEnable && onEnable();
  };
  skip.onclick = ()=>{
    gate.hidden = true;
  };
}

/* ===================== MAIN ===================== */
(async function init(){
  // service worker (se esiste)
  try{
    if("serviceWorker" in navigator){
      navigator.serviceWorker.register("sw.js").catch(()=>{});
    }
  }catch(e){}

  const data = await loadVetrina();
  if(!data) return;

  // TITOLO CENTRALE richiesto:
  const titleNice = `${data.title || data.id || "Vetrina"} con SerCucTech`;
  document.title = titleNice;
  document.getElementById("topTitle").textContent = "SerCucTech";
  document.getElementById("heroTitle").textContent = titleNice;
  document.getElementById("heroDesc").textContent = data.description || "";

  // Gallery + files
  buildGallery(data.media || []);
  buildFiles(data.files || []);

  // info
  const infoCard = document.getElementById("infoCard");
  const infoMeta = document.getElementById("infoMeta");
  infoCard.hidden = false;
  infoMeta.textContent = `Aggiornato: ${(data.updatedAt || data.createdAt || nowIso())}`;

  // Share button
  setupShareButton(titleNice);

  // ===== Buttons bottom bar =====
  const btnVoice = document.getElementById("btnVoice");
  const btnStop  = document.getElementById("btnStop");
  const btnFull  = document.getElementById("btnFull");
  const btnTheme = document.getElementById("btnTheme");
  const btnKiosk = document.getElementById("btnKiosk");

  // testo audio: 1 sola frase lunga = meno pause
  const voiceLang = (data.voice && data.voice.lang) ? data.voice.lang : (navigator.language || "it-IT");
  const voiceText = (data.voice && data.voice.text) ? String(data.voice.text) : "";
  const combinedText = [data.description || "", voiceText].filter(Boolean).join(" ").replace(/\s+/g," ").trim();

  function playVoice(){
    if(!combinedText) return;
    const ok = speakOnce(combinedText, voiceLang);
    if(!ok){
      alert("Sintesi vocale non disponibile su questo browser.");
    }
  }

  btnVoice.onclick = () => {
    // su mobile, spesso serve un gesto utente: questo Ã¨ un gesto valido
    voiceUnlocked = true;
    playVoice();
  };

  btnStop.onclick = () => stopSpeech();

  btnFull.onclick = async () => {
    if(isFullscreen()) await exitFullscreen();
    else await enterFullscreen();
  };

  btnTheme.onclick = () => {
    const cur = document.documentElement.getAttribute("data-theme") || "dark";
    applyTheme(cur === "dark" ? "light" : "dark");
  };

  btnKiosk.onclick = async () => {
    kioskOn = !kioskOn;
    document.body.classList.toggle("kioskOn", kioskOn);

    if(kioskOn){
      await enterFullscreen();
      await requestWakeLock();
      btnKiosk.classList.add("active");
    }else{
      await releaseWakeLock();
      btnKiosk.classList.remove("active");
    }
  };

  // ===== AUTO AUDIO on open (first time) =====
  // Nota: su Android Chrome spesso NON parte senza click: allora mostriamo popup.
  const vid = (data.id || qs("id") || "vetrina").trim();
  const wantAutoplay = combinedText && shouldAutoPlay(vid);

  if(wantAutoplay){
    // prova autoplay
    const ok = speakOnce(combinedText, voiceLang);
    if(!ok){
      // speech non disponibile: niente
    } else {
      // se il browser blocca, in genere non parte: mostriamo gate
      // (non possiamo rilevarlo al 100%, quindi mettiamo gate â€œintelligenteâ€)
      setTimeout(()=>{
        // se dopo 700ms non sta parlando -> mostra gate
        if(!isSpeaking){
          showAudioGate(()=>playVoice());
        }
      }, 700);
    }
  }

})();
</script>
</body>
</html>
