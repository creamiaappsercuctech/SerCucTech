<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Vetrina</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div id="app"></div>

<script src="app.js"></script>
<script>
function showFull(html){
  const w=document.createElement("div");
  w.className="full";
  w.innerHTML = html + `<div class="hint">Tocca per chiudere</div>`;
  w.onclick=()=>w.remove();
  document.body.appendChild(w);
}

async function loadPublic(id){
  try{
    const r = await fetch(`data/${encodeURIComponent(id)}.json`, {cache:"no-store"});
    if(r.ok) return await r.json();
  }catch(e){}
  return null;
}

(async function(){
  const id = new URLSearchParams(location.search).get("id");
  if(!id){ app.innerHTML="<div class='wrap card'>ID mancante</div>"; return; }

  let v = await loadPublic(id);
  let localUrls = [];

  if(!v){
    const local = await idbGetVetrina(id);
    if(local){
      const filesLocal = (local.files||[]).map(f=>{
        const url = URL.createObjectURL(f.blob);
        localUrls.push(url);
        return { name:f.name, type:f.type, url };
      });
      const bgUrl = local.bgBlob ? URL.createObjectURL(local.bgBlob) : null;
      if(bgUrl) localUrls.push(bgUrl);

      v = {
        title: local.title, desc: local.desc,
        fontFamily: local.fontFamily, baseFontSize: local.baseFontSize,
        titleSize: local.titleSize, titleColor: local.titleColor,
        bgColor: local.bgColor,
        bgUrl,
        presentationText: local.presentationText,
        voice: local.voice,
        filesLocal
      };
    }
  }

  if(!v){
    app.innerHTML = `<div class="wrap card">
      Vetrina <b>${escapeHtml(id)}</b> non trovata.<br><br>
      <div class="small">Pubblica: <b>data/${escapeHtml(id)}.json</b></div>
    </div>`;
    return;
  }

  const bg = v.bgImage ? `background-image:url(${v.bgImage});`
           : v.bgUrl ? `background-image:url(${v.bgUrl});` : "";

  app.innerHTML = `
    <div style="
      width:100vw;height:100vh;overflow:auto;
      ${bg}
      background-size:cover;background-position:center;
      background-color:${v.bgColor||"#0b1020"};
      font-family:${v.fontFamily||"system-ui"};
      font-size:${v.baseFontSize||16}px;
      padding:16px;
    ">
      <div style="text-align:center;background:rgba(0,0,0,.35);border-radius:12px;padding:12px">
        <div style="font-weight:900;font-size:${v.titleSize||32}px;color:${v.titleColor||"#fff"}">
          ${escapeHtml(v.title||id)}
        </div>
        <div class="small">${escapeHtml(v.desc||"")}</div>
      </div>

      <div class="card" style="background:rgba(11,18,36,.85)">
        <button id="btnSpeak">▶ Ascolta presentazione</button>
        <div class="small">Se autoplay è bloccato, premi il pulsante.</div>
      </div>

      <div class="grid" id="grid"></div>
    </div>
  `;

  const grid = document.getElementById("grid");

  const items = v.files
    ? v.files.map(f=>({type:f.type, src:f.data}))
    : (v.filesLocal||[]).map(f=>({type:f.type, src:f.url}));

  items.forEach(f=>{
    if((f.type||"").startsWith("video/")){
      const el=document.createElement("video");
      el.className="thumb";
      el.src=f.src;
      el.muted=true;
      el.controls=true;
      el.onclick=()=>showFull(`<video src="${el.src}" controls autoplay></video>`);
      grid.appendChild(el);
    }else if((f.type||"").startsWith("image/")){
      const img=document.createElement("img");
      img.className="thumb";
      img.src=f.src;
      img.onclick=()=>showFull(`<img src="${img.src}">`);
      grid.appendChild(img);
    }
  });

  function playVoice(){
    const txt = v.presentationText || "";
    const voice = v.voice || {};
    return speakText(txt, voice);
  }

  document.getElementById("btnSpeak").onclick=()=>{
    const ok=playVoice();
    if(!ok) alert("Sintesi vocale non disponibile.");
  };

  playVoice();

  window.addEventListener("beforeunload", ()=>{
    localUrls.forEach(u=>URL.revokeObjectURL(u));
  });
})();
</script>
</body>
</html>
