<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Vetrina</title>
  <link rel="stylesheet" href="style.css?v=4">

  <!-- EXTRA stile: bottoni fissi + archivio -->
  <style>
    .waDock2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      width:100%;
      max-width:980px;
      margin:0 auto;
    }
    .waBtnFix{
      border:none;
      background:#25D366;
      color:#06210f;
      font-weight:1000;
      padding:12px 12px;
      border-radius:14px;
      cursor:pointer;
      user-select:none;
    }
    .waBtnFix:active{transform:scale(.99)}
    .waBtnFix.gray{
      background:rgba(255,255,255,.12);
      color:#fff;
      border:1px solid rgba(255,255,255,.18);
    }

    .waPhotoBtns{
      position:absolute;
      right:10px;
      bottom:10px;
      z-index:50;
      display:grid;
      gap:8px;
    }
    .waPhotoBtn{
      border:none;
      background:#25D366;
      color:#06210f;
      font-weight:1000;
      padding:10px 12px;
      border-radius:14px;
      box-shadow:0 10px 22px rgba(0,0,0,.35);
      cursor:pointer;
      user-select:none;
      text-align:left;
      line-height:1.15;
      min-width:180px;
    }
    .waPhotoBtn small{font-size:11px;opacity:.9}
    .waPhotoBtn:active{transform:scale(.99)}
    .waPhotoBtn.gray{
      background:rgba(255,255,255,.12);
      color:#fff;
      border:1px solid rgba(255,255,255,.18);
      box-shadow:0 10px 22px rgba(0,0,0,.25);
    }

    .archiveTools{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media(max-width:520px){ .archiveTools{grid-template-columns:1fr} }

    .archBtn{
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.22);
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      font-weight:1000;
      cursor:pointer;
      user-select:none;
    }
    .archBtn:active{transform:scale(.99)}
    .archBtn.danger{border-color:rgba(255,90,90,.35); background:rgba(255,90,90,.12)}

    .archList{
      display:grid;
      gap:10px;
      margin-top:12px;
    }
    .archItem{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      border-radius:16px;
      padding:12px;
      display:grid;
      gap:8px;
    }
    .archTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .archMeta{
      font-weight:1000;
      font-size:12px;
      opacity:.9;
    }
    .archType{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      font-weight:1000;
      font-size:12px;
    }
    .archText{
      white-space:pre-wrap;
      font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:12px;
      opacity:.95;
      line-height:1.35;
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.22);
      overflow:auto;
      max-height:220px;
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brandDot" aria-hidden="true"></div>

      <div class="titleWrap">
        <h1 id="pageTitle" class="pageTitle">Caricamento‚Ä¶</h1>
        <p id="pageDesc" class="pageDesc"></p>
      </div>

      <span id="badgeId" class="idBadge">id: -</span>
    </div>

    <!-- TESTO AUDIO FISSO + CONTATTI -->
    <section class="voicePanel" id="voicePanel" hidden>
      <div class="voicePanelInner">
        <div class="voiceTop">
          <div class="voiceTitle">üì£ Messaggio (tocca ‚ÄúVoice‚Äù per ascoltare)</div>
          <div class="voiceHint">Contatti (fissi): WhatsApp o chiamata</div>
        </div>

        <div class="voiceText" id="voiceText"></div>

        <div class="contactsRow" id="contactsRow"></div>
        <div class="contactsHint">üëâ Tocca un numero per contattare subito</div>
      </div>
    </section>
  </header>

  <main class="content">
    <!-- GALLERIA -->
    <section class="card heroCard">
      <div class="hero">
        <button class="navBtn left" id="prevBtn" aria-label="Immagine precedente">‚Äπ</button>

        <div class="mediaStage" id="mediaStage">
          <div class="imgCounter" id="imgCounter">01/01</div>

          <div class="imgWrap" id="imgWrap">
            <img id="heroImg" class="heroImg" alt="Immagine vetrina">
            <div id="pinsLayer" class="pinsLayer" aria-hidden="true"></div>
          </div>

          <div class="imgBadge" id="imgBadge">01</div>

          <!-- ‚úÖ 2 bottoni fissi per WhatsApp FOTO -->
          <div class="waPhotoBtns" id="waPhotoBtns">
            <button class="waPhotoBtn" id="waPhotoRenzo" type="button">
              üü¢ WhatsApp Renzo<br><small>info numero foto corrente</small>
            </button>
            <button class="waPhotoBtn" id="waPhotoSergio" type="button">
              üü¢ WhatsApp Sergio<br><small>info numero foto corrente</small>
            </button>
          </div>
        </div>

        <button class="navBtn right" id="nextBtn" aria-label="Immagine successiva">‚Ä∫</button>
      </div>

      <div class="thumbRow" id="thumbRow"></div>

      <div class="smallHint">
        Swipe sull‚Äôimmagine ‚Ä¢ Tap = schermo intero ‚Ä¢ Tap di nuovo = normale
        <br>
        <span class="smallHint2">Modalit√† numerini: tap rapido sul titolo 5 volte (solo sul tuo telefono)</span>
      </div>
    </section>

    <!-- ‚úÖ ARCHIVIO RICHIESTE INFO -->
    <section class="card" id="archiveCard">
      <h2 class="h2">üóÇ Archivio richieste info</h2>
      <div class="smallHint" id="archHint">
        Qui trovi tutte le richieste inviate (salvate sul tuo dispositivo): data, ora, giorno e testo.
      </div>

      <div class="archiveTools">
        <button class="archBtn" id="archCopyBtn">üìã Copia tutto</button>
        <button class="archBtn" id="archExportBtn">‚¨áÔ∏è Export JSON</button>
        <button class="archBtn danger" id="archClearBtn">üßπ Pulisci archivio</button>
      </div>

      <div class="archList" id="archList"></div>
    </section>

    <!-- ‚úÖ INDICE ALTRE VETRINE (AUTO-AGGIORNANTE) -->
    <section class="card" id="networkCard">
      <h2 class="h2">üîó Altre vetrine</h2>
      <div class="smallHint" style="margin-top:6px">
        Questo indice si aggiorna da <b>data/vetrine.json</b>.
        Usa i <b>tag</b> nelle vetrine per contesti (servizi, attivit√†, abbigliamento‚Ä¶).
      </div>

      <div id="netFilters" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px"></div>
      <div id="netList" style="display:grid;gap:10px;margin-top:12px"></div>
      <div class="smallHint" id="netHint" style="margin-top:10px;opacity:.9"></div>
    </section>

    <!-- FILES -->
    <section class="card" id="filesCard" hidden>
      <h2 class="h2">Files</h2>
      <div id="filesList" class="filesList"></div>
    </section>

    <!-- LABEL TOOL -->
    <section class="card labelCard" id="labelCard" hidden>
      <div class="labelHead">
        <h2 class="h2" style="margin:0">üß∑ Numerini manuali sugli oggetti</h2>
        <span class="labelBadge" id="labelModeBadge">OFF</span>
      </div>

      <div class="labelControls">
        <button class="labelBtn" id="labelToggleBtn">Attiva/Disattiva</button>
        <button class="labelBtn" id="labelUndoBtn">Annulla ultimo</button>
        <button class="labelBtn danger" id="labelClearBtn">Pulisci tutti</button>
      </div>

      <div class="labelSliderRow">
        <div class="labelSliderTitle">Grandezza numerino</div>
        <input type="range" id="pinSizeRange" min="14" max="64" value="28">
        <div class="labelSliderValue"><span id="pinSizeValue">28</span> px</div>
      </div>

      <div class="labelExportRow">
        <button class="labelBtn" id="exportPinsBtn">Export JSON (pins)</button>
        <button class="labelBtn" id="copyPinsBtn">Copia JSON</button>
      </div>

      <textarea id="pinsJsonBox" class="pinsJsonBox" placeholder="Qui comparir√† il JSON dei pins‚Ä¶"></textarea>

      <div class="labelTip">
        ‚úÖ Quando la modalit√† √® attiva: tocca l‚Äôimmagine per piazzare un numerino (1,2,3‚Ä¶).<br>
        ‚úÖ I numerini restano salvati sul tuo telefono (localStorage).<br>
        ‚úÖ Gli utenti vedono i numerini SOLO se tu li esporti e li metti nel JSON.
      </div>
    </section>
  </main>

  <!-- ‚úÖ SHARE sopra la barra: 2 bottoni fissi -->
  <div class="shareDock">
    <div class="waDock2">
      <button class="waBtnFix" id="waVetrinaRenzo">üü¢ WhatsApp Renzo (Vetrina)</button>
      <button class="waBtnFix" id="waVetrinaSergio">üü¢ WhatsApp Sergio (Vetrina)</button>
    </div>
  </div>

  <!-- BOTTOM BAR -->
  <nav class="bottombar" id="bottombar">
    <button class="barBtn" id="homeBtn">Home</button>
    <button class="barBtn" id="voiceBtn">Voice</button>
    <button class="barBtn danger" id="stopBtn">Stop</button>
    <button class="barBtn" id="fullBtn">Full</button>
    <button class="barBtn" id="themeBtn">Tema</button>
    <button class="barBtn" id="kioskBtn">Kiosk</button>
  </nav>

  <!-- AUDIO GATE -->
  <div class="audioGate" id="audioGate" hidden>
    <div class="audioGateCard">
      <div class="audioGateTitle">Audio bloccato dal telefono</div>
      <div class="audioGateText">Tocca ‚ÄúAttiva audio‚Äù. Poi partir√† automaticamente.</div>
      <div class="audioGateBtns">
        <button class="primary" id="enableAudioBtn">Attiva audio</button>
        <button class="ghost" id="skipAudioBtn">Non ora</button>
      </div>
    </div>
  </div>

  <script src="app.js?v=4"></script>

  <!-- ‚úÖ EXTRA: 2 bottoni fissi + archivio richieste + indice vetrine -->
  <script>
  (function(){
    "use strict";

    const daysIT = ["Domenica","Luned√¨","Marted√¨","Mercoled√¨","Gioved√¨","Venerd√¨","Sabato"];

    function getId(){
      const sp = new URLSearchParams(location.search);
      return (sp.get("id") || "").trim() || "renzo11";
    }
    const id = getId();

    const base = location.origin + location.pathname.replace(/vetrina\.html$/,"");
    const shareLink = `${base}link.html?id=${encodeURIComponent(id)}`;

    const badge = document.getElementById("badgeId");
    if(badge) badge.textContent = "id: " + id;

    // ===== Archivio (localStorage) =====
    const ARCH_KEY = `sercuctech_requests_${id}`;

    function loadArchive(){
      try{ return JSON.parse(localStorage.getItem(ARCH_KEY)) || []; }
      catch(e){ return []; }
    }
    function saveArchive(list){
      localStorage.setItem(ARCH_KEY, JSON.stringify(list));
    }
    function nowStamp(){
      const d = new Date();
      const day = daysIT[d.getDay()];
      const date = d.toLocaleDateString("it-IT");
      const time = d.toLocaleTimeString("it-IT", {hour:"2-digit", minute:"2-digit", second:"2-digit"});
      return { day, date, time, iso: d.toISOString() };
    }

    function addArchiveEntry(entry){
      const list = loadArchive();
      list.unshift(entry);           // ultimo in alto
      saveArchive(list);
      renderArchive();
    }

    function exportJsonFile(filename, obj){
      const blob = new Blob([JSON.stringify(obj,null,2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
    }

    async function copyText(t){
      try{ await navigator.clipboard.writeText(t); return true; }
      catch(e){ return false; }
    }

    function renderArchive(){
      const box = document.getElementById("archList");
      if(!box) return;
      const list = loadArchive();

      box.innerHTML = "";
      if(!list.length){
        const empty = document.createElement("div");
        empty.style.opacity = ".85";
        empty.style.fontWeight = "900";
        empty.textContent = "Nessuna richiesta salvata ancora. Premi un bottone WhatsApp e verr√† registrata qui.";
        box.appendChild(empty);
        return;
      }

      list.forEach((r, idx)=>{
        const item = document.createElement("div");
        item.className = "archItem";
        const meta = `${r.day} ‚Ä¢ ${r.date} ‚Ä¢ ${r.time} ‚Ä¢ a: ${r.toName || "?"} (${r.toPhone || "?"})`;
        item.innerHTML = `
          <div class="archTop">
            <div class="archMeta">${meta}</div>
            <div class="archType">${r.type || "RICHIESTA"}</div>
          </div>
          <div class="archText"></div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="archBtn" data-act="copyOne" data-idx="${idx}">Copia</button>
            <button class="archBtn danger" data-act="delOne" data-idx="${idx}">Elimina</button>
          </div>
        `;
        item.querySelector(".archText").textContent = r.message || "";
        item.querySelectorAll("button").forEach(b=>{
          b.addEventListener("click", async ()=>{
            const act = b.getAttribute("data-act");
            const i = Number(b.getAttribute("data-idx"));
            const arr = loadArchive();

            if(act === "copyOne"){
              const ok = await copyText(arr[i]?.message || "");
              alert(ok ? "Copiato ‚úÖ" : "Copia non riuscita");
            }
            if(act === "delOne"){
              arr.splice(i,1);
              saveArchive(arr);
              renderArchive();
            }
          });
        });

        box.appendChild(item);
      });
    }

    // Pulsanti archivio
    document.getElementById("archCopyBtn")?.addEventListener("click", async ()=>{
      const list = loadArchive();
      const txt = list.map(r =>
        `=== ${r.type} ===\n${r.day} ${r.date} ${r.time}\nA: ${r.toName} (${r.toPhone})\n\n${r.message}\n`
      ).join("\n-----------------------------\n");
      const ok = await copyText(txt || "");
      alert(ok ? "Archivio copiato ‚úÖ" : "Copia non riuscita");
    });

    document.getElementById("archExportBtn")?.addEventListener("click", ()=>{
      exportJsonFile(`richieste-${id}.json`, loadArchive());
    });

    document.getElementById("archClearBtn")?.addEventListener("click", ()=>{
      if(confirm("Sicuro di cancellare TUTTO l‚Äôarchivio?")){
        saveArchive([]);
        renderArchive();
      }
    });

    // ===== Carico JSON vetrina per contatti =====
    let CONTACTS = [];
    let TITLE = id;

    async function fetchJson(url){
      const res = await fetch(url, {cache:"no-store"});
      if(!res.ok) throw new Error("HTTP " + res.status);
      return await res.json();
    }

    async function loadVetrinaData(){
      try{
        const j = await fetchJson(`data/${encodeURIComponent(id)}.json`);
        TITLE = (j.title || id).trim();
        CONTACTS = Array.isArray(j.contacts) ? j.contacts : [];

        // scrive testo voice se serve
        const voiceText = document.getElementById("voiceText");
        if(voiceText && j.voice?.text) voiceText.textContent = j.voice.text;

        // render contatti sotto il testo (WhatsApp + Chiama)
        const row = document.getElementById("contactsRow");
        if(row){
          row.innerHTML = "";
          CONTACTS.slice(0,2).forEach(c=>{
            if(!c || !c.phone) return;

            const wa = document.createElement("button");
            wa.className = "contactBtn wa";
            wa.textContent = `WhatsApp ${c.name}`;
            wa.addEventListener("click", ()=> sendWhatsApp("VETRINA", c));

            const call = document.createElement("a");
            call.href = "tel:" + String(c.phone).replace(/\D/g,"");
            call.className = "contactBtn";
            call.textContent = `Chiama ${c.name}`;

            row.appendChild(wa);
            row.appendChild(call);
          });
        }

        // aggiorno etichette bottoni fissi (se mancano contatti)
        applyFixedButtons();
      }catch(e){
        // se json non carica, disabilito bottoni
        applyFixedButtons(true);
      }
    }

    function applyFixedButtons(disableAll=false){
      const c1 = CONTACTS[0];
      const c2 = CONTACTS[1];

      const btnVR = document.getElementById("waVetrinaRenzo");
      const btnVS = document.getElementById("waVetrinaSergio");
      const btnPR = document.getElementById("waPhotoRenzo");
      const btnPS = document.getElementById("waPhotoSergio");

      function setBtn(btn, c, fallbackLabel){
        if(!btn) return;
        if(disableAll || !c || !c.phone){
          btn.textContent = fallbackLabel + " (non configurato)";
          btn.classList.add("gray");
          btn.disabled = true;
          return;
        }
        btn.textContent = fallbackLabel.replace("Renzo", c.name).replace("Sergio", c.name);
        btn.classList.remove("gray");
        btn.disabled = false;
      }

      setBtn(btnVR, c1, "üü¢ WhatsApp Renzo (Vetrina)");
      setBtn(btnVS, c2, "üü¢ WhatsApp Sergio (Vetrina)");
      setBtn(btnPR, c1, "üü¢ WhatsApp Renzo\ninfo numero foto corrente");
      setBtn(btnPS, c2, "üü¢ WhatsApp Sergio\ninfo numero foto corrente");
    }

    // ===== Messaggi =====
    function currentPhotoUrl(){
      const img = document.getElementById("heroImg");
      return (img && (img.currentSrc || img.src)) ? (img.currentSrc || img.src) : "";
    }
    function currentObjNumber(){
      const b = document.getElementById("imgBadge");
      return (b && b.textContent) ? b.textContent.trim() : "??";
    }

    function makeMsgVetrina(toName){
      return `Ciao ${toName}! üëã
Ti mando la vetrina con foto e numeri degli oggetti.

‚úÖ Apri qui:
${shareLink}

üìå Dimmi il numero dell‚Äôoggetto che ti interessa.`;
    }

    function makeMsgFoto(toName){
      const n = currentObjNumber();
      const photo = currentPhotoUrl();
      const photoLine = photo ? `üì∑ Foto: ${photo}` : "";
      return `Ciao ${toName}! üëã
Vorrei informazioni per il numero ${n}.

üè∑Ô∏è Vetrina: ${TITLE}
üîó Link vetrina: ${shareLink}
${photoLine}

‚úÖ Se disponibile, mandatemi prezzo e disponibilit√†.`;
    }

    function openWa(phone, msg){
      const digits = String(phone||"").replace(/\D/g,"");
      const url = digits
        ? `https://wa.me/${digits}?text=${encodeURIComponent(msg)}`
        : `https://wa.me/?text=${encodeURIComponent(msg)}`;
      window.open(url, "_blank");
    }

    function sendWhatsApp(kind, contact){
      const toName = contact?.name || "Contatto";
      const toPhone = contact?.phone || "";
      const msg = (kind === "FOTO") ? makeMsgFoto(toName) : makeMsgVetrina(toName);

      // salva archivio PRIMA di aprire WhatsApp
      const stamp = nowStamp();
      addArchiveEntry({
        type: kind,
        ...stamp,
        toName,
        toPhone,
        message: msg
      });

      openWa(toPhone, msg);
    }

    // ===== Collego i 4 bottoni fissi =====
    document.getElementById("waVetrinaRenzo")?.addEventListener("click", ()=>{
      if(CONTACTS[0]) sendWhatsApp("VETRINA", CONTACTS[0]);
    });
    document.getElementById("waVetrinaSergio")?.addEventListener("click", ()=>{
      if(CONTACTS[1]) sendWhatsApp("VETRINA", CONTACTS[1]);
    });

    document.getElementById("waPhotoRenzo")?.addEventListener("click", ()=>{
      if(CONTACTS[0]) sendWhatsApp("FOTO", CONTACTS[0]);
    });
    document.getElementById("waPhotoSergio")?.addEventListener("click", ()=>{
      if(CONTACTS[1]) sendWhatsApp("FOTO", CONTACTS[1]);
    });

    /* ===================== INDICE ALTRE VETRINE ===================== */
    const netFilters = document.getElementById("netFilters");
    const netList = document.getElementById("netList");
    const netHint = document.getElementById("netHint");
    const DEFAULT_TAGS = ["tutte","servizi","attivit√†","abbigliamento","commercio","casa","auto","altro"];

    function normTag(t){ return String(t||"").trim().toLowerCase(); }

    function filterBtn(label, active){
      const b = document.createElement("button");
      b.type = "button";
      b.textContent = label;
      b.style.border = "1px solid rgba(255,255,255,.18)";
      b.style.background = active ? "rgba(35,197,94,.22)" : "rgba(255,255,255,.08)";
      b.style.color = "rgba(255,255,255,.95)";
      b.style.borderRadius = "999px";
      b.style.padding = "10px 12px";
      b.style.fontWeight = "900";
      b.style.cursor = "pointer";
      b.style.fontSize = "12px";
      return b;
    }

    function cardLink(v){
      const wrap = document.createElement("div");
      wrap.style.border = "1px solid rgba(255,255,255,.14)";
      wrap.style.background = "rgba(0,0,0,.18)";
      wrap.style.borderRadius = "16px";
      wrap.style.padding = "12px";
      wrap.style.display = "grid";
      wrap.style.gap = "8px";

      const a = document.createElement("a");
      a.href = `vetrina.html?id=${encodeURIComponent(v.id)}`;
      a.textContent = `${v.title || v.id}`;
      a.style.color = "rgba(255,255,255,.95)";
      a.style.textDecoration = "none";
      a.style.fontWeight = "1000";

      const meta = document.createElement("div");
      meta.style.fontSize = "12px";
      meta.style.fontWeight = "900";
      meta.style.color = "rgba(234,240,255,.72)";
      meta.textContent = `id: ${v.id}${v.tag ? " ‚Ä¢ " + v.tag : ""}`;

      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.gap = "8px";
      row.style.flexWrap = "wrap";

      const openBtn = document.createElement("a");
      openBtn.href = `vetrina.html?id=${encodeURIComponent(v.id)}`;
      openBtn.textContent = "Apri";
      openBtn.style.textDecoration = "none";
      openBtn.style.border = "1px solid rgba(255,255,255,.18)";
      openBtn.style.background = "rgba(255,255,255,.08)";
      openBtn.style.color = "rgba(255,255,255,.95)";
      openBtn.style.borderRadius = "14px";
      openBtn.style.padding = "10px 12px";
      openBtn.style.fontWeight = "1000";
      openBtn.style.fontSize = "12px";

      row.appendChild(openBtn);

      wrap.appendChild(a);
      wrap.appendChild(meta);
      wrap.appendChild(row);
      return wrap;
    }

    async function loadIndex(){
      try{
        if(!netHint) return;
        netHint.textContent = "Carico elenco vetrine‚Ä¶";
        const idx = await fetchJson("data/vetrine.json");
        const list = Array.isArray(idx.vetrine) ? idx.vetrine : [];

        const baseList = list
          .map(x => ({ id: String(x.id||"").trim(), title: String(x.title||"").trim() }))
          .filter(x => x.id && x.id !== id);

        const enriched = [];
        for(const v of baseList){
          try{
            const j = await fetchJson(`data/${encodeURIComponent(v.id)}.json`);
            const tags = Array.isArray(j.tags) ? j.tags.map(normTag).filter(Boolean) : [];
            const tag = tags[0] || "";
            enriched.push({ ...v, tags, tag });
          }catch(e){
            enriched.push({ ...v, tags:[], tag:"" });
          }
        }

        const tagSet = new Set(DEFAULT_TAGS.map(normTag));
        enriched.forEach(v => (v.tags||[]).forEach(t => tagSet.add(normTag(t))));
        const tagsAll = Array.from(tagSet).filter(Boolean);
        tagsAll.sort((a,b)=>{
          if(a==="tutte") return -1;
          if(b==="tutte") return 1;
          return a.localeCompare(b,"it");
        });

        let currentFilter = "tutte";

        function renderFilters(){
          if(!netFilters) return;
          netFilters.innerHTML = "";
          tagsAll.forEach(t=>{
            const b = filterBtn(t, t===currentFilter);
            b.addEventListener("click", ()=>{
              currentFilter = t;
              renderFilters();
              renderList();
            });
            netFilters.appendChild(b);
          });
        }

        function renderList(){
          if(!netList) return;
          netList.innerHTML = "";
          const filtered = (currentFilter==="tutte")
            ? enriched
            : enriched.filter(v => (v.tags||[]).includes(currentFilter));

          if(!filtered.length){
            const empty = document.createElement("div");
            empty.style.opacity = ".85";
            empty.style.fontWeight = "900";
            empty.textContent = "Nessuna vetrina in questo contesto. (Aggiungi tags nelle vetrine.)";
            netList.appendChild(empty);
            netHint.textContent = `Filtro: ${currentFilter} ‚Ä¢ 0 risultati`;
            return;
          }

          filtered.sort((a,b)=>a.id.localeCompare(b.id,"it",{numeric:true}));
          filtered.forEach(v => netList.appendChild(cardLink(v)));
          netHint.textContent = `Filtro: ${currentFilter} ‚Ä¢ ${filtered.length} vetrine`;
        }

        renderFilters();
        renderList();
      }catch(e){
        if(netHint) netHint.textContent = "Errore: non riesco a leggere data/vetrine.json";
      }
    }

    // Avvio
    renderArchive();
    loadVetrinaData();
    loadIndex();

  })();
  </script>
</body>
</html>
