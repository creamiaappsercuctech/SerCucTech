<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Vetrina</title>
  <link rel="stylesheet" href="style.css?v=2">
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brandDot" aria-hidden="true"></div>

      <div class="titleWrap">
        <h1 id="pageTitle" class="pageTitle">Caricamento‚Ä¶</h1>
        <p id="pageDesc" class="pageDesc"></p>
      </div>

      <span id="badgeId" class="idBadge">id: -</span>
    </div>

    <!-- TESTO AUDIO FISSO + CONTATTI -->
    <section class="voicePanel" id="voicePanel" hidden>
      <div class="voicePanelInner">
        <div class="voiceTop">
          <div class="voiceTitle">üì£ Messaggio (tocca ‚ÄúVoice‚Äù per ascoltare)</div>
          <div class="voiceHint">Numeri cliccabili: WhatsApp o chiamata</div>
        </div>

        <div class="voiceText" id="voiceText"></div>

        <div class="contactsRow" id="contactsRow"></div>
        <div class="contactsHint">üëâ Tocca un numero per contattare subito</div>
      </div>
    </section>
  </header>

  <main class="content">
    <!-- GALLERIA -->
    <section class="card heroCard">
      <div class="hero">
        <button class="navBtn left" id="prevBtn" aria-label="Immagine precedente">‚Äπ</button>

        <div class="mediaStage" id="mediaStage">
          <div class="imgCounter" id="imgCounter">01/01</div>

          <div class="imgWrap" id="imgWrap">
            <img id="heroImg" class="heroImg" alt="Immagine vetrina">
            <!-- pins overlay -->
            <div id="pinsLayer" class="pinsLayer" aria-hidden="true"></div>
          </div>

          <div class="imgBadge" id="imgBadge">01</div>
        </div>

        <button class="navBtn right" id="nextBtn" aria-label="Immagine successiva">‚Ä∫</button>
      </div>

      <div class="thumbRow" id="thumbRow"></div>

      <div class="smallHint">
        Swipe sull‚Äôimmagine ‚Ä¢ Tap = schermo intero ‚Ä¢ Tap di nuovo = normale
        <br>
        <span class="smallHint2">Modalit√† numerini: tap rapido sul titolo 5 volte (solo sul tuo telefono)</span>
      </div>
    </section>

    <!-- ‚úÖ INDICE ALTRE VETRINE (AUTO-AGGIORNANTE) -->
    <section class="card" id="networkCard">
      <h2 class="h2">üîó Altre vetrine</h2>
      <div class="smallHint" style="margin-top:6px">
        Questo indice si aggiorna da <b>data/vetrine.json</b>.
        Usa i <b>tag</b> nelle vetrine per dividerle in contesti (servizi, attivit√†, abbigliamento, commercio, ecc.).
      </div>

      <div id="netFilters" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px"></div>
      <div id="netList" style="display:grid;gap:10px;margin-top:12px"></div>

      <div class="smallHint" id="netHint" style="margin-top:10px;opacity:.9"></div>
    </section>

    <!-- FILES (se li aggiungi nel JSON) -->
    <section class="card" id="filesCard" hidden>
      <h2 class="h2">Files</h2>
      <div id="filesList" class="filesList"></div>
    </section>

    <!-- LABEL TOOL (NASCOSTO) -->
    <section class="card labelCard" id="labelCard" hidden>
      <div class="labelHead">
        <h2 class="h2" style="margin:0">üß∑ Numerini manuali sugli oggetti</h2>
        <span class="labelBadge" id="labelModeBadge">OFF</span>
      </div>

      <div class="labelControls">
        <button class="labelBtn" id="labelToggleBtn">Attiva/Disattiva</button>
        <button class="labelBtn" id="labelUndoBtn">Annulla ultimo</button>
        <button class="labelBtn danger" id="labelClearBtn">Pulisci tutti</button>
      </div>

      <div class="labelSliderRow">
        <div class="labelSliderTitle">Grandezza numerino</div>
        <input type="range" id="pinSizeRange" min="14" max="64" value="28">
        <div class="labelSliderValue"><span id="pinSizeValue">28</span> px</div>
      </div>

      <div class="labelExportRow">
        <button class="labelBtn" id="exportPinsBtn">Export JSON (pins)</button>
        <button class="labelBtn" id="copyPinsBtn">Copia JSON</button>
      </div>

      <textarea id="pinsJsonBox" class="pinsJsonBox" placeholder="Qui comparir√† il JSON dei pins‚Ä¶"></textarea>

      <div class="labelTip">
        ‚úÖ Quando la modalit√† √® attiva: tocca l‚Äôimmagine per piazzare un numerino (1,2,3‚Ä¶).<br>
        ‚úÖ I numerini restano salvati sul tuo telefono (localStorage).<br>
        ‚úÖ Gli utenti che aprono il link vedono i numerini SOLO se tu li hai esportati e li metti nel JSON (ti spiego dopo se vuoi).
      </div>
    </section>
  </main>

  <!-- SHARE sopra la barra -->
  <div class="shareDock">
    <button class="shareBtn" id="shareBtn">üü¢ WhatsApp (messaggio pronto)</button>
  </div>

  <!-- BOTTOM BAR fissa -->
  <nav class="bottombar" id="bottombar">
    <button class="barBtn" id="homeBtn">Home</button>
    <button class="barBtn" id="voiceBtn">Voice</button>
    <button class="barBtn danger" id="stopBtn">Stop</button>
    <button class="barBtn" id="fullBtn">Full</button>
    <button class="barBtn" id="themeBtn">Tema</button>
    <button class="barBtn" id="kioskBtn">Kiosk</button>
  </nav>

  <!-- OVERLAY audio sblocco -->
  <div class="audioGate" id="audioGate" hidden>
    <div class="audioGateCard">
      <div class="audioGateTitle">Audio bloccato dal telefono</div>
      <div class="audioGateText">Tocca ‚ÄúAttiva audio‚Äù. Poi partir√† automaticamente.</div>
      <div class="audioGateBtns">
        <button class="primary" id="enableAudioBtn">Attiva audio</button>
        <button class="ghost" id="skipAudioBtn">Non ora</button>
      </div>
    </div>
  </div>

  <script src="app.js?v=2"></script>

  <!-- ‚úÖ EXTRA: WhatsApp + Indice vetrine (non rompe app.js) -->
  <script>
  (function(){
    "use strict";

    function getId(){
      const sp = new URLSearchParams(location.search);
      return (sp.get("id") || "").trim() || "renzo11";
    }
    const id = getId();

    const base = location.origin + location.pathname.replace(/vetrina\.html$/,"");
    const shareLink = `${base}link.html?id=${encodeURIComponent(id)}`;

    function textFromDom(el){
      return (el && el.textContent) ? el.textContent.trim() : "";
    }

    function makeWaMessage(){
      const title = textFromDom(document.getElementById("pageTitle")) || id;
      return `Ciao! üëã
Ti mando la vetrina con foto e numeri degli oggetti.

‚úÖ Apri qui:
${shareLink}

üìå Se ti interessa un oggetto, dimmi il numero e ti rispondo subito su WhatsApp.`;
    }

    // WhatsApp bottone (sopra barra)
    const shareBtn = document.getElementById("shareBtn");
    if(shareBtn){
      shareBtn.addEventListener("click", ()=>{
        const msg = makeWaMessage();
        const url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
        window.open(url, "_blank");
      });
    }

    /* ===================== INDICE ALTRE VETRINE ===================== */

    const netFilters = document.getElementById("netFilters");
    const netList = document.getElementById("netList");
    const netHint = document.getElementById("netHint");

    const DEFAULT_TAGS = ["tutte","servizi","attivit√†","abbigliamento","commercio","casa","auto","altro"];

    function normTag(t){
      return String(t||"").trim().toLowerCase();
    }

    function btn(label, active){
      const b = document.createElement("button");
      b.type = "button";
      b.textContent = label;
      b.style.border = "1px solid rgba(255,255,255,.18)";
      b.style.background = active ? "rgba(35,197,94,.22)" : "rgba(255,255,255,.08)";
      b.style.color = "rgba(255,255,255,.95)";
      b.style.borderRadius = "999px";
      b.style.padding = "10px 12px";
      b.style.fontWeight = "900";
      b.style.cursor = "pointer";
      b.style.fontSize = "12px";
      return b;
    }

    function cardLink(v){
      const wrap = document.createElement("div");
      wrap.style.border = "1px solid rgba(255,255,255,.14)";
      wrap.style.background = "rgba(0,0,0,.18)";
      wrap.style.borderRadius = "16px";
      wrap.style.padding = "12px";
      wrap.style.display = "grid";
      wrap.style.gap = "8px";

      const a = document.createElement("a");
      a.href = `vetrina.html?id=${encodeURIComponent(v.id)}`;
      a.textContent = `${v.title || v.id}`;
      a.style.color = "rgba(255,255,255,.95)";
      a.style.textDecoration = "none";
      a.style.fontWeight = "1000";

      const meta = document.createElement("div");
      meta.style.fontSize = "12px";
      meta.style.fontWeight = "900";
      meta.style.color = "rgba(234,240,255,.72)";
      meta.textContent = `id: ${v.id}${v.tag ? " ‚Ä¢ " + v.tag : ""}`;

      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.gap = "8px";
      row.style.flexWrap = "wrap";

      const openBtn = document.createElement("a");
      openBtn.href = `vetrina.html?id=${encodeURIComponent(v.id)}`;
      openBtn.textContent = "Apri";
      openBtn.style.textDecoration = "none";
      openBtn.style.border = "1px solid rgba(255,255,255,.18)";
      openBtn.style.background = "rgba(255,255,255,.08)";
      openBtn.style.color = "rgba(255,255,255,.95)";
      openBtn.style.borderRadius = "14px";
      openBtn.style.padding = "10px 12px";
      openBtn.style.fontWeight = "1000";
      openBtn.style.fontSize = "12px";

      const waBtn = document.createElement("a");
      const linkForV = `${base}link.html?id=${encodeURIComponent(v.id)}`;
      const waMsg = `Ciao! üëã\nGuarda questa vetrina:\n${linkForV}\n\nüìå Dimmi il numero dell‚Äôoggetto che ti interessa.`;
      waBtn.href = `https://wa.me/?text=${encodeURIComponent(waMsg)}`;
      waBtn.target = "_blank";
      waBtn.rel = "noopener";
      waBtn.textContent = "WhatsApp";
      waBtn.style.textDecoration = "none";
      waBtn.style.border = "1px solid rgba(37,211,102,.35)";
      waBtn.style.background = "rgba(37,211,102,.20)";
      waBtn.style.color = "rgba(255,255,255,.98)";
      waBtn.style.borderRadius = "14px";
      waBtn.style.padding = "10px 12px";
      waBtn.style.fontWeight = "1000";
      waBtn.style.fontSize = "12px";

      row.appendChild(openBtn);
      row.appendChild(waBtn);

      wrap.appendChild(a);
      wrap.appendChild(meta);
      wrap.appendChild(row);
      return wrap;
    }

    async function fetchJson(url){
      const res = await fetch(url, {cache:"no-store"});
      if(!res.ok) throw new Error("HTTP " + res.status);
      return await res.json();
    }

    // Carica index base
    async function loadIndex(){
      try{
        netHint.textContent = "Carico elenco vetrine‚Ä¶";
        const idx = await fetchJson("data/vetrine.json");
        const list = Array.isArray(idx.vetrine) ? idx.vetrine : [];

        // rimuovi questa vetrina dall‚Äôelenco
        const baseList = list
          .map(x => ({ id: String(x.id||"").trim(), title: String(x.title||"").trim() }))
          .filter(x => x.id && x.id !== id);

        // carica tags da ogni vetrina (leggero, una volta)
        const enriched = [];
        for(const v of baseList){
          try{
            const j = await fetchJson(`data/${encodeURIComponent(v.id)}.json`);
            const tags = Array.isArray(j.tags) ? j.tags.map(normTag).filter(Boolean) : [];
            const tag = tags[0] || "";
            enriched.push({ ...v, tags, tag });
          }catch(e){
            enriched.push({ ...v, tags:[], tag:"" });
          }
        }

        // crea filtri in base ai tag trovati + default
        const tagSet = new Set(DEFAULT_TAGS.map(normTag));
        enriched.forEach(v => (v.tags||[]).forEach(t => tagSet.add(normTag(t))));
        const tagsAll = Array.from(tagSet).filter(Boolean);
        // metti "tutte" per prima
        tagsAll.sort((a,b)=>{
          if(a==="tutte") return -1;
          if(b==="tutte") return 1;
          return a.localeCompare(b,"it");
        });

        let currentFilter = "tutte";

        function renderFilters(){
          netFilters.innerHTML = "";
          tagsAll.forEach(t=>{
            const b = btn(t, t===currentFilter);
            b.addEventListener("click", ()=>{
              currentFilter = t;
              renderFilters();
              renderList();
            });
            netFilters.appendChild(b);
          });
        }

        function renderList(){
          netList.innerHTML = "";
          const filtered = (currentFilter==="tutte")
            ? enriched
            : enriched.filter(v => (v.tags||[]).includes(currentFilter));

          if(!filtered.length){
            const empty = document.createElement("div");
            empty.style.opacity = ".85";
            empty.style.fontWeight = "900";
            empty.textContent = "Nessuna vetrina in questo contesto. (Aggiungi tags nelle vetrine.)";
            netList.appendChild(empty);
            netHint.textContent = `Filtro: ${currentFilter} ‚Ä¢ 0 risultati`;
            return;
          }

          // ordinamento per id
          filtered.sort((a,b)=>a.id.localeCompare(b.id,"it",{numeric:true}));

          filtered.forEach(v => netList.appendChild(cardLink(v)));
          netHint.textContent = `Filtro: ${currentFilter} ‚Ä¢ ${filtered.length} vetrine`;
        }

        renderFilters();
        renderList();
      }catch(e){
        netHint.textContent = "Errore: non riesco a leggere data/vetrine.json";
      }
    }

    loadIndex();
  })();
  </script>
</body>
</html>
